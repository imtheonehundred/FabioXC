# XC_VM ‚Äî –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–π –ø–ª–∞–Ω —Ä–µ–æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ `/src`

## –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

0. [–°—Ç—Ä–∞—Ç–µ–≥–∏—á–µ—Å–∫–∏–µ —Ü–µ–ª–∏](#0-—Å—Ç—Ä–∞—Ç–µ–≥–∏—á–µ—Å–∫–∏–µ-—Ü–µ–ª–∏)
1. [–î–∏–∞–≥–Ω–æ–∑ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è](#1-–¥–∏–∞–≥–Ω–æ–∑-—Ç–µ–∫—É—â–µ–≥–æ-—Å–æ—Å—Ç–æ—è–Ω–∏—è)
2. [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–π —Å—Ç–∏–ª—å –∏ –ø—Ä–∏–Ω—Ü–∏–ø—ã](#2-–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–π-—Å—Ç–∏–ª—å-–∏-–ø—Ä–∏–Ω—Ü–∏–ø—ã)
3. [–¶–µ–ª–µ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ `/src`](#3-—Ü–µ–ª–µ–≤–∞—è-—Å—Ç—Ä—É–∫—Ç—É—Ä–∞-src)
4. [–û–ø–∏—Å–∞–Ω–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤](#4-–æ–ø–∏—Å–∞–Ω–∏–µ-–∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤)
5. [–ö–∞—Ä—Ç–∞ –º–∏–≥—Ä–∞—Ü–∏–∏: –æ—Ç–∫—É–¥–∞ ‚Üí –∫—É–¥–∞](#5-–∫–∞—Ä—Ç–∞-–º–∏–≥—Ä–∞—Ü–∏–∏-–æ—Ç–∫—É–¥–∞--–∫—É–¥–∞)
6. [–°–∏—Å—Ç–µ–º–∞ –º–æ–¥—É–ª–µ–π](#6-—Å–∏—Å—Ç–µ–º–∞-–º–æ–¥—É–ª–µ–π)
7. [–ì—Ä–∞–Ω–∏—Ü—ã —è–¥—Ä–∞ –∏ –º–æ–¥—É–ª–µ–π](#7-–≥—Ä–∞–Ω–∏—Ü—ã-—è–¥—Ä–∞-–∏-–º–æ–¥—É–ª–µ–π)
8. [–í–∞—Ä–∏–∞–Ω—Ç—ã —Å–±–æ—Ä–∫–∏: MAIN vs LoadBalancer](#8-–≤–∞—Ä–∏–∞–Ω—Ç—ã-—Å–±–æ—Ä–∫–∏-main-vs-loadbalancer)
9. [–ü–æ—Ä—è–¥–æ–∫ –º–∏–≥—Ä–∞—Ü–∏–∏](#9-–ø–æ—Ä—è–¥–æ–∫-–º–∏–≥—Ä–∞—Ü–∏–∏)
10. [–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å](#10-—Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏-–∏-–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å)
11. [–°—Ç—Ä–∞—Ç–µ–≥–∏—è –º–∏–≥—Ä–∞—Ü–∏–∏ –ø–æ —Ä–∏—Å–∫–∞–º](#11-—Å—Ç—Ä–∞—Ç–µ–≥–∏—è-–º–∏–≥—Ä–∞—Ü–∏–∏-–ø–æ-—Ä–∏—Å–∫–∞–º)
12. [–ü—Ä–∞–≤–∏–ª–∞ –¥–ª—è –∫–æ–Ω—Ç—Ä–∏–±—å—é—Ç–æ—Ä–æ–≤](#12-–ø—Ä–∞–≤–∏–ª–∞-–¥–ª—è-–∫–æ–Ω—Ç—Ä–∏–±—å—é—Ç–æ—Ä–æ–≤)

---

## 0. –°—Ç—Ä–∞—Ç–µ–≥–∏—á–µ—Å–∫–∏–µ —Ü–µ–ª–∏

### 0.1. –ó–∞—á–µ–º —ç—Ç–æ –≤—Å—ë

| # | –¶–µ–ª—å | –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç | –ú–µ—Ç—Ä–∏–∫–∞ —É—Å–ø–µ—Ö–∞ |
|---|------|-----------|----------------|
| 1 | **–ö–æ–Ω—Ç—Ä–∏–±—å—é—Ç–æ—Ä—Å–∫–∞—è –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å** | üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π | PHP-—Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ —Å—Ä–µ–¥–Ω–µ–≥–æ —É—Ä–æ–≤–Ω—è –¥–µ–ª–∞–µ—Ç –ø–µ—Ä–≤—ã–π PR –∑–∞ 2 —á–∞—Å–∞, –Ω–µ –∑–Ω–∞—è DDD |
| 2 | **–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º–æ—Å—Ç—å** | üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π | –¢–∏–ø–∏—á–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ (–¥–æ–±–∞–≤–∏—Ç—å –ø–æ—Ç–æ–∫, –∏–∑–º–µ–Ω–∏—Ç—å –ª–∏–º–∏—Ç—ã) < 1 —á–∞—Å –±–µ–∑ —Ä–∏—Å–∫–∞ —Å–∞–π–¥-—ç—Ñ—Ñ–µ–∫—Ç–æ–≤ |
| 3 | **–ò–∑–æ–ª—è—Ü–∏—è –æ—Ç–∫–∞–∑–æ–≤** | üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π | –ë–∞–≥ –≤ admin-–ø–∞–Ω–µ–ª–∏ –Ω–µ –ª–æ–º–∞–µ—Ç —Å—Ç—Ä–∏–º–∏–Ω–≥. –ë–∞–≥ –≤ –º–æ–¥—É–ª–µ –Ω–µ –ª–æ–º–∞–µ—Ç —è–¥—Ä–æ |
| 4 | **Multi-node** | üü° –í–∞–∂–Ω—ã–π | LB-—Å–µ—Ä–≤–µ—Ä —Å–æ–±–∏—Ä–∞–µ—Ç—Å—è –∏–∑ –ø–æ–¥–º–Ω–æ–∂–µ—Å—Ç–≤–∞ koda. Streaming-–ø—É—Ç—å –Ω–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç admin-–ª–æ–≥–∏–∫—É |
| 5 | **Open-core –∫–æ–º–º–µ—Ä—Ü–∏—è** | üü° –í–∞–∂–Ω—ã–π | –ö–æ–º–º–µ—Ä—á–µ—Å–∫–∏–µ –º–æ–¥—É–ª–∏ –ø–æ–¥–∫–ª—é—á–∞—é—Ç—Å—è –±–µ–∑ –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏–∏ —è–¥—Ä–∞. –£–¥–∞–ª–µ–Ω–∏–µ –º–æ–¥—É–ª—è –Ω–µ –ª–æ–º–∞–µ—Ç —Å–∏—Å—Ç–µ–º—É |
| 6 | **–¢–µ—Å—Ç–∏—Ä—É–µ–º–æ—Å—Ç—å** | üü¢ –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–π | –õ—é–±–æ–π —Å–µ—Ä–≤–∏—Å –º–æ–∂–Ω–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å, –ø–æ–¥—Å—Ç–∞–≤–∏–≤ mock –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ |

### 0.2. –ß–µ–º —ç—Ç–æ –ù–ï —è–≤–ª—è–µ—Ç—Å—è

- **–ù–µ –ø–µ—Ä–µ–ø–∏—Å—ã–≤–∞–Ω–∏–µ —Å –Ω—É–ª—è.** –ò—Ç–µ—Ä–∞—Ç–∏–≤–Ω—ã–π —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥. –ö–∞–∂–¥—ã–π —à–∞–≥ –æ–±—Ä–∞—Ç–∏–º–æ —Å–æ–≤–º–µ—Å—Ç–∏–º.
- **–ù–µ DDD.** –ù–µ—Ç Event Sourcing, CQRS, Aggregate Root, Domain Events. –ü—Ä–æ—Å—Ç–æ–π –ø–∞—Ç—Ç–µ—Ä–Ω: Controller ‚Üí Service ‚Üí Repository.
- **–ù–µ –∞–∫–∞–¥–µ–º–∏—á–µ—Å–∫–∏–π –ø—Ä–æ–µ–∫—Ç.** –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ –ø–æ–¥ –ø–æ–Ω—è—Ç–Ω–æ—Å—Ç—å –∏ –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ—Å—Ç—å, –∞ –Ω–µ –ø–æ–¥ —Ç–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫—É—é —á–∏—Å—Ç–æ—Ç—É.

### 0.3. –ü—Ä–∏–Ω—Ü–∏–ø –ø—Ä–∏–Ω—è—Ç–∏—è —Ä–µ—à–µ–Ω–∏–π

–ö–∞–∂–¥–æ–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ –ø—Ä–æ—Ö–æ–¥–∏—Ç —Ç—Ä–∏ —Ñ–∏–ª—å—Ç—Ä–∞:

1. **–ö–æ–Ω—Ç—Ä–∏–±—å—é—Ç–æ—Ä –ø–æ–π–º—ë—Ç –∑–∞ 5 –º–∏–Ω—É—Ç?** ‚Üí –µ—Å–ª–∏ –Ω–µ—Ç ‚Äî —É–ø—Ä–æ—Å—Ç–∏—Ç—å
2. **–ù–µ –ª–æ–º–∞–µ—Ç streaming hot path?** ‚Üí –µ—Å–ª–∏ –ª–æ–º–∞–µ—Ç ‚Äî –æ—Ç–∫–ª–æ–Ω–∏—Ç—å
3. **–ú–æ–∂–Ω–æ –∏–∑–æ–ª–∏—Ä–æ–≤–∞—Ç—å –≤ –º–æ–¥—É–ª—å?** ‚Üí –µ—Å–ª–∏ –Ω–µ—Ç ‚Äî –æ–±–æ—Å–Ω–æ–≤–∞—Ç—å

–ï—Å–ª–∏ —Ä–µ—à–µ–Ω–∏–µ —É–ª—É—á—à–∞–µ—Ç ¬´–∫—Ä–∞—Å–æ—Ç—É –∫–æ–¥–∞¬ª, –Ω–æ –ø–æ–≤—ã—à–∞–µ—Ç –±–∞—Ä—å–µ—Ä –≤—Ö–æ–¥–∞ ‚Äî **–æ—Ç–∫–ª–æ–Ω–∏—Ç—å**.

---

## 1. –î–∏–∞–≥–Ω–æ–∑ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è

### –ú–∞—Å—à—Ç–∞–±: 382 PHP-—Ñ–∞–π–ª–∞, ~199 000 —Å—Ç—Ä–æ–∫

### –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

| # | –ü—Ä–æ–±–ª–µ–º–∞ | –ì–¥–µ –ø—Ä–æ—è–≤–ª—è–µ—Ç—Å—è | –í–ª–∏—è–Ω–∏–µ |
|---|----------|-----------------|---------|
| 1 | **God-–æ–±—ä–µ–∫—Ç—ã** | `CoreUtilities` (4847 —Å—Ç—Ä.), `admin_api.php` (6981 —Å—Ç—Ä.), `admin.php` (4448 —Å—Ç—Ä.) | –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å –æ–¥–Ω—É –ø–æ–¥—Å–∏—Å—Ç–µ–º—É –±–µ–∑ —Ä–∏—Å–∫–∞ —Å–ª–æ–º–∞—Ç—å –¥—Ä—É–≥—É—é |
| 2 | **–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ bootstrap** | `www/constants.php` vs `www/stream/init.php` ‚Äî –æ–¥–Ω–∏ –∏ —Ç–µ –∂–µ ~70 `define()`, —Ñ—É–Ω–∫—Ü–∏–∏ –æ—à–∏–±–æ–∫, flood-check | –ö–∞–∂–¥–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –Ω—É–∂–Ω–æ –¥–µ–ª–∞—Ç—å –≤ –¥–≤—É—Ö –º–µ—Å—Ç–∞—Ö |
| 3 | **Fork-–¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ** | `CoreUtilities` vs `StreamingUtilities` ‚Äî –∏–¥–µ–Ω—Ç–∏—á–Ω—ã–µ —Å–≤–æ–π—Å—Ç–≤–∞, `init()`, `cleanGlobals()` | –ë–∞–≥–∏ –∏—Å–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –≤ –æ–¥–Ω–æ–º –∫–ª–∞—Å—Å–µ –∏ –æ—Å—Ç–∞—é—Ç—Å—è –≤ –¥—Ä—É–≥–æ–º |
| 4 | **–ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∫–∞–∫ —à–∏–Ω–∞ –¥–∞–Ω–Ω—ã—Ö** | `global $db`, `$rSettings`, `$rServers`, `$rUserInfo` –≤ –∫–∞–∂–¥–æ–º —Ñ–∞–π–ª–µ | –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å, –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ –∏–∑–æ–ª–∏—Ä–æ–≤–∞—Ç—å |
| 5 | **SQL –≤ presentation-—Å–ª–æ–µ** | –ö–∞–∂–¥–∞—è admin-—Å—Ç—Ä–∞–Ω–∏—Ü–∞ –¥–µ–ª–∞–µ—Ç `$db->query()` –ø—Ä—è–º–æ –≤ HTML | –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –Ω–µ—Ä–∞–∑–¥–µ–ª–∏–º–∞ –æ—Ç –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è |
| 6 | **–û–¥–∏–Ω include = –ø–æ–±–æ—á–Ω—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã** | `require admin.php` –∑–∞–ø—É—Å–∫–∞–µ—Ç —Å–µ—Å—Å–∏—é, —Å–æ–∑–¥–∞—ë—Ç –ë–î, init 3 –∫–ª–∞—Å—Å–æ–≤, –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç 50 –∫–æ–Ω—Å—Ç–∞–Ω—Ç | –ù–µ—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –ø–æ–¥–∫–ª—é—á–∏—Ç—å —á–∞—Å—Ç—å —Å–∏—Å—Ç–µ–º—ã –±–µ–∑ –≤—Å–µ–π |
| 7 | **Admin = Reseller copy-paste** | `reseller/` ‚Äî —É–ø—Ä–æ—â—ë–Ω–Ω—ã–π –∫–ª–æ–Ω `admin/` —Å —Ç–µ–º –∂–µ header/footer/session | –ü—Ä–∞–≤–∫–∏ –≤ –æ–¥–Ω–æ–º –Ω–µ –ø–æ–ø–∞–¥–∞—é—Ç –≤ –¥—Ä—É–≥–æ–π |
| 8 | **Goto-–ª–µ–π–±–ª—ã** | `includes/cli/monitor.php` —Å–æ–¥–µ—Ä–∂–∏—Ç `goto label235`, `label592` | –°–ª–µ–¥—ã –æ–±—Ñ—É—Å–∫–∞—Ü–∏–∏, –Ω–µ—á–∏—Ç–∞–µ–º—ã–π control flow |
| 9 | **Inline data** | –ú–∞—Å—Å–∏–≤—ã —Å—Ç—Ä–∞–Ω/MAC-—Ç–∏–ø–æ–≤/—Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π –ø–æ 150+ —Å—Ç—Ä–æ–∫ –ø—Ä—è–º–æ –≤ `admin.php` | –î–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–ø–ª–µ—Ç–µ–Ω—ã —Å –ª–æ–≥–∏–∫–æ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ |
| 10 | **God-cron** | `crons/servers.php` ‚Äî –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥, –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ –¥–µ–º–æ–Ω–æ–≤, —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞, –æ—á–∏—Å—Ç–∫–∞ | –†–∞–∑–Ω—ã–µ –ø–æ —á–∞—Å—Ç–æ—Ç–µ –∏ –ø—Ä–∏—Ä–æ–¥–µ –∑–∞–¥–∞—á–∏ –≤ –æ–¥–Ω–æ–º —Ñ–∞–π–ª–µ |

### –ì—Ä–∞—Ñ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π (—Ç–µ–∫—É—â–∏–π)

```
admin/*.php ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
reseller/*.php ‚îÄ‚îÄ‚îÄ‚î§
crons/*.php ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§‚îÄ‚îÄ‚Üí includes/admin.php ‚îÄ‚îÄ‚Üí CoreUtilities (4847)
includes/api/ ‚îÄ‚îÄ‚îÄ‚îÄ‚îò         ‚îÇ                     ‚îú‚îÄ‚îÄ Database
                            ‚îÇ                     ‚îú‚îÄ‚îÄ Redis
                            ‚îú‚îÄ‚îÄ‚Üí admin_api.php (6981)
                            ‚îú‚îÄ‚îÄ‚Üí reseller_api.php (1204)
                            ‚îî‚îÄ‚îÄ‚Üí constants.php (~70 define())

www/stream/*.php ‚îÄ‚îÄ‚Üí www/stream/init.php ‚îÄ‚îÄ‚Üí StreamingUtilities (1992)
                          ‚îÇ                     ‚îú‚îÄ‚îÄ Database (—Ç–æ—Ç –∂–µ)
                          ‚îÇ                     ‚îî‚îÄ‚îÄ Redis (—Ç–æ—Ç –∂–µ)
                          ‚îî‚îÄ‚îÄ constants (–î–£–ë–õ–ò–ö–ê–¢)
```

**–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è —Ç–æ—á–∫–∞ –æ—Ç–∫–∞–∑–∞: `includes/admin.php`** ‚Äî –∫–∞–∂–¥—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è (admin, reseller, crons, API) –ø—Ä–æ—Ö–æ–¥–∏—Ç —á–µ—Ä–µ–∑ —ç—Ç–æ—Ç –æ–¥–∏–Ω —Ñ–∞–π–ª 4448 —Å—Ç—Ä–æ–∫.

---

## 2. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–π —Å—Ç–∏–ª—å –∏ –ø—Ä–∏–Ω—Ü–∏–ø—ã

### 2.0. –§–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ–≥–æ —Å—Ç–∏–ª—è

**–≠—Ç–æ: —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –º–æ–Ω–æ–ª–∏—Ç —Å –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ–π –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–µ–π –ø–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç—É.**

–ù–µ DDD. –ù–µ Hexagonal. –ù–µ Clean Architecture. –ù–µ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å—ã.
–ü—Ä–æ—Å—Ç–æ–π PHP-–º–æ–Ω–æ–ª–∏—Ç, —Ä–∞–∑–ª–æ–∂–µ–Ω–Ω—ã–π –ø–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞–º —Å –º–∏–Ω–∏–º—É–º–æ–º –∞–±—Å—Ç—Ä–∞–∫—Ü–∏–π.

#### –ü–∞—Ç—Ç–µ—Ä–Ω: Controller ‚Üí Service ‚Üí Repository

–ö–∞–∂–¥—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç (Streams, VOD, Lines, Users...) –≤–Ω—É—Ç—Ä–∏ —É—Å—Ç—Ä–æ–µ–Ω –æ–¥–∏–Ω–∞–∫–æ–≤–æ:

```
domain/Stream/
  ‚îú‚îÄ‚îÄ StreamService.php       # –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ + –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏—è
  ‚îú‚îÄ‚îÄ StreamRepository.php    # SQL-–∑–∞–ø—Ä–æ—Å—ã (SELECT/INSERT/UPDATE/DELETE)
  ‚îî‚îÄ‚îÄ StreamProcess.php       # –°–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ (ffmpeg, kill)

interfaces/Http/Controllers/Admin/
  ‚îî‚îÄ‚îÄ StreamController.php    # –ü—Ä–∏–Ω—è—Ç—å –∑–∞–ø—Ä–æ—Å ‚Üí –≤—ã–∑–≤–∞—Ç—å Service ‚Üí –æ—Ç–¥–∞—Ç—å –æ—Ç–≤–µ—Ç
```

–í–æ—Ç –∏ –≤—Å—ë. –¢—Ä–∏ —Ñ–∞–π–ª–∞ –Ω–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç. –ö–æ–Ω—Ç—Ä–∏–±—å—é—Ç–æ—Ä –≤–∏–¥–∏—Ç `/Stream/` ‚Äî –∏ –∑–Ω–∞–µ—Ç –≥–¥–µ –º–µ–Ω—è—Ç—å.

#### –ü—Ä–∞–≤–∏–ª–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π (–ø—Ä–æ—Å—Ç–æ)

```
Controller  ‚Üí  Service  ‚Üí  Repository  ‚Üí  Database
                  ‚Üì
          Infrastructure (nginx, redis, ffmpeg)
```

| –°–ª–æ–π | –ú–æ–∂–Ω–æ –∑–∞–≤–∏—Å–µ—Ç—å –æ—Ç | –ù–ï–õ–¨–ó–Ø –∑–∞–≤–∏—Å–µ—Ç—å –æ—Ç |
|------|-------------------|--------------------|
| `interfaces/` | `domain/` (Service + Repository), `core/` | `streaming/`, `modules/` –Ω–∞–ø—Ä—è–º—É—é |
| `domain/` | `core/` (Database, Cache, Events) | `interfaces/`, `streaming/`, `modules/`, `infrastructure/` |
| `core/` | –¢–æ–ª—å–∫–æ –¥—Ä—É–≥–∏–µ `core/` –ø–æ–¥–∫–∞—Ç–∞–ª–æ–≥–∏ | –í—Å—ë –æ—Å—Ç–∞–ª—å–Ω–æ–µ |
| `streaming/` | `core/` (subset), `domain/` (read-only queries) | `interfaces/`, `modules/` |
| `modules/` | `domain/` (Service, Repository), `core/` | –î—Ä—É–≥–∏–µ –º–æ–¥—É–ª–∏ (–±–µ–∑ —è–≤–Ω–æ–π –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏), `interfaces/`, `streaming/` |

### 2.1. –ò–Ω–≤–µ—Ä—Å–∏—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

–ö–æ–¥ –≤–µ—Ä—Ö–Ω–µ–≥–æ —É—Ä–æ–≤–Ω—è (UI, CLI, HTTP endpoints) –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –∞–±—Å—Ç—Ä–∞–∫—Ü–∏–π —è–¥—Ä–∞, –∞ –Ω–µ –æ—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–π. –Ø–¥—Ä–æ –Ω–µ –∑–Ω–∞–µ—Ç –æ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–∏ –º–æ–¥—É–ª–µ–π.

### 2.2. –ï–¥–∏–Ω–∞—è —Ç–æ—á–∫–∞ bootstrap ‚Äî –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç—ã

–í–º–µ—Å—Ç–æ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö `init.php` / `constants.php` / `stream/init.php` ‚Äî –æ–¥–∏–Ω bootstrap —Å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä—É–µ–º—ã–º –Ω–∞–±–æ—Ä–æ–º –∑–∞–≥—Ä—É–∂–∞–µ–º—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤.

### 2.3. Strict Constructor Injection ‚Äî –∑–∞–ø—Ä–µ—Ç Service Locator

**–ü—Ä–∞–≤–∏–ª–æ:** `ServiceContainer` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è **–¢–û–õ–¨–ö–û** –Ω–∞ —ç—Ç–∞–ø–µ bootstrap (composition root).
–ü–æ—Å–ª–µ bootstrap –≤—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è **—á–µ—Ä–µ–∑ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä**. –ù–∏ –æ–¥–∏–Ω —Å–µ—Ä–≤–∏—Å –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç `$container->get()` –≤–Ω—É—Ç—Ä–∏ —Å–≤–æ–∏—Ö –º–µ—Ç–æ–¥–æ–≤.

```php
// ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û ‚Äî constructor injection:
class StreamService {
    public function __construct(
        private StreamRepository $repository,
        private EventDispatcher $events,
        private FileLogger $logger
    ) {}
    
    public function create(array $data): int {
        // –ò—Å–ø–æ–ª—å–∑—É–µ—Ç $this->repository, $this->events, $this->logger
        // –ù–ï –≤—ã–∑—ã–≤–∞–µ—Ç ServiceContainer
    }
}

// ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û ‚Äî composition root (bootstrap.php):
$container->register('stream.service', function($c) {
    return new StreamService(
        $c->get('stream.repository'),
        $c->get('event.dispatcher'),
        $c->get('logger.file')
    );
});

// ‚ùå –ó–ê–ü–†–ï–©–ï–ù–û ‚Äî Service Locator –≤–Ω—É—Ç—Ä–∏ —Å–µ—Ä–≤–∏—Å–∞:
class StreamService {
    public function create(array $data): int {
        $db = ServiceContainer::getInstance()->get('db');  // ‚Üê –ê–ù–¢–ò–ü–ê–¢–¢–ï–†–ù
        $logger = ServiceContainer::getInstance()->get('logger');  // ‚Üê –ê–ù–¢–ò–ü–ê–¢–¢–ï–†–ù
    }
}
```

**–ò—Å–∫–ª—é—á–µ–Ω–∏—è (–≤—Ä–µ–º–µ–Ω–Ω—ã–µ, —Ñ–∞–∑–∞ –º–∏–≥—Ä–∞—Ü–∏–∏):**
- Legacy-–∫–æ–¥ –≤ `includes/` –º–æ–∂–µ—Ç –æ–±—Ä–∞—â–∞—Ç—å—Å—è –∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—É –Ω–∞–ø—Ä—è–º—É—é —á–µ—Ä–µ–∑ proxy-–º–µ—Ç–æ–¥—ã
- –ö–∞–∂–¥–æ–µ —Ç–∞–∫–æ–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ –ø–æ–º–µ—á–∞–µ—Ç—Å—è `// @legacy-container ‚Äî —É–±—Ä–∞—Ç—å –≤ –§–∞–∑–µ 8`
- –í –§–∞–∑–µ 8 –≤—Å–µ legacy-–æ–±—Ä–∞—â–µ–Ω–∏—è –∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—É –∑–∞–º–µ–Ω—è—é—Ç—Å—è –Ω–∞ constructor injection

### 2.4. –ö–æ–Ω—Å–æ–ª–∏–¥–∞—Ü–∏—è –º–µ–ª–∫–∏—Ö –∫–ª–∞—Å—Å–æ–≤ ‚Äî –∑–∞–ø—Ä–µ—Ç ¬´–æ–¥–∏–Ω –∫–ª–∞—Å—Å = –æ–¥–∏–Ω —Ñ–∞–π–ª¬ª –≤—Å–ª–µ–ø—É—é

**–ü—Ä–∞–≤–∏–ª–æ:** –ù–µ —Å–æ–∑–¥–∞–≤–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–π —Ñ–∞–π–ª/–∫–ª–∞—Å—Å, –µ—Å–ª–∏ –≤ –Ω—ë–º < 150 —Å—Ç—Ä–æ–∫ **–∏** < 5 –ø—É–±–ª–∏—á–Ω—ã—Ö –º–µ—Ç–æ–¥–æ–≤. –ú–∞–ª–µ–Ω—å–∫–∏–µ –∫–ª–∞—Å—Å—ã –∂–∏–≤—É—Ç –≤ –æ–¥–Ω–æ–º —Ñ–∞–π–ª–µ —Å —Ä–æ–¥—Å—Ç–≤–µ–Ω–Ω—ã–º –∫–ª–∞—Å—Å–æ–º.

**–ó–∞—á–µ–º:** –ò–∑–±–µ–∂–∞—Ç—å –≤–∑—Ä—ã–≤–∞ —Ñ–∞–π–ª–æ–≤ —Å –∫–ª–∞—Å—Å–∞–º–∏ –ø–æ 1-2 —Ñ—É–Ω–∫—Ü–∏–∏. 44 —Ñ–∞–π–ª–∞ –ø–æ 40 —Å—Ç—Ä–æ–∫ ‚Äî —Ö—É–∂–µ –æ–¥–Ω–æ–≥–æ –±–æ–≥–∞ –Ω–∞ 4000, –Ω–æ –Ω–µ –Ω–∞–º–Ω–æ–≥–æ –ª—É—á—à–µ –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏.

**–ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞:**

| –°–∏—Ç—É–∞—Ü–∏—è | –ß—Ç–æ –¥–µ–ª–∞—Ç—å | –ü—Ä–∏–º–µ—Ä |
|----------|-----------|--------|
| Repository < 5 –º–µ—Ç–æ–¥–æ–≤ | –û–±—ä–µ–¥–∏–Ω–∏—Ç—å Service + Repository –≤ –æ–¥–∏–Ω —Ñ–∞–π–ª | `EpgService.php` —Å–æ–¥–µ—Ä–∂–∏—Ç –∏ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É, –∏ SQL |
| –ö–æ–Ω—Ç–µ–∫—Å—Ç = 1 Service —Å 1-2 –º–µ—Ç–æ–¥–∞–º–∏ | –í–ª–∏—Ç—å –≤ –±–ª–∏–∂–∞–π—à–∏–π —Ä–æ–¥—Å—Ç–≤–µ–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç | `TicketService::submit()` ‚Üí `UserService::submitTicket()` |
| –û—Ç–¥–µ–ª—å–Ω—ã–π ¬´Validator¬ª —Å 1 –º–µ—Ç–æ–¥–æ–º | –°–¥–µ–ª–∞—Ç—å private-–º–µ—Ç–æ–¥–æ–º –≤ Service | `HMACValidator::validate()` ‚Üí `HMACService::validate()` |
| –û—Ç–¥–µ–ª—å–Ω—ã–π ¬´Sync¬ª —Å 1 –º–µ—Ç–æ–¥–æ–º | –í–ª–∏—Ç—å –≤ Service —Ç–æ–≥–æ –∂–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ | `DeviceSync::sync()` ‚Üí `MagService::syncLineDevices()` |
| Service + Repository > 300 —Å—Ç—Ä–æ–∫ —Å—É–º–º–∞—Ä–Ω–æ | –†–∞–∑–¥–µ–ª–∏—Ç—å –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã | `StreamService` (700 —Å—Ç—Ä.) + `StreamRepository` (400 —Å—Ç—Ä.) = —Ä–∞–∑–¥–µ–ª—å–Ω–æ |

**–ö–æ–≥–¥–∞ –ú–û–ñ–ù–û —Å–æ–∑–¥–∞–≤–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–π —Ñ–∞–π–ª:**
- –ö–ª–∞—Å—Å > 150 —Å—Ç—Ä–æ–∫
- –ö–ª–∞—Å—Å –∏–º–µ–µ—Ç ‚â• 5 –ø—É–±–ª–∏—á–Ω—ã—Ö –º–µ—Ç–æ–¥–æ–≤
- –ö–ª–∞—Å—Å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∏–∑ 3+ —Ä–∞–∑–Ω—ã—Ö –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä `ConnectionTracker`)
- –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è DI (`CacheInterface`, `LoggerInterface`)

```php
// ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û ‚Äî –º–∞–ª–µ–Ω—å–∫–∏–µ Service+Repository –≤ –æ–¥–Ω–æ–º —Ñ–∞–π–ª–µ:
// domain/Epg/EpgService.php
class EpgRepository {
    public function __construct(private Database $db) {}
    public function findById(int $id): ?array { ... }
    public function getStreamEpg(int $streamId): array { ... }
}

class EpgService {
    public function __construct(private EpgRepository $repo) {}
    public function process(array $data): int { ... }
    public function getChannelEpg(int $channelId): array { ... }
}

// ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û ‚Äî –¥–≤–∞ —Ñ–∞–π–ª–∞ –ø–æ 40 —Å—Ç—Ä–æ–∫:
// domain/Epg/EpgRepository.php  (40 —Å—Ç—Ä–æ–∫, 3 –º–µ—Ç–æ–¥–∞)
// domain/Epg/EpgService.php     (50 —Å—Ç—Ä–æ–∫, 2 –º–µ—Ç–æ–¥–∞)
```

### 2.5. –ì—Ä–∞–Ω–∏—Ü—ã —á–µ—Ä–µ–∑ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã, –∞ –Ω–µ —á–µ—Ä–µ–∑ `global`

–ö–∞–∂–¥—ã–π —Å–µ—Ä–≤–∏—Å –ø–æ–ª—É—á–∞–µ—Ç –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —á–µ—Ä–µ–∑ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä. –ù–∏ –æ–¥–∏–Ω –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `global`.

### 2.6. –ú–æ–¥—É–ª—å = –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è

–ú–æ–¥—É–ª—å ‚Äî —ç—Ç–æ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è —Å –∏–∑–≤–µ—Å—Ç–Ω—ã–º –∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–º. –ï–≥–æ –º–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å, –∏ —Å–∏—Å—Ç–µ–º–∞ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç —Ä–∞–±–æ—Ç–∞—Ç—å (–¥–µ–≥—Ä–∞–¥–∏—Ä—É—è –≤ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏, –Ω–æ –Ω–µ –ø–∞–¥–∞—è).

### 2.7. Open-core –±–µ–∑ –ª–∏—Ü–µ–Ω–∑–∏–æ–Ω–Ω—ã—Ö –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π –≤ —è–¥—Ä–µ

–Ø–¥—Ä–æ (`core/`) –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–≤–æ–±–æ–¥–Ω–æ. –ú–æ–¥—É–ª–∏ (`modules/`) –º–æ–≥—É—Ç –±—ã—Ç—å –∫–∞–∫ open-source, —Ç–∞–∫ –∏ –∫–æ–º–º–µ—Ä—á–µ—Å–∫–∏–º–∏. –Ø–¥—Ä–æ –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –ø—Ä–æ–≤–µ—Ä–æ–∫ –ª–∏—Ü–µ–Ω–∑–∏–π, —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è, –∏–ª–∏ —Å–∫—Ä—ã—Ç—ã—Ö –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π. –õ–∏—Ü–µ–Ω–∑–∏—Ä–æ–≤–∞–Ω–∏–µ ‚Äî —ç—Ç–æ –∑–∞–¥–∞—á–∞ –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ –º–æ–¥—É–ª—è —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π.

---

## 3. –¶–µ–ª–µ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ `/src`

```
src/
‚îú‚îÄ‚îÄ bootstrap.php                    # –ï–¥–∏–Ω—ã–π bootstrap: require_once –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è, DI container, config
‚îú‚îÄ‚îÄ constants.php                    # –í—Å–µ path/version/status –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã (–æ–¥–∏–Ω —Ñ–∞–π–ª)
‚îÇ
‚îú‚îÄ‚îÄ core/                            # ‚ïê‚ïê‚ïê –Ø–î–†–û (—Å—Ç–∞–±–∏–ª—å–Ω—ã–π, —Å–≤–æ–±–æ–¥–Ω—ã–π, –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π) ‚ïê‚ïê‚ïê
‚îÇ   ‚îú‚îÄ‚îÄ Config/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ConfigLoader.php         # .ini ‚Üí –º–∞—Å—Å–∏–≤, –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ, env-override
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ PathResolver.php         # –í—Å–µ –ø—É—Ç–∏ —Å–∏—Å—Ç–µ–º—ã (–∑–∞–º–µ–Ω—è–µ—Ç 70 define())
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ Database/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Database.php              # –ë–∞–∑–æ–≤–∞—è PDO-–æ–±—ë—Ä—Ç–∫–∞ (–ø–µ—Ä–µ–º–µ—â—ë–Ω –∏–∑ includes/)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ DatabaseHandler.php      # –ú–µ–Ω–µ–¥–∂–µ—Ä –ë–î ‚Äî —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –æ–±—ë—Ä—Ç–∫–∞ —Å reconnect, bulk ops
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ QueryBuilder.php         # –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –∑–∞–ø—Ä–æ—Å–æ–≤ –≤–º–µ—Å—Ç–æ raw SQL –≤ UI
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ Migration.php            # –ú–∏–≥—Ä–∞—Ü–∏–∏ (–∏–∑–≤–ª–µ—á–µ–Ω–æ –∏–∑ `status`)
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ Cache/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ CacheInterface.php       # –ö–æ–Ω—Ç—Ä–∞–∫—Ç –¥–ª—è –ª—é–±–æ–≥–æ –∫—ç—à-–¥—Ä–∞–π–≤–µ—Ä–∞
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ FileCache.php            # –¢–µ–∫—É—â–∏–π igbinary file cache
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ RedisCache.php           # Redis-–æ–±—ë—Ä—Ç–∫–∞
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ Auth/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ SessionManager.php       # –ï–¥–∏–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä —Å–µ—Å—Å–∏–π (admin + reseller)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Authenticator.php        # –õ–æ–≥–∏–Ω/–ø–∞—Ä–æ–ª—å/api_key
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ Authorization.php        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ ($rPermissions ‚Üí RBAC)
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ Http/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Request.php              # –û–±—ë—Ä—Ç–∫–∞ –Ω–∞–¥ $_GET/$_POST (–∑–∞–º–µ–Ω—è–µ—Ç cleanGlobals)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Response.php             # JSON/HTML –æ—Ç–≤–µ—Ç
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Router.php               # –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è –≤–º–µ—Å—Ç–æ switch($rAction)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ Middleware/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ FloodProtection.php  # Rate limiting (–∏–∑–≤–ª–µ—á–µ–Ω–æ –∏–∑ constants.php)
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ IpWhitelist.php      # IP-—Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ CorsMiddleware.php
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ Process/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ProcessManager.php       # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–∞–º–∏ (kill, ps, isRunning)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ DaemonRunner.php         # –ó–∞–ø—É—Å–∫ PHP-–¥–µ–º–æ–Ω–æ–≤ —Å PID-—Ñ–∞–π–ª–∞–º–∏
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ CronLock.php             # –§–∞–π–ª–æ–≤—ã–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –∫—Ä–æ–Ω–æ–≤ (checkCron)
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ Logging/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ LoggerInterface.php       # –ö–æ–Ω—Ç—Ä–∞–∫—Ç
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ FileLogger.php           # –§–∞–π–ª–æ–≤–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ DatabaseLogger.php       # panel_logs / login_logs / activity
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ Events/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ EventDispatcher.php      # –ü—Ä–æ—Å—Ç–æ–π event bus
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ EventInterface.php       # –ö–æ–Ω—Ç—Ä–∞–∫—Ç —Å–æ–±—ã—Ç–∏—è
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ Container/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ServiceContainer.php     # –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π DI-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
‚îÇ   ‚îÇ
‚îÇ   ‚îî‚îÄ‚îÄ Util/
‚îÇ       ‚îú‚îÄ‚îÄ GeoIP.php                # –ò–∑–≤–ª–µ—á–µ–Ω–æ –∏–∑ CoreUtilities
‚îÇ       ‚îú‚îÄ‚îÄ NetworkUtils.php         # IP-–æ–ø–µ—Ä–∞—Ü–∏–∏, CIDR, subnet matching
‚îÇ       ‚îú‚îÄ‚îÄ TimeUtils.php            # secondsToTime(), timezone helper
‚îÇ       ‚îú‚îÄ‚îÄ Encryption.php           # AES, token generation
‚îÇ       ‚îî‚îÄ‚îÄ ImageUtils.php           # Resize, thumbnail, upload
‚îÇ
‚îú‚îÄ‚îÄ domain/                          # ‚ïê‚ïê‚ïê –ë–ò–ó–ù–ï–°-–õ–û–ì–ò–ö–ê (—Å–µ—Ä–≤–∏—Å—ã –∏ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏) ‚ïê‚ïê‚ïê
‚îÇ   ‚îú‚îÄ‚îÄ Stream/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ StreamService.php        # –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ + –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏—è
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ StreamRepository.php    # SQL-–∑–∞–ø—Ä–æ—Å—ã (–∏–∑ admin_api.php)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ChannelService.php       # –ö–∞–Ω–∞–ª—ã: create, massEdit, order
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ CategoryService.php      # –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ + CategoryRepository (< 150 —Å—Ç—Ä. = –æ–¥–∏–Ω —Ñ–∞–π–ª)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ StreamProcess.php       # FFmpeg, kill, restart
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ StreamMonitor.php        # –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–æ—Ç–æ–∫–∞ (–∏–∑ cli/monitor.php)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ConnectionTracker.php    # Redis: –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è, heartbeat
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ StreamSorter.php         # –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ PlaylistGenerator.php    # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è M3U/EPG –ø–ª–µ–π–ª–∏—Å—Ç–æ–≤
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ CronGenerator.php        # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫—Ä–æ–Ω–æ–≤
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ M3UParser.php            # –ü–∞—Ä—Å–∏–Ω–≥ M3U
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ Vod/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ MovieService.php         # + MovieRepository (< 300 —Å—Ç—Ä. —Å—É–º–º–∞—Ä–Ω–æ = –æ–¥–∏–Ω —Ñ–∞–π–ª)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ SeriesService.php        # + SeriesRepository (< 300 —Å—Ç—Ä. —Å—É–º–º–∞—Ä–Ω–æ = –æ–¥–∏–Ω —Ñ–∞–π–ª)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ EpisodeService.php       # process, massEdit, massDelete
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ Line/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ LineService.php          # + LineRepository (—Ä–∞–∑–¥–µ–ª—å–Ω–æ ‚Äî > 300 —Å—Ç—Ä. —Å—É–º–º–∞—Ä–Ω–æ)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ LineRepository.php
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ PackageService.php       # + PackageRepository (–æ–¥–∏–Ω —Ñ–∞–π–ª, < 150 —Å—Ç—Ä.)
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ Device/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ MagService.php           # + DeviceSync::syncLineDevices (–≤–ª–∏—Ç–æ)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ EnigmaService.php
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ User/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ UserService.php          # + ProfileService::editAdminProfile (–≤–ª–∏—Ç–æ)
‚îÇ   ‚îÇ   ‚îÇ                            # + TicketService::submit (–≤–ª–∏—Ç–æ)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ UserRepository.php       # getUserInfo, getUser, getRegisteredUsers...
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ GroupService.php         # + GroupRepository (–æ–¥–∏–Ω —Ñ–∞–π–ª, < 150 —Å—Ç—Ä.)
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ Server/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ServerRepository.php
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ServerService.php        # –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥, health-check
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ SettingsService.php      # edit, editBackup, editCacheCron (–≤–ª–∏—Ç–æ –∏–∑ domain/Settings/)
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ Bouquet/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ BouquetService.php       # + BouquetRepository + BouquetMapper (–æ–¥–∏–Ω —Ñ–∞–π–ª, < 300 —Å—Ç—Ä.)
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ Epg/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ EpgService.php           # + EpgRepository (–æ–¥–∏–Ω —Ñ–∞–π–ª, < 300 —Å—Ç—Ä.)
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ Auth/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ AuthService.php          # CodeService + HMACService + HMACValidator (–æ–±—ä–µ–¥–∏–Ω–µ–Ω—ã)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ AuthRepository.php       # CodeRepository + HMACRepository (–æ–±—ä–µ–¥–∏–Ω–µ–Ω—ã)
‚îÇ   ‚îÇ
‚îÇ   ‚îî‚îÄ‚îÄ Security/
‚îÇ       ‚îî‚îÄ‚îÄ BlocklistService.php     # + BlocklistRepository (–æ–¥–∏–Ω —Ñ–∞–π–ª, < 300 —Å—Ç—Ä.)
‚îÇ
‚îú‚îÄ‚îÄ streaming/                       # ‚ïê‚ïê‚ïê –°–¢–†–ò–ú–ò–ù–ì-–î–í–ò–ñ–û–ö (hot path) ‚ïê‚ïê‚ïê
‚îÇ   ‚îú‚îÄ‚îÄ StreamingBootstrap.php       # –õ—ë–≥–∫–∏–π init –¥–ª—è —Å—Ç—Ä–∏–º–∏–Ω–≥-–∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
‚îÇ   ‚îú‚îÄ‚îÄ Auth/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ TokenAuth.php            # HMAC/token –ø–∞—Ä—Å–∏–Ω–≥ (–∏–∑ auth.php)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ StreamAuth.php           # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –ø–æ—Ç–æ–∫—É
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ DeviceLock.php           # –ü—Ä–∏–≤—è–∑–∫–∞ –∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤—É
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ Delivery/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ LiveDelivery.php         # –†–∞–∑–¥–∞—á–∞ live (–∏–∑ live.php)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ VodDelivery.php          # –†–∞–∑–¥–∞—á–∞ VOD (–∏–∑ stream/vod.php)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ TimeshiftDelivery.php    # Timeshift
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ SegmentReader.php        # –ß—Ç–µ–Ω–∏–µ TS-—Å–µ–≥–º–µ–Ω—Ç–æ–≤
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ Balancer/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ LoadBalancer.php         # –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ + RedirectStrategy (–æ–¥–∏–Ω —Ñ–∞–π–ª, < 150 —Å—Ç—Ä.)
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ Protection/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ RestreamDetector.php     # –ê–Ω—Ç–∏–ø–∏—Ä–∞—Ç—Å–∫–∞—è –∑–∞—â–∏—Ç–∞
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ConnectionLimiter.php    # –õ–∏–º–∏—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ GeoBlock.php            # –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø–æ —Å—Ç—Ä–∞–Ω–µ/ISP/IP/UA
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ Codec/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ FFmpegCommand.php        # –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ FFmpeg-–∫–æ–º–∞–Ω–¥ (–∏–∑ CoreUtilities)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ TranscodeProfile.php     # –ü—Ä–æ—Ñ–∏–ª–∏ —Ç—Ä–∞–Ω—Å–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ TsParser.php            # –ü–∞—Ä—Å–µ—Ä MPEG-TS (—Ç–µ–∫—É—â–∏–π ts.php)
‚îÇ   ‚îÇ
‚îÇ   ‚îî‚îÄ‚îÄ Health/
‚îÇ       ‚îú‚îÄ‚îÄ DivergenceDetector.php   # –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∫–∞—á–µ—Å—Ç–≤–∞
‚îÇ       ‚îî‚îÄ‚îÄ BitrateTracker.php       # –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ bitrate/FPS
‚îÇ
‚îú‚îÄ‚îÄ interfaces/                      # ‚ïê‚ïê‚ïê –¢–û–ß–ö–ò –í–•–û–î–ê (UI, API, CLI) ‚ïê‚ïê‚ïê
‚îÇ   ‚îú‚îÄ‚îÄ Http/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ public/                  # Web root (nginx document root)
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ index.php            # –ï–¥–∏–Ω–∞—è —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞ (front controller)
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ stream.php           # –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –¥–ª—è —Å—Ç—Ä–∏–º–∏–Ω–≥–∞
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ assets/              # CSS/JS/images/fonts
‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ admin/
‚îÇ   ‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ player/
‚îÇ   ‚îÇ   ‚îÇ
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Controllers/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Admin/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ DashboardController.php
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ StreamController.php
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ LineController.php
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ VodController.php
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ServerController.php
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ SettingsController.php
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ UserController.php
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ BouquetController.php
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ EpgController.php
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ... (–ø–æ –æ–¥–Ω–æ–º—É –Ω–∞ –¥–æ–º–µ–Ω–Ω—É—é –æ–±–ª–∞—Å—Ç—å)
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Reseller/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ DashboardController.php
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ LineController.php
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ... (—Ç–æ–ª—å–∫–æ —Ä–∞–∑—Ä–µ—à—ë–Ω–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è)
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ Api/
‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ AdminApiController.php
‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ ResellerApiController.php
‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ PlayerApiController.php   # –ü—É–±–ª–∏—á–Ω—ã–π player API
‚îÇ   ‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ InternalApiController.php  # –ú–µ–∂—Å–µ—Ä–≤–µ—Ä–Ω—ã–π API (—Ç–µ–∫—É—â–∏–π www/api.php)
‚îÇ   ‚îÇ   ‚îÇ
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ Views/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ layouts/
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ admin.php        # Header + footer —à–∞–±–ª–æ–Ω –¥–ª—è admin
‚îÇ   ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ reseller.php     # Header + footer —à–∞–±–ª–æ–Ω –¥–ª—è reseller
‚îÇ   ‚îÇ       ‚îÇ
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ admin/
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ dashboard.php
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ streams/
‚îÇ   ‚îÇ       ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ list.php
‚îÇ   ‚îÇ       ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ edit.php
‚îÇ   ‚îÇ       ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ view.php
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ lines/
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ vod/
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ servers/
‚îÇ   ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ settings/
‚îÇ   ‚îÇ       ‚îÇ
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ reseller/
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ dashboard.php
‚îÇ   ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îÇ   ‚îÇ       ‚îÇ
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ partials/
‚îÇ   ‚îÇ           ‚îú‚îÄ‚îÄ modals.php
‚îÇ   ‚îÇ           ‚îú‚îÄ‚îÄ topbar.php
‚îÇ   ‚îÇ           ‚îî‚îÄ‚îÄ table.php
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ Cli/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Commands/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ StartupCommand.php       # cli/startup.php
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ WatchdogCommand.php      # cli/watchdog.php
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ MonitorCommand.php       # cli/monitor.php
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ CacheHandlerCommand.php  # cli/cache_handler.php
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ QueueCommand.php         # cli/queue.php
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ SignalsCommand.php       # cli/signals.php
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ScannerCommand.php       # cli/scanner.php
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ MigrateCommand.php       # –ò–∑ status
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ToolsCommand.php         # –ò–∑ tools (rescue, access, ports –∏ —Ç.–¥.)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ CronJobs/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ StreamsCron.php
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ ServersCron.php
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ CacheCron.php
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ EpgCron.php
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ CleanupCron.php
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ BackupsCron.php
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ StatsCron.php
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ LogsCron.php            # lines_logs + streams_logs
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ VodCron.php
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ TmdbCron.php
‚îÇ   ‚îÇ
‚îÇ   ‚îî‚îÄ‚îÄ Player/                         # –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π web-–ø–ª–µ–µ—Ä
‚îÇ       ‚îú‚îÄ‚îÄ PlayerController.php
‚îÇ       ‚îî‚îÄ‚îÄ views/
‚îÇ           ‚îî‚îÄ‚îÄ ... (—Ç–µ–∫—É—â–∏–π player/)
‚îÇ
‚îú‚îÄ‚îÄ modules/                         # ‚ïê‚ïê‚ïê –û–ü–¶–ò–û–ù–ê–õ–¨–ù–´–ï –ú–û–î–£–õ–ò ‚ïê‚ïê‚ïê
‚îÇ   ‚îú‚îÄ‚îÄ ministra/                    # Ministra/Stalker middleware (—Ç–µ–∫—É—â–∏–π ministra/)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ module.json              # Manifest: name, version, dependencies
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ MinistraModule.php       # –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –º–æ–¥—É–ª—è (implements ModuleInterface)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ PortalHandler.php        # –î–∏—Å–ø–µ—Ç—á–µ—Ä type+action (15 –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ PortalHelpers.php        # –•–µ–ª–ø–µ—Ä—ã –ø–æ—Ä—Ç–∞–ª–∞ (19 —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö –º–µ—Ç–æ–¥–æ–≤)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ assets/
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ plex/                        # Plex integration (—Ç–µ–∫—É—â–∏–π settings_plex, plex_add)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ module.json
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ PlexModule.php
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ PlexService.php
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ config/
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ tmdb/                        # TMDB Integration
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ module.json
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ TmdbModule.php
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ TmdbService.php
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ TmdbCron.php
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ TmdbPopularCron.php
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ lib.php                  # proxy ‚Üí includes/libs/tmdb.php
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ watch/                       # Watch/Recording (—Ç–µ–∫—É—â–∏–µ watch, record —Ñ–∞–π–ª—ã)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ module.json
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ WatchModule.php
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ WatchService.php
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ RecordingService.php
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ WatchController.php
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ WatchCron.php
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ WatchItem.php
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ views/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ watch.php
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ watch_scripts.php
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ watch_add.php
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ watch_add_scripts.php
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ settings_watch.php
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ settings_watch_scripts.php
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ watch_output.php
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ watch_output_scripts.php
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ record.php
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ record_scripts.php
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ fingerprint/                 # Fingerprint watermarking
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ module.json
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ FingerprintModule.php
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ theft-detection/             # Anti-theft/restream detection
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ module.json
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ TheftDetectionModule.php
‚îÇ   ‚îÇ
‚îÇ   ‚îî‚îÄ‚îÄ magscan/                     # MAG device scanning
‚îÇ       ‚îú‚îÄ‚îÄ module.json
‚îÇ       ‚îî‚îÄ‚îÄ MagscanModule.php
‚îÇ
‚îú‚îÄ‚îÄ infrastructure/                  # ‚ïê‚ïê‚ïê –°–ò–°–¢–ï–ú–ù–ê–Ø –ò–ù–§–†–ê–°–¢–†–£–ö–¢–£–†–ê ‚ïê‚ïê‚ïê
‚îÇ   ‚îú‚îÄ‚îÄ nginx/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ NginxConfigGenerator.php # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è nginx.conf (–∏–∑ CoreUtilities)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ templates/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ main.conf.tpl
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ rtmp.conf.tpl
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ vhost.conf.tpl
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ NginxReloader.php
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ redis/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ RedisManager.php         # –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ, pipeline, pub/sub
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ service/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ServiceManager.sh        # –¢–µ–∫—É—â–∏–π —Ñ–∞–π–ª `service` (bash)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ daemons.sh               # –°–ø–∏—Å–æ–∫ –¥–µ–º–æ–Ω–æ–≤
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ install/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ database.sql             # –ù–∞—á–∞–ª—å–Ω–∞—è —Å—Ö–µ–º–∞
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ proxy.tar.gz
‚îÇ   ‚îÇ
‚îÇ   ‚îî‚îÄ‚îÄ bin/                         # –í–Ω–µ—à–Ω–∏–µ –±–∏–Ω–∞—Ä–Ω–∏–∫–∏ (FFmpeg, certbot, yt-dlp –∏ —Ç.–¥.)
‚îÇ       ‚îú‚îÄ‚îÄ ffmpeg_bin/
‚îÇ       ‚îú‚îÄ‚îÄ certbot/
‚îÇ       ‚îú‚îÄ‚îÄ maxmind/
‚îÇ       ‚îú‚îÄ‚îÄ guess
‚îÇ       ‚îú‚îÄ‚îÄ yt-dlp
‚îÇ       ‚îî‚îÄ‚îÄ network.py
‚îÇ
‚îú‚îÄ‚îÄ data/                            # ‚ïê‚ïê‚ïê –î–ê–ù–ù–´–ï –í–†–ï–ú–ï–ù–ò –í–´–ü–û–õ–ù–ï–ù–ò–Ø ‚ïê‚ïê‚ïê
‚îÇ   ‚îú‚îÄ‚îÄ cache/                       # –§–∞–π–ª–æ–≤—ã–π –∫—ç—à (igbinary)
‚îÇ   ‚îú‚îÄ‚îÄ logs/                        # –õ–æ–≥–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ tmp/                         # –í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã (—Ç–µ–∫—É—â–∏–π tmp/)
‚îÇ   ‚îú‚îÄ‚îÄ content/                     # –ú–µ–¥–∏–∞-–∫–æ–Ω—Ç–µ–Ω—Ç (—Ç–µ–∫—É—â–∏–π content/)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ archive/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ epg/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ playlists/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ streams/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ video/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ vod/
‚îÇ   ‚îú‚îÄ‚îÄ backups/                     # –†–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏
‚îÇ   ‚îî‚îÄ‚îÄ signals/                     # –°–∏–≥–Ω–∞–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã (.gitkeep)
‚îÇ
‚îú‚îÄ‚îÄ config/                          # ‚ïê‚ïê‚ïê –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ‚ïê‚ïê‚ïê
‚îÇ   ‚îú‚îÄ‚îÄ config.ini                   # –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥ (DB, Redis, –ø—É—Ç–∏)
‚îÇ   ‚îú‚îÄ‚îÄ modules.php                  # –°–ø–∏—Å–æ–∫ –≤–∫–ª—é—á—ë–Ω–Ω—ã—Ö –º–æ–¥—É–ª–µ–π
‚îÇ   ‚îú‚îÄ‚îÄ routes.php                   # –¢–∞–±–ª–∏—Ü–∞ –º–∞—Ä—à—Ä—É—Ç–æ–≤
‚îÇ   ‚îú‚îÄ‚îÄ plex/
‚îÇ   ‚îî‚îÄ‚îÄ rclone.conf
‚îÇ
‚îî‚îÄ‚îÄ resources/                       # ‚ïê‚ïê‚ïê –†–ï–°–£–†–°–´ ‚ïê‚ïê‚ïê
    ‚îú‚îÄ‚îÄ langs/                       # –ü–µ—Ä–µ–≤–æ–¥—ã (—Ç–µ–∫—É—â–∏–µ .ini —Ñ–∞–π–ª—ã)
    ‚îÇ   ‚îú‚îÄ‚îÄ en.ini
    ‚îÇ   ‚îú‚îÄ‚îÄ ru.ini
    ‚îÇ   ‚îú‚îÄ‚îÄ de.ini
    ‚îÇ   ‚îú‚îÄ‚îÄ es.ini
    ‚îÇ   ‚îú‚îÄ‚îÄ fr.ini
    ‚îÇ   ‚îú‚îÄ‚îÄ bg.ini
    ‚îÇ   ‚îî‚îÄ‚îÄ pt.ini
    ‚îú‚îÄ‚îÄ data/
    ‚îÇ   ‚îú‚îÄ‚îÄ countries.php            # –ú–∞—Å—Å–∏–≤—ã —Å—Ç—Ä–∞–Ω (–∏–∑–≤–ª–µ—á–µ–Ω—ã –∏–∑ admin.php)
    ‚îÇ   ‚îú‚îÄ‚îÄ timezones.php
    ‚îÇ   ‚îú‚îÄ‚îÄ mac_types.php
    ‚îÇ   ‚îî‚îÄ‚îÄ error_codes.php          # $rErrorCodes (–∏–∑–≤–ª–µ—á–µ–Ω—ã –∏–∑ constants.php)
    ‚îî‚îÄ‚îÄ libs/                        # –°—Ç–æ—Ä–æ–Ω–Ω–∏–µ PHP-–±–∏–±–ª–∏–æ—Ç–µ–∫–∏
        ‚îú‚îÄ‚îÄ MobileDetect.php
        ‚îú‚îÄ‚îÄ XmlStringStreamer.php
        ‚îú‚îÄ‚îÄ m3u/
        ‚îî‚îÄ‚îÄ Dropbox.php
```

---

## 4. –û–ø–∏—Å–∞–Ω–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤

### 4.1. `core/` ‚Äî –Ø–¥—Ä–æ —Å–∏—Å—Ç–µ–º—ã

**–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å:** –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã, –∫–æ—Ç–æ—Ä—ã–µ –Ω—É–∂–Ω—ã –ª—é–±–æ–º—É –∫–æ–Ω—Ç–µ–∫—Å—Ç—É –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è. –ù–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏.

| –ü–æ–¥–∫–∞—Ç–∞–ª–æ–≥ | –ß—Ç–æ –¥–∞—ë—Ç | –ß—Ç–æ –∑–∞–º–µ–Ω—è–µ—Ç |
|------------|----------|--------------|
| `Config/` | –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏, —Ä–µ–∑–æ–ª–≤ –ø—É—Ç–µ–π | 70 `define()` –∏–∑ `constants.php` –∏ `stream/init.php` |
| `Database/` | PDO-–æ–±—ë—Ä—Ç–∫–∞ (Database + DatabaseHandler), query builder, –º–∏–≥—Ä–∞—Ü–∏–∏ | `Database.php` + SQL-–∑–∞–ø—Ä–æ—Å—ã –∏–∑ `status` |
| `Cache/` | –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫—ç—à —Å –¥–≤—É–º—è –¥—Ä–∞–π–≤–µ—Ä–∞–º–∏ | –†–∞–∑–±—Ä–æ—Å–∞–Ω–Ω—ã–µ `igbinary_serialize` + ad-hoc Redis |
| `Auth/` | –ï–¥–∏–Ω–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –¥–ª—è admin –∏ reseller | `session.php` √ó 2, `API::processLogin()`, `ResellerAPI::processLogin()` |
| `Http/` | –ê–±—Å—Ç—Ä–∞–∫—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤, —Ä–æ—É—Ç–∏–Ω–≥, middleware | `cleanGlobals()` √ó 2, `switch($rAction)`, flood-check –≤ constants.php |
| `Process/` | –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ PID, –¥–µ–º–æ–Ω–∞–º–∏, –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞–º–∏ | `shell_exec('ps aux')`, `posix_kill()`, `checkCron()` —Ä–∞–∑–±—Ä–æ—Å–∞–Ω–Ω—ã–µ –ø–æ —Ñ–∞–π–ª–∞–º |
| `Logging/` | –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ | `CoreUtilities::saveLog()`, `StreamingUtilities::clientLog()`, `Logger::init()` |
| `Events/` | Event bus –¥–ª—è —Å–≤—è–∑–∏ –±–µ–∑ –∂—ë—Å—Ç–∫–∏—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π | –ü—Ä—è–º—ã–µ –≤—ã–∑–æ–≤—ã –º–µ–∂–¥—É –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏ |
| `Container/` | DI-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä (composition root only ‚Äî —Å–º. ¬ß2.3) | `global $db`, —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ `CoreUtilities::$rSettings` |
| `Util/` | –£—Ç–∏–ª–∏—Ç—ã –±–µ–∑ —Å–æ—Å—Ç–æ—è–Ω–∏—è | –§—É–Ω–∫—Ü–∏–∏ —Ä–∞–∑–±—Ä–æ—Å–∞–Ω–Ω—ã–µ –ø–æ CoreUtilities, admin.php |

**–ö–ª—é—á–µ–≤–æ–µ –ø—Ä–∞–≤–∏–ª–æ:** `core/` –Ω–µ –∑–Ω–∞–µ—Ç –æ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–∏ `domain/`, `streaming/`, `modules/`, `interfaces/`. –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω—ã —Ç–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä—å —è–¥—Ä–∞.

### 4.2. `domain/` ‚Äî –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞

**–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å:** –°–µ—Ä–≤–∏—Å—ã –∏ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏, –æ—Ä–≥–∞–Ω–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –ø–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞–º. –ö–∞–∂–¥—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç (Stream, Vod, Line, User...) ‚Äî –æ—Ç–¥–µ–ª—å–Ω–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è.

**–ü–∞—Ç—Ç–µ—Ä–Ω –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞:**

```
domain/Stream/
  ‚îú‚îÄ‚îÄ StreamService.php       # –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ + –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏—è (–≤–∞–ª–∏–¥–∞—Ü–∏—è, —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏, side-effects)
  ‚îú‚îÄ‚îÄ StreamRepository.php    # SQL-–∑–∞–ø—Ä–æ—Å—ã (SELECT/INSERT/UPDATE/DELETE)
  ‚îî‚îÄ‚îÄ StreamProcess.php       # –°–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ —Å–∏—Å—Ç–µ–º–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ (ffmpeg, kill, PID)
```

**–ü—Ä–∞–≤–∏–ª–∞:**

1. **Service** = –≤—Å—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞. –í–∞–ª–∏–¥–∞—Ü–∏—è, —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏, –≤—ã–∑–æ–≤ Infrastructure (nginx, ffmpeg), –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ. –û–¥–∏–Ω Service –Ω–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç, –ø—Ä–∏ —Ä–æ—Å—Ç–µ –º–æ–∂–Ω–æ —Ä–∞–∑–±–∏—Ç—å.
2. **Repository** = —Ç–æ–ª—å–∫–æ SQL. –ü—Ä–∏–Ω–∏–º–∞–µ—Ç –º–∞—Å—Å–∏–≤—ã, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –º–∞—Å—Å–∏–≤—ã. –ù–∏–∫–∞–∫–æ–π –ª–æ–≥–∏–∫–∏. –ù–∏–∫–∞–∫–∏—Ö side-effects.
3. **–ù–µ—Ç Entity-–∫–ª–∞—Å—Å–æ–≤.** –î–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è –∫–∞–∫ `array`. –≠—Ç–æ PHP ‚Äî –º–∞—Å—Å–∏–≤—ã –ø—Ä–æ—â–µ –∏ –ø–æ–Ω—è—Ç–Ω–µ–µ, —á–µ–º –∞–Ω–æ–º–∏—á–Ω—ã–µ DTO-–æ–±—ä–µ–∫—Ç—ã.
4. **–ö–æ–Ω—Å–æ–ª–∏–¥–∞—Ü–∏—è –º–µ–ª–∫–∏—Ö –∫–ª–∞—Å—Å–æ–≤ (¬ß2.4).** –ï—Å–ª–∏ Repository < 5 –º–µ—Ç–æ–¥–æ–≤ –∏ < 150 —Å—Ç—Ä–æ–∫ ‚Äî –æ–Ω –∂–∏–≤—ë—Ç –≤ –æ–¥–Ω–æ–º —Ñ–∞–π–ª–µ —Å Service. –ú–µ–ª–∫–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç—ã (Ticket, Settings) –≤–ª–∏–≤–∞—é—Ç—Å—è –≤ —Ä–æ–¥—Å—Ç–≤–µ–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç, –∞ –Ω–µ —Å–æ–∑–¥–∞—é—Ç –æ—Ç–¥–µ–ª—å–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é.

```php
// ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û ‚Äî Service –¥–µ–ª–∞–µ—Ç –≤—Å—ë:
class StreamService {
    public function __construct(
        private StreamRepository $repository,
        private ProcessManager $processManager,
        private FileLogger $logger,
        private Database $db
    ) {}
    
    public function create(array $data): int {
        // –í–∞–ª–∏–¥–∞—Ü–∏—è
        if (empty($data['stream_source'])) {
            throw new \InvalidArgumentException('Source required');
        }
        
        // –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è
        $this->db->beginTransaction();
        try {
            $id = $this->repository->insert($data);
            $this->db->commit();
        } catch (\Throwable $e) {
            $this->db->rollBack();
            throw $e;
        }
        
        $this->logger->log('stream', "Created stream {$id}");
        return $id;
    }
}

// ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û ‚Äî Repository = —Ç–æ–ª—å–∫–æ SQL:
class StreamRepository {
    public function __construct(private Database $db) {}
    
    public function findById(int $id): ?array {
        return $this->db->row("SELECT * FROM streams WHERE id = ?", [$id]);
    }
    
    public function insert(array $data): int {
        $this->db->query("INSERT INTO streams ...", $data);
        return $this->db->lastInsertId();
    }
}
```

**–û—Ç–∫—É–¥–∞ –±–µ—Ä—ë—Ç—Å—è –∫–æ–¥:**
- `admin_api.php` (6981 —Å—Ç—Ä–æ–∫) ‚Üí —Ä–∞–∑–±–∏–≤–∞–µ—Ç—Å—è –Ω–∞ ~10 Service + ~6 Repository (¬ß2.4 ‚Äî –º–µ–ª–∫–∏–µ Repository –≤–ª–∏—Ç—ã –≤ Service)
- `admin.php` ‚Üí –ø—Ä–æ—Ü–µ–¥—É—Ä–Ω—ã–µ `getUserInfo()`, `getSeriesList()` ‚Üí –≤ Repository
- –û—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏—è (validate + save + nginx + cache + log) ‚Üí –≤ Service

**–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** `domain/` –∑–∞–≤–∏—Å–∏—Ç –æ—Ç `core/` (Database, Cache, Events). –ù–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç `interfaces/` –∏–ª–∏ `modules/`.

### 4.3. `streaming/` ‚Äî –°—Ç—Ä–∏–º–∏–Ω–≥-–¥–≤–∏–∂–æ–∫

**–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å:** –í–µ—Å—å hot path –¥–æ—Å—Ç–∞–≤–∫–∏ –≤–∏–¥–µ–æ. –í—ã–¥–µ–ª–µ–Ω –æ—Ç–¥–µ–ª—å–Ω–æ –æ—Ç `domain/` –ø–æ—Ç–æ–º—É —á—Ç–æ:
- –ö—Ä–∏—Ç–∏—á–µ–Ω –∫ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ (–Ω–µ–ª—å–∑—è –∑–∞–≥—Ä—É–∂–∞—Ç—å –≤—Å—é –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É)
- –ò–º–µ–µ—Ç —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π –ª—ë–≥–∫–∏–π bootstrap
- –†–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ —É—Ä–æ–≤–Ω–µ –±–∞–π—Ç–æ–≤/—Å–µ–≥–º–µ–Ω—Ç–æ–≤, –∞ –Ω–µ –Ω–∞ —É—Ä–æ–≤–Ω–µ CRUD

#### –ò–∑–æ–ª—è—Ü–∏—è streaming

Streaming ‚Äî **–æ—Ç–¥–µ–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è** —Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è–º–∏:

```
streaming/ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç:
  ‚úÖ core/ (Database, Redis, Logging, GeoIP, Encryption, NetworkUtils)
  ‚úÖ domain/ (Repository ‚Äî —Ç–æ–ª—å–∫–æ SELECT-–∑–∞–ø—Ä–æ—Å—ã: –ø–æ—Ç–æ–∫–∏, —Å–µ—Ä–≤–µ—Ä—ã, –±—É–∫–µ—Ç—ã)
  
  ‚ùå –ù–ï –∑–∞–≤–∏—Å–∏—Ç –æ—Ç:
     - interfaces/ (–∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã)
     - modules/ (–≤—Å—ë)
     - domain/*Service.php (–±–∏–∑–Ω–µ—Å-–º—É—Ç–∞—Ü–∏–∏)
```

**–ì–ª–∞–≤–Ω–æ–µ –ø—Ä–∞–≤–∏–ª–æ:** streaming –≤—ã–∑—ã–≤–∞–µ—Ç **—Ç–æ–ª—å–∫–æ read-–º–µ—Ç–æ–¥—ã** Repository. –ó–∞–ø–∏—Å—å –¥–∞–Ω–Ω—ã—Ö (PID, stats, connections) ‚Äî —á–µ—Ä–µ–∑ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–µ –∫–ª–∞—Å—Å—ã (`ConnectionTracker`, `BitrateTracker`), –∞ –Ω–µ —á–µ—Ä–µ–∑ Domain Services.

**–û—Ç–∫—É–¥–∞ –±–µ—Ä—ë—Ç—Å—è –∫–æ–¥:**
- `StreamingUtilities.php` (1992 —Å—Ç—Ä.) ‚Üí —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –ø–æ –ø–æ–¥–∫–∞—Ç–∞–ª–æ–≥–∞–º
- `www/stream/auth.php` (800 —Å—Ç—Ä.) ‚Üí `Auth/TokenAuth.php` + `Auth/StreamAuth.php` + `Protection/`
- `www/stream/live.php` (708 —Å—Ç—Ä.) ‚Üí `Delivery/LiveDelivery.php`
- `includes/cli/monitor.php` (565 —Å—Ç—Ä.) ‚Üí `domain/Stream/StreamMonitor.php` (—Å —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–æ–º goto)
- `CoreUtilities` –º–µ—Ç–æ–¥—ã FFmpeg ‚Üí `Codec/FFmpegCommand.php`
- `ts.php` ‚Üí `Codec/TsParser.php`

### 4.4. `interfaces/` ‚Äî –¢–æ—á–∫–∏ –≤—Ö–æ–¥–∞

**–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å:** –ü–æ–ª—É—á–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞, –≤—ã–∑–æ–≤ Service, —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞. –ù–∏–∫–∞–∫–æ–π –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏.

**HTTP:**
- –û–¥–∏–Ω front controller `public/index.php` + `Router`
- –ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã –≤—ã–∑—ã–≤–∞—é—Ç **Service** –∏–∑ `domain/` –¥–ª—è –º—É—Ç–∞—Ü–∏–π –∏ **Repository** –¥–ª—è —á—Ç–µ–Ω–∏—è
- –®–∞–±–ª–æ–Ω—ã (`Views/`) ‚Äî —á–∏—Å—Ç—ã–π HTML —Å –º–∏–Ω–∏–º—É–º–æ–º PHP-–≤—Å—Ç–∞–≤–æ–∫
- Admin –∏ Reseller ‚Äî —Ä–∞–∑–Ω—ã–µ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã, –æ–±—â–∏–µ —à–∞–±–ª–æ–Ω—ã

```php
// ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û ‚Äî –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –≤—ã–∑—ã–≤–∞–µ—Ç Service:
class StreamController {
    public function __construct(
        private StreamService $streamService,
        private StreamRepository $streamRepo
    ) {}
    
    public function create(Request $request): void {
        $id = $this->streamService->create($request->all());
        Response::json(['id' => $id]);
    }
    
    public function list(): void {
        $streams = $this->streamRepo->getAll();
        include VIEW_PATH . '/admin/streams/list.php';
    }
}

// ‚ùå –ó–ê–ü–†–ï–©–ï–ù–û ‚Äî –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä —Å–æ–¥–µ—Ä–∂–∏—Ç –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É:
class StreamController {
    public function create(Request $request): void {
        // –í–∞–ª–∏–¥–∞—Ü–∏—è, —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏, nginx ‚Äî —ç—Ç–æ –∑–∞–¥–∞—á–∞ Service
        $this->db->beginTransaction();
        $this->streamRepo->insert(...);  // ‚Üê fat controller
        $this->nginx->reload();
        $this->db->commit();
    }
}
```

**CLI:**
- –ö–∞–∂–¥—ã–π –¥–µ–º–æ–Ω/–∫—Ä–æ–Ω ‚Äî –æ—Ç–¥–µ–ª—å–Ω—ã–π Command-–∫–ª–∞—Å—Å
- –û–±—â–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ `bootstrap.php` + `ServiceContainer`
- –§–∞–π–ª `service` (bash) ‚Üí `infrastructure/service/ServiceManager.sh`

**–û—Ç–∫—É–¥–∞ –±–µ—Ä—ë—Ç—Å—è –∫–æ–¥:**
- –ö–∞–∂–¥—ã–π `admin/*.php` (100+ —Ñ–∞–π–ª–æ–≤) ‚Üí Controller + View. –ü—Ä–∏–º–µ—Ä: `admin/streams.php` ‚Üí `Controllers/Admin/StreamController.php` + `Views/admin/streams/list.php`
- `admin/header.php` (675 —Å—Ç—Ä.) + `admin/footer.php` (805 —Å—Ç—Ä.) ‚Üí `Views/layouts/admin.php` + –≤—ã–¥–µ–ª–µ–Ω–∏–µ JS –≤ —Ñ–∞–π–ª—ã `assets/`
- `admin/post.php` (1946 —Å—Ç—Ä.) ‚Üí –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Ñ–æ—Ä–º —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è—é—Ç—Å—è –ø–æ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞–º
- `crons/*.php` ‚Üí `Cli/CronJobs/`, –∫–∞–∂–¥—ã–π –∫—Ä–æ–Ω ‚Äî –æ–¥–∏–Ω —Ñ–∞–π–ª
- `includes/cli/*.php` ‚Üí `Cli/Commands/`

### 4.5. `modules/` ‚Äî –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –º–æ–¥—É–ª–∏

**–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å:** –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ —è–≤–ª—è—é—Ç—Å—è —á–∞—Å—Ç—å—é —è–¥—Ä–∞. –ö–∞–∂–¥—ã–π –º–æ–¥—É–ª—å ‚Äî —Å–∞–º–æ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è.

**–ö–æ–Ω—Ç—Ä–∞–∫—Ç –º–æ–¥—É–ª—è:**

```php
interface ModuleInterface {
    public function getName(): string;
    public function getVersion(): string;
    public function boot(ServiceContainer $container): void;   // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Å–µ—Ä–≤–∏—Å–æ–≤
    public function registerRoutes(Router $router): void;      // –°–≤–æ–∏ –º–∞—Ä—à—Ä—É—Ç—ã
    public function registerCrons(): array;                     // –°–≤–æ–∏ –∫—Ä–æ–Ω—ã
    public function getEventSubscribers(): array;              // –ü–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ —Å–æ–±—ã—Ç–∏—è
}
```

```json
// module.json
{
    "name": "ministra",
    "version": "1.0.0",
    "description": "Ministra/Stalker Portal middleware",
    "requires_core": ">=2.0",
    "dependencies": []
}
```

**–¢–µ–∫—É—â–∏–π –∫–æ–¥ ‚Üí –º–æ–¥—É–ª–∏:**

| –ú–æ–¥—É–ª—å | –ò—Å—Ç–æ—á–Ω–∏–∫ | –ü–æ—á–µ–º—É –º–æ–¥—É–ª—å, –∞ –Ω–µ —è–¥—Ä–æ |
|--------|----------|-------------------------|
| `ministra/` | `src/ministra/` (2155+ —Å—Ç—Ä–æ–∫, –¥–µ—Å—è—Ç–∫–∏ JS-—Ñ–∞–π–ª–æ–≤) | –°—Ç–æ—Ä–æ–Ω–Ω–∏–π –ø–æ—Ä—Ç–∞–ª, –Ω–µ –≤—Å–µ–º –Ω—É–∂–µ–Ω |
| `plex/` | `settings_plex.php`, `plex_add.php`, `crons/plex.php`, `config/plex/` | –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –≤–Ω–µ—à–Ω–∏–º —Å–µ—Ä–≤–∏—Å–æ–º |
| `tmdb/` | `includes/libs/TMDb/`, `crons/tmdb.php`, `crons/tmdb_popular.php` | –í–Ω–µ—à–Ω–∏–π API –¥–ª—è –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö |
| `watch/` | `watch.php`, `watch_add.php`, `watch_output.php`, `settings_watch.php`, `crons/watch.php` | –ó–∞–ø–∏—Å—å/DVR ‚Äî —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è |
| `fingerprint/` | `admin/fingerprint.php` | –í–æ–¥—è–Ω—ã–µ –∑–Ω–∞–∫–∏ ‚Äî enterprise-—Ñ—É–Ω–∫—Ü–∏—è |
| `theft-detection/` | `admin/theft_detection.php` | –ê–Ω—Ç–∏–ø–∏—Ä–∞—Ç—Å—Ç–≤–æ ‚Äî enterprise-—Ñ—É–Ω–∫—Ü–∏—è |
| `magscan/` | `admin/magscan_settings.php` | –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤ |

### 4.6. `infrastructure/` ‚Äî –°–∏—Å—Ç–µ–º–Ω—ã–π —Å–ª–æ–π

**–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å:** –í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å –û–°: nginx, redis, bash-—Å–∫—Ä–∏–ø—Ç—ã, –≤–Ω–µ—à–Ω–∏–µ –±–∏–Ω–∞—Ä–Ω–∏–∫–∏.

**–û—Ç–∫—É–¥–∞ –±–µ—Ä—ë—Ç—Å—è –∫–æ–¥:**
- `CoreUtilities` ‚Üí –≥–µ–Ω–µ—Ä–∞—Ü–∏—è nginx-–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ ‚Üí `nginx/NginxConfigGenerator.php`
- `bin/nginx/`, `bin/php/`, `bin/redis/` ‚Üí `bin/` (–±–∏–Ω–∞—Ä–Ω–∏–∫–∏ –∫–∞–∫ –µ—Å—Ç—å)
- `bin/daemons.sh` ‚Üí `service/daemons.sh`
- `service` ‚Üí `service/ServiceManager.sh`
- `bin/install/database.sql` ‚Üí `install/database.sql`

### 4.7. `data/` ‚Äî Runtime-–¥–∞–Ω–Ω—ã–µ

**–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å:** –í—Å—ë, —á—Ç–æ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –ø—Ä–∏ —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏–∏ –∏ –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –∫–æ–¥–æ–º.

–ó–∞–º–µ–Ω—è–µ—Ç —Ç–µ–∫—É—â–∏–µ: `tmp/`, `content/`, `backups/`, `signals/`.

### 4.8. `config/` ‚Äî –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

**–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å:** –í—Å—ë, —á—Ç–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –º–æ–∂–µ—Ç –∏–∑–º–µ–Ω–∏—Ç—å –±–µ–∑ –ø—Ä–∞–≤–∫–∏ –∫–æ–¥–∞.

### 4.9. `resources/` ‚Äî –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ä–µ—Å—É—Ä—Å—ã –∏ –¥–∞–Ω–Ω—ã–µ

**–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å:** –ü–µ—Ä–µ–≤–æ–¥—ã, –¥–∞–Ω–Ω—ã–µ-—Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏ (—Å—Ç—Ä–∞–Ω—ã, —Ç–∞–π–º–∑–æ–Ω—ã), —Å—Ç–æ—Ä–æ–Ω–Ω–∏–µ PHP-–±–∏–±–ª–∏–æ—Ç–µ–∫–∏.

**–û—Ç–∫—É–¥–∞ –±–µ—Ä—ë—Ç—Å—è –∫–æ–¥:**
- `includes/langs/*.ini` ‚Üí `langs/`
- Inline-–º–∞—Å—Å–∏–≤—ã —Å—Ç—Ä–∞–Ω –∏–∑ `admin.php` ‚Üí `data/countries.php`
- `$rErrorCodes` –∏–∑ `constants.php` ‚Üí `data/error_codes.php`
- `includes/libs/*` ‚Üí `libs/`

---

## 5. –ö–∞—Ä—Ç–∞ –º–∏–≥—Ä–∞—Ü–∏–∏: –æ—Ç–∫—É–¥–∞ ‚Üí –∫—É–¥–∞

### 5.1. God-–æ–±—ä–µ–∫—Ç `CoreUtilities.php` (4847 —Å—Ç—Ä–æ–∫)

| –ú–µ—Ç–æ–¥/–±–ª–æ–∫ | –¶–µ–ª–µ–≤–æ–π —Ñ–∞–π–ª |
|------------|-------------|
| `init()`, config loading | `core/Config/ConfigLoader.php` |
| `$db`, `getDatabase()` | `core/Database/DatabaseHandler.php` |
| `getCache()`, `setCache()` | `core/Cache/FileCache.php` |
| Redis operations | `core/Cache/RedisCache.php`, `infrastructure/redis/RedisManager.php` |
| `cleanGlobals()`, `parseIncomingRecursively()` | `core/Http/Request.php` |
| `startMonitor()`, `stopStream()`, `startMovie()` | `domain/Stream/StreamService.php` |
| `isStreamRunning()`, `isMonitorRunning()` | `core/Process/ProcessManager.php` |
| FFmpeg command building | `streaming/Codec/FFmpegCommand.php` |
| GeoIP lookup | `core/Util/GeoIP.php` |
| Nginx config generation | `infrastructure/nginx/NginxConfigGenerator.php` |
| Image resize/upload | `core/Util/ImageUtils.php` |
| Encryption (AES/token) | `core/Util/Encryption.php` |
| `saveLog()` | `core/Logging/FileLogger.php` |

### 5.2. God-–æ–±—ä–µ–∫—Ç `admin_api.php` (6981 —Å—Ç—Ä–æ–∫)

| –ú–µ—Ç–æ–¥/–±–ª–æ–∫ | –¶–µ–ª–µ–≤–æ–π —Ñ–∞–π–ª |
|------------|-------------|
| `processStream()` | `domain/Stream/StreamService.php` |
| `processMovie()` | `domain/Vod/MovieService.php` |
| `processSerie()` | `domain/Vod/SeriesService.php` |
| `processEpisode()` | `domain/Vod/EpisodeService.php` |
| `processLine()` | `domain/Line/LineService.php` |
| `processMAG()` | `domain/Device/MagService.php` |
| `processEnigma()` | `domain/Device/EnigmaService.php` |
| `processServer()` | `domain/Server/ServerService.php` |
| `processBouquet()` | `domain/Bouquet/BouquetService.php` (+ Repository + Mapper ‚Äî –æ–¥–∏–Ω —Ñ–∞–π–ª) |
| `processUser()` | `domain/User/UserService.php` (+ submit ticket, editProfile) |
| `processGroup()` | `domain/User/GroupService.php` (+ GroupRepository ‚Äî –æ–¥–∏–Ω —Ñ–∞–π–ª) |
| `processCode()` | `domain/Auth/AuthService.php` (+ Code + HMAC ‚Äî –æ–±—ä–µ–¥–∏–Ω–µ–Ω—ã) |
| `processLogin()` | `core/Auth/Authenticator.php` |
| `processSettings()` | `domain/Server/SettingsService.php` (–≤–ª–∏—Ç–æ –∏–∑ domain/Settings/) |
| `massEditStreams()` | `domain/Stream/StreamService::massEdit()` |
| `checkMinimumRequirements()` | –í–∞–ª–∏–¥–∞—Ü–∏—è –≤ –∫–∞–∂–¥–æ–º Service |

### 5.3. God-bootstrap `admin.php` (4448 —Å—Ç—Ä–æ–∫)

| –ë–ª–æ–∫ | –¶–µ–ª–µ–≤–æ–π —Ñ–∞–π–ª |
|------|-------------|
| `session_start()`, session config | `core/Auth/SessionManager.php` |
| 50+ `define()` —Å—Ç–∞—Ç—É—Å–æ–≤ | `constants.php` |
| `Database` creation | `core/Container/ServiceContainer.php` |
| `CoreUtilities::init()` | `bootstrap.php` |
| `$rCountryCodes`, `$rCountries` | `resources/data/countries.php` |
| `$rPermissions` | `resources/data/permissions.php` ‚Üí `core/Auth/Authorization.php` |
| `getUserInfo()` | `domain/User/UserRepository.php` |
| `getSeriesList()`, `updateSeries()` | `domain/Vod/SeriesService.php` (Repository –≤–ª–∏—Ç ‚Äî ¬ß2.4) |
| `secondsToTime()` | `core/Util/TimeUtils.php` |
| `hasPermissions()` | `core/Auth/Authorization.php` |
| Mobile detect init | `core/Http/Middleware/` (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ) |
| Translator init | `bootstrap.php` ‚Üí `ServiceContainer` |

### 5.4. –°—Ç—Ä–∞–Ω–∏—Ü—ã admin/ (100+ —Ñ–∞–π–ª–æ–≤)

**–ü–∞—Ç—Ç–µ—Ä–Ω —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏:**

```
–ë–´–õ–û:
  admin/streams.php (–æ–¥–∏–Ω —Ñ–∞–π–ª = SQL + HTML + JS)

–°–¢–ê–õ–û:
  interfaces/Http/Controllers/Admin/StreamController.php  ‚Äî –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è
  domain/Stream/StreamRepository.php                       ‚Äî –¥–∞–Ω–Ω—ã–µ
  interfaces/Http/Views/admin/streams/list.php             ‚Äî —à–∞–±–ª–æ–Ω
```

### 5.5. –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ admin/ ‚Üî reseller/

```
–ë–´–õ–û:
  admin/header.php (675 —Å—Ç—Ä–æ–∫)    +  reseller/header.php (284 —Å—Ç—Ä–æ–∫–∏)
  admin/footer.php (805 —Å—Ç—Ä–æ–∫)    +  reseller/footer.php
  admin/session.php               +  reseller/session.php
  admin/functions.php             +  reseller/functions.php

–°–¢–ê–õ–û:
  interfaces/Http/Views/layouts/admin.php      ‚Äî –µ–¥–∏–Ω—ã–π layout
  interfaces/Http/Views/layouts/reseller.php   ‚Äî –Ω–∞—Å–ª–µ–¥—É–µ—Ç admin layout —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è–º–∏
  core/Auth/SessionManager.php                 ‚Äî –µ–¥–∏–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä —Å–µ—Å—Å–∏–π
  core/Auth/Authorization.php                  ‚Äî RBAC –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç, —á—Ç–æ –≤–∏–¥–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
```

### 5.6. –°—Ç—Ä–∏–º–∏–Ω–≥-–ø—É—Ç—å

```
–ë–´–õ–û:
  www/stream/init.php (–¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π bootstrap)
  www/stream/auth.php (800 —Å—Ç—Ä–æ–∫: auth + block + token + balance)
  www/stream/live.php (708 —Å—Ç—Ä–æ–∫: token + ondemand + delivery + heartbeat)
  StreamingUtilities.php (1992 —Å—Ç—Ä–æ–∫–∏: —Ñ–æ—Ä–∫ CoreUtilities)

–°–¢–ê–õ–û:
  streaming/StreamingBootstrap.php   ‚Äî –ª—ë–≥–∫–∏–π init –±–µ–∑ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è
  streaming/Auth/TokenAuth.php       ‚Äî –ø–∞—Ä—Å–∏–Ω–≥ —Ç–æ–∫–µ–Ω–æ–≤
  streaming/Auth/StreamAuth.php      ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞
  streaming/Protection/GeoBlock.php  ‚Äî –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ (IP/ISP/UA/Country)
  streaming/Delivery/LiveDelivery.php ‚Äî —Ä–∞–∑–¥–∞—á–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
  streaming/Health/BitrateTracker.php ‚Äî –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∫–∞—á–µ—Å—Ç–≤–∞
  core/Cache/*                       ‚Äî –æ–±—â–∏–π –∫—ç—à (–Ω–µ –¥—É–±–ª–∏—Ä—É–µ—Ç—Å—è)
  core/Database/DatabaseHandler.php   ‚Äî –æ–±—â–∞—è –ë–î (–Ω–µ –¥—É–±–ª–∏—Ä—É–µ—Ç—Å—è)
```

---

## 6. –°–∏—Å—Ç–µ–º–∞ –º–æ–¥—É–ª–µ–π

### 6.1. –ñ–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª –º–æ–¥—É–ª—è

```
1. –ú–æ–¥—É–ª—å —Ä–∞–∑–º–µ—â–∞–µ—Ç—Å—è –≤ modules/{name}/
2. –î–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ config/modules.php
3. –ü—Ä–∏ bootstrap: ServiceContainer —Å–∫–∞–Ω–∏—Ä—É–µ—Ç modules.php
4. –î–ª—è –∫–∞–∂–¥–æ–≥–æ –º–æ–¥—É–ª—è: require module.json ‚Üí –ø—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π ‚Üí boot()
5. –ú–æ–¥—É–ª—å —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç: —Å–µ—Ä–≤–∏—Å—ã, –º–∞—Ä—à—Ä—É—Ç—ã, –∫—Ä–æ–Ω—ã, event-–ø–æ–¥–ø–∏—Å–∫–∏
6. –£–¥–∞–ª–µ–Ω–∏–µ: —É–±—Ä–∞—Ç—å –∏–∑ modules.php ‚Üí (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) —É–¥–∞–ª–∏—Ç—å –ø–∞–ø–∫—É
```

### 6.2. –ü—Ä–∞–≤–∏–ª–∞ –∏–∑–æ–ª—è—Ü–∏–∏

```
‚úÖ –ú–æ–¥—É–ª—å –ú–û–ñ–ï–¢:
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–µ—Ä–≤–∏—Å—ã –∏–∑ core/ —á–µ—Ä–µ–∑ constructor injection
   - –í—ã–∑—ã–≤–∞—Ç—å Service –∏–∑ domain/ –¥–ª—è –±–∏–∑–Ω–µ—Å-–æ–ø–µ—Ä–∞—Ü–∏–π
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Repository –∏–∑ domain/ –¥–ª—è —á—Ç–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
   - –†–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å —Å–≤–æ–∏ –º–∞—Ä—à—Ä—É—Ç—ã, –∫–æ–º–∞–Ω–¥—ã, –∫—Ä–æ–Ω—ã
   - –ü–æ–¥–ø–∏—Å—ã–≤–∞—Ç—å—Å—è –Ω–∞ —Å–æ–±—ã—Ç–∏—è-—Ö—É–∫–∏ —è–¥—Ä–∞
   - –ò–º–µ—Ç—å —Å–≤–æ–∏ assets, views, –∫–æ–Ω—Ñ–∏–≥–∏

‚ùå –ú–æ–¥—É–ª—å –ù–ï –ú–û–ñ–ï–¢:
   - –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å —Ñ–∞–π–ª—ã core/ –∏–ª–∏ domain/
   - –ù–∞–ø—Ä—è–º—É—é –æ–±—Ä–∞—â–∞—Ç—å—Å—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –º–∏–º–æ Repository
   - –ó–∞–≤–∏—Å–µ—Ç—å –æ—Ç –¥—Ä—É–≥–æ–≥–æ –º–æ–¥—É–ª—è –±–µ–∑ —è–≤–Ω–æ–π –¥–µ–∫–ª–∞—Ä–∞—Ü–∏–∏ –≤ module.json
   - –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è—Ç—å –º–∞—Ä—à—Ä—É—Ç—ã –∏–ª–∏ —Å–µ—Ä–≤–∏—Å—ã —è–¥—Ä–∞
   - –î–æ–±–∞–≤–ª—è—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –ª–∏—Ü–µ–Ω–∑–∏—Ä–æ–≤–∞–Ω–∏—è –≤ —è–¥—Ä–æ
```

### 6.3. –†–∞—Å—à–∏—Ä—è–µ–º–æ—Å—Ç—å —á–µ—Ä–µ–∑ —Å–æ–±—ã—Ç–∏—è-—Ö—É–∫–∏

–°–æ–±—ã—Ç–∏—è –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è **—Ç–æ–ª—å–∫–æ –¥–ª—è –º–æ–¥—É–ª—å–Ω—ã—Ö —Ö—É–∫–æ–≤**, –∞ –Ω–µ –≤–Ω—É—Ç—Ä–∏ –æ–±—ã—á–Ω–æ–≥–æ CRUD.

**–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–æ–±—ã—Ç–∏—è:**
- –ú–æ–¥—É–ª—å —Ö–æ—á–µ—Ç –æ—Ç—Ä–µ–∞–≥–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ –¥–µ–π—Å—Ç–≤–∏–µ —è–¥—Ä–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∑–∞–ø–∏—Å—å DVR –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –ø–æ—Ç–æ–∫–∞)
- –Ø–¥—Ä–æ –Ω–µ –¥–æ–ª–∂–Ω–æ –∑–Ω–∞—Ç—å –æ –º–æ–¥—É–ª–µ

**–ö–æ–≥–¥–∞ –ù–ï –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:**
- –í–Ω—É—Ç—Ä–∏ CRUD-–æ–ø–µ—Ä–∞—Ü–∏–π (—Å–æ–∑–¥–∞–ª –ø–æ—Ç–æ–∫ ‚Üí –æ–±–Ω–æ–≤–∏–ª nginx) ‚Äî —ç—Ç–æ –ø—Ä—è–º–æ–π –≤—ã–∑–æ–≤ –≤ Service
- –ú–µ–∂–¥—É —è–¥–µ—Ä–Ω—ã–º–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏ (—ç—Ç–æ –º–∞–≥–∏—è, –∫–æ—Ç–æ—Ä—É—é —Å–ª–æ–∂–Ω–æ –æ—Ç–ª–∞–¥–∏—Ç—å)

```php
// ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û ‚Äî —Å–æ–±—ã—Ç–∏—è –¥–ª—è –º–æ–¥—É–ª—å–Ω—ã—Ö —Ö—É–∫–æ–≤:
// –Ø–¥—Ä–æ –ø—É–±–ª–∏–∫—É–µ—Ç:
$dispatcher->dispatch(new StreamStartedEvent($streamId));

// –ú–æ–¥—É–ª—å watch –ø–æ–¥–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è:
class WatchModule implements ModuleInterface {
    public function getEventSubscribers(): array {
        return [
            StreamStartedEvent::class => [WatchRecorder::class, 'onStreamStarted'],
        ];
    }
}

// ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û ‚Äî —Å–æ–±—ã—Ç–∏—è –≤–Ω—É—Ç—Ä–∏ CRUD:
class StreamService {
    public function create(array $data): int {
        $id = $this->repo->insert($data);
        // –ù–ï –Ω—É–∂–Ω–æ dispatch StreamCreatedEvent –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è nginx.
        // –ü—Ä–æ—Å—Ç–æ –≤—ã–∑–≤–∞—Ç—å $this->nginx->reload() –Ω–∞–ø—Ä—è–º—É—é.
        $this->nginx->reload();
        return $id;
    }
}
```

### 6.4. –ö–æ–º–º–µ—Ä—á–µ—Å–∫–∏–µ –º–æ–¥—É–ª–∏ (–±—É–¥—É—â–µ–µ)

–ö–æ–º–º–µ—Ä—á–µ—Å–∫–∏–µ –º–æ–¥—É–ª–∏ ‚Äî –æ–±—ã—á–Ω—ã–µ –º–æ–¥—É–ª–∏ –≤ `modules/`, –Ω–æ:
- –î–æ—Å—Ç–∞–≤–ª—è—é—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ (–Ω–µ –≤ –æ—Å–Ω–æ–≤–Ω–æ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏)
- –ú–æ–≥—É—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—É—é –ø—Ä–æ–≤–µ—Ä–∫—É –ª–∏—Ü–µ–Ω–∑–∏–∏ **–≤–Ω—É—Ç—Ä–∏ —Å–µ–±—è**
- –Ø–¥—Ä–æ **–Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç** –∫–æ–¥–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ª–∏—Ü–µ–Ω–∑–∏–∏ ‚Äî –µ—Å–ª–∏ –º–æ–¥—É–ª—å —É–¥–∞–ª—ë–Ω, —Å–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç

```
modules/
‚îú‚îÄ‚îÄ ministra/          ‚Üê open-source, –≤ –æ—Å–Ω–æ–≤–Ω–æ–º —Ä–µ–ø–æ
‚îú‚îÄ‚îÄ plex/              ‚Üê open-source, –≤ –æ—Å–Ω–æ–≤–Ω–æ–º —Ä–µ–ø–æ
‚îú‚îÄ‚îÄ enterprise-analytics/  ‚Üê –∫–æ–º–º–µ—Ä—á–µ—Å–∫–∏–π, –æ—Ç–¥–µ–ª—å–Ω—ã–π —Ä–µ–ø–æ
‚îÇ   ‚îú‚îÄ‚îÄ module.json
‚îÇ   ‚îú‚îÄ‚îÄ License.php        ‚Üê –ø—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏—Ü–µ–Ω–∑–∏–∏ –í–ù–£–¢–†–ò –º–æ–¥—É–ª—è
‚îÇ   ‚îî‚îÄ‚îÄ AnalyticsModule.php
‚îî‚îÄ‚îÄ advanced-security/     ‚Üê –∫–æ–º–º–µ—Ä—á–µ—Å–∫–∏–π, –æ—Ç–¥–µ–ª—å–Ω—ã–π —Ä–µ–ø–æ
```

---

## 7. –ì—Ä–∞–Ω–∏—Ü—ã —è–¥—Ä–∞ –∏ –º–æ–¥—É–ª–µ–π

### 7.1. –ü–∞–∫–µ—Ç–Ω–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

```
                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                    ‚îÇ  interfaces/ ‚îÇ   ‚Üê HTTP, CLI, Player
                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                           ‚îÇ depends on
              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
              ‚ñº            ‚ñº            ‚ñº
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚îÇ domain/  ‚îÇ ‚îÇstreaming/‚îÇ ‚îÇ modules/ ‚îÇ
        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
             ‚îÇ            ‚îÇ            ‚îÇ
             ‚îÇ depends on ‚îÇ depends on ‚îÇ depends on
             ‚ñº            ‚ñº            ‚ñº
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚îÇ             core/                ‚îÇ   ‚Üê Config, DB, Cache, Auth, Process,
        ‚îÇ                                  ‚îÇ     Logging, Events, Container, Util
        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                       ‚îÇ
                       ‚ñº
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚îÇ        infrastructure/           ‚îÇ   ‚Üê nginx, redis, bin, service
        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**–°—Ç—Ä–µ–ª–∫–∏ –≤—Å–µ–≥–¥–∞ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω—ã –≤–Ω–∏–∑.** –ù–∏ –æ–¥–∏–Ω –Ω–∏–∂–Ω–∏–π —Å–ª–æ–π –Ω–µ –∑–Ω–∞–µ—Ç –æ –≤–µ—Ä—Ö–Ω–∏—Ö.

**–ò—Å–∫–ª—é—á–µ–Ω–∏–µ:** `streaming/` ‚Äî –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π —Å–ª–æ–π –Ω–∞ —É—Ä–æ–≤–Ω–µ `domain/`, –Ω–æ —Å read-only –¥–æ—Å—Ç—É–ø–æ–º –∫ domain/Repository. –£ –Ω–µ–≥–æ —Å–≤–æ–π –ª—ë–≥–∫–∏–π entry path (—Å–º. ¬ß4.3).

### 7.2. –ß—Ç–æ –≤—Ö–æ–¥–∏—Ç –≤ —è–¥—Ä–æ, –∞ —á—Ç–æ –Ω–µ—Ç

| –í —è–¥—Ä–æ (`core/` + `domain/`) | –í –º–æ–¥—É–ª–∏ (`modules/`) |
|-------------------------------|----------------------|
| –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ—Ç–æ–∫–∞–º–∏ (CRUD, –∑–∞–ø—É—Å–∫, –æ—Å—Ç–∞–Ω–æ–≤–∫–∞) | Ministra portal |
| –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∞–º–∏ (–ª–∏–Ω–∏–∏, –ø–∞–∫–µ—Ç—ã) | Plex integration |
| –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ VOD (—Ñ–∏–ª—å–º—ã, —Å–µ—Ä–∏–∞–ª—ã) | TMDb metadata fetching |
| –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –∏ RBAC | Fingerprint watermarking |
| –°–µ—Ä–≤–µ—Ä–Ω–∞—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ | Theft detection |
| EPG (–±–∞–∑–æ–≤—ã–π –∏–º–ø–æ—Ä—Ç) | MAG device scanning |
| Bouquet management | Watch/DVR recording |
| –°—Ç—Ä–∏–º–∏–Ω–≥-–¥–≤–∏–∂–æ–∫ | Advanced analytics (–±—É–¥—É—â–µ–µ) |
| API (admin, reseller, player) | White-label theming (–±—É–¥—É—â–µ–µ) |

---

## 8. –í–∞—Ä–∏–∞–Ω—Ç—ã —Å–±–æ—Ä–∫–∏: MAIN vs LoadBalancer

### 8.1. –î–≤–∞ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞ –∏–∑ –æ–¥–Ω–æ–π –∫–æ–¥–æ–≤–æ–π –±–∞–∑—ã

–°–∏—Å—Ç–µ–º–∞ —Å–æ–±–∏—Ä–∞–µ—Ç—Å—è –≤ –¥–≤–∞ –≤–∞—Ä–∏–∞–Ω—Ç–∞ –∏–∑ –æ–¥–Ω–æ–≥–æ `src/`:

| –ê—Ä—Ç–µ—Ñ–∞–∫—Ç | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ | –ß—Ç–æ –≤–∫–ª—é—á–∞–µ—Ç | –ß—Ç–æ –∏—Å–∫–ª—é—á–∞–µ—Ç |
|----------|-----------|--------------|---------------|
| **MAIN** | –û—Å–Ω–æ–≤–Ω–æ–π —Å–µ—Ä–≤–µ—Ä (admin + streaming) | –í—Å—ë —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ `src/` | –ù–∏—á–µ–≥–æ |
| **LoadBalancer (LB)** | –°—Ç—Ä–∏–º–∏–Ω–≥-—Å–µ—Ä–≤–µ—Ä –±–µ–∑ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è | –¢–æ–ª—å–∫–æ —Å—Ç—Ä–∏–º–∏–Ω–≥ + –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ | –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å, —Ä–µ—Å–µ–ª–ª–µ—Ä, player, ministra, admin-only –º–æ–¥—É–ª–∏ |

**–ö–ª—é—á–µ–≤–æ–π –ø—Ä–∏–Ω—Ü–∏–ø:** LB ‚Äî —ç—Ç–æ –ø–æ–¥–º–Ω–æ–∂–µ—Å—Ç–≤–æ MAIN. –ö–æ–¥ –Ω–µ —Ñ–æ—Ä–∫–∞–µ—Ç—Å—è, –∞ —Ñ–∏–ª—å—Ç—Ä—É–µ—Ç—Å—è –ø—Ä–∏ —Å–±–æ—Ä–∫–µ.

### 8.2. –¢–µ–∫—É—â–∞—è –ø—Ä–æ–±–ª–µ–º–∞ (–¥–æ –º–∏–≥—Ä–∞—Ü–∏–∏ Makefile)

`Makefile` —Å–æ–±–∏—Ä–∞–µ—Ç LB –∏–∑ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π (`LB_FILES`):

```makefile
# –¢–ï–ö–£–©–ò–ô (—É—Å—Ç–∞—Ä–µ–≤—à–∏–π) —Å–ø–∏—Å–æ–∫:
LB_FILES := bin config content crons includes signals tmp www status update service
```

**–≠—Ç–∏ –Ω–æ–≤—ã–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –ù–ï –≤—Ö–æ–¥—è—Ç –≤ LB_FILES –∏ –ù–ï –∫–æ–ø–∏—Ä—É—é—Ç—Å—è –≤ LB:**

| –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è / —Ñ–∞–π–ª | –ù—É–∂–µ–Ω LB? | –°—Ç–∞—Ç—É—Å |
|----|---|---|
| `autoload.php` | ‚úÖ –î–ê ‚Äî –±–µ–∑ –Ω–µ–≥–æ –Ω–æ–≤—ã–µ –∫–ª–∞—Å—Å—ã –Ω–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è | ‚ö† –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ LB |
| `bootstrap.php` | ‚úÖ –î–ê ‚Äî –µ–¥–∏–Ω–∞—è —Ç–æ—á–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ (CONTEXT_STREAM) | ‚ö† –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ LB |
| `core/` | ‚úÖ –î–ê ‚Äî Database, Cache, Auth, Config, Process, Http, Logging, Container, Util | ‚ö† –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ LB |
| `domain/` | ‚ö† –ß–ê–°–¢–ò–ß–ù–û ‚Äî Stream/, Server/, Bouquet/ –Ω—É–∂–Ω—ã; User/, Ticket/, Device/ ‚Äî –Ω–µ—Ç | ‚ö† –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ LB |
| `streaming/` | ‚úÖ –î–ê ‚Äî –≤–µ—Å—å —Å—Ç—Ä–∏–º–∏–Ω–≥-–¥–≤–∏–∂–æ–∫ | ‚ö† –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ LB |
| `infrastructure/` | ‚úÖ –î–ê ‚Äî redis/, nginx/ | ‚ö† –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ LB |
| `resources/` | ‚ö† –ß–ê–°–¢–ò–ß–ù–û ‚Äî data/error_codes.php –Ω—É–∂–µ–Ω; langs/ ‚Äî –Ω–µ—Ç | ‚ö† –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ LB |
| `data/` | ‚ö† –ß–ê–°–¢–ò–ß–ù–û ‚Äî runtime-–¥–∞–Ω–Ω—ã–µ —Å–æ–∑–¥–∞—é—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ | ‚ö† –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ LB |
| `interfaces/` | ‚ö† –ß–ê–°–¢–ò–ß–ù–û ‚Äî Cli/ —á–∞—Å—Ç–∏—á–Ω–æ –Ω—É–∂–µ–Ω | ‚ö† –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ LB |
| `modules/` | ‚ùå –ù–ï–¢ ‚Äî –≤—Å–µ —Ç–µ–∫—É—â–∏–µ –º–æ–¥—É–ª–∏ admin-only | ‚ö† –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ LB |
| `admin/` | ‚ùå –ù–ï–¢ | ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç |
| `ministra/` | ‚ùå –ù–ï–¢ | ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç |
| `player/` | ‚ùå –ù–ï–¢ | ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç |
| `reseller/` | ‚ùå –ù–ï–¢ | ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç |

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏–µ:** Proxy-–º–µ—Ç–æ–¥—ã –≤ `CoreUtilities.php` (–∫–æ—Ç–æ—Ä—ã–π IS –∫–æ–ø–∏—Ä—É–µ—Ç—Å—è –≤ LB —á–µ—Ä–µ–∑ `includes/`) –≤—ã–∑—ã–≤–∞—é—Ç –∫–ª–∞—Å—Å—ã –∏–∑ `core/` –∏ `domain/`, –Ω–æ —ç—Ç–∏ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç ‚Üí **LB-—Å–±–æ—Ä–∫–∞ –ª–æ–º–∞–µ—Ç—Å—è –ø—Ä–∏ –≤—ã–∑–æ–≤–µ –º–∏–≥—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∫–æ–¥–∞**.

### 8.3. –¶–µ–ª–µ–≤–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Makefile

#### –û–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π `LB_FILES`

```makefile
# –¶–ï–õ–ï–í–û–ô (–æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π) —Å–ø–∏—Å–æ–∫:
LB_FILES := autoload.php bootstrap.php \
    bin config content core crons data domain includes infrastructure \
    interfaces resources signals streaming tmp www status update service
```

#### –û–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π `LB_DIRS_TO_REMOVE`

```makefile
LB_DIRS_TO_REMOVE := \
    # –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∏—Å–∫–ª—é—á–µ–Ω–∏—è:
    bin/install \
    bin/redis \
    includes/langs \
    includes/api \
    includes/libs/resources \
    bin/nginx/conf/codes \
    # –ù–æ–≤—ã–µ –∏—Å–∫–ª—é—á–µ–Ω–∏—è –¥–ª—è —Ü–µ–ª–µ–≤–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã:
    admin \
    ministra \
    player \
    reseller \
    domain/User \
    domain/Ticket \
    domain/Device \
    interfaces/Http/Controllers/Admin \
    interfaces/Http/Controllers/Reseller \
    interfaces/Http/Views \
    interfaces/Player \
    modules/fingerprint \
    modules/magscan \
    modules/ministra \
    modules/plex \
    modules/theft-detection \
    modules/tmdb \
    modules/watch \
    resources/langs
```

#### –û–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π `LB_FILES_TO_REMOVE`

```makefile
LB_FILES_TO_REMOVE := \
    # –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ (–ø–æ–∫–∞ admin.php/admin_api.php –∂–∏–≤—É—Ç –≤ includes/):
    includes/admin_api.php \
    includes/admin.php \
    includes/reseller_api.php \
    # ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∏—Å–∫–ª—é—á–µ–Ω–∏—è ...
    # –ù–æ–≤—ã–µ:
    includes/cli/migrate.php \
    includes/cli/cache_handler.php \
    includes/cli/balancer.php \
    crons/backups.php \
    crons/cache_engine.php \
    crons/epg.php \
    crons/update.php \
    crons/providers.php \
    crons/root_mysql.php \
    crons/series.php \
    crons/tmdb.php \
    crons/tmdb_popular.php
```

### 8.4. –ß—Ç–æ LB –∏—Å–ø–æ–ª—å–∑—É–µ—Ç ‚Äî –∫–∞—Ä—Ç–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

```
www/stream/*.php ‚îÄ‚îÄ‚Üí bootstrap.php (CONTEXT_STREAM)
                         ‚îÇ
                         ‚îú‚îÄ‚îÄ‚Üí autoload.php (class map)
                         ‚îú‚îÄ‚îÄ‚Üí core/Config/         (–ø—É—Ç–∏, –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è)
                         ‚îú‚îÄ‚îÄ‚Üí core/Database/       (PDO-–æ–±—ë—Ä—Ç–∫–∞)
                         ‚îú‚îÄ‚îÄ‚Üí core/Cache/          (Redis + File –∫—ç—à)
                         ‚îú‚îÄ‚îÄ‚Üí core/Auth/           (BruteforceGuard)
                         ‚îú‚îÄ‚îÄ‚Üí core/Http/           (Request, RequestGuard)
                         ‚îú‚îÄ‚îÄ‚Üí core/Process/        (ProcessManager)
                         ‚îú‚îÄ‚îÄ‚Üí core/Logging/        (FileLogger, DatabaseLogger)
                         ‚îú‚îÄ‚îÄ‚Üí core/Util/           (GeoIP, NetworkUtils, Encryption)
                         ‚îú‚îÄ‚îÄ‚Üí core/Error/          (ErrorHandler, ErrorCodes)
                         ‚îÇ
                         ‚îú‚îÄ‚îÄ‚Üí streaming/Auth/      (TokenAuth, StreamAuth, DeviceLock)
                         ‚îú‚îÄ‚îÄ‚Üí streaming/Delivery/  (LiveDelivery, VodDelivery, SegmentReader)
                         ‚îú‚îÄ‚îÄ‚Üí streaming/Balancer/  (LoadBalancer, RedirectStrategy)
                         ‚îú‚îÄ‚îÄ‚Üí streaming/Protection/(RestreamDetector, ConnectionLimiter, GeoBlock)
                         ‚îú‚îÄ‚îÄ‚Üí streaming/Codec/     (FFmpegCommand, TsParser)
                         ‚îÇ
                         ‚îú‚îÄ‚îÄ‚Üí domain/Stream/       (StreamProcess, ConnectionTracker, StreamSorter)
                         ‚îú‚îÄ‚îÄ‚Üí domain/Server/       (ServerRepository)
                         ‚îú‚îÄ‚îÄ‚Üí domain/Bouquet/      (BouquetMapper ‚Äî –¥–ª—è –ø–ª–µ–π–ª–∏—Å—Ç–æ–≤)
                         ‚îú‚îÄ‚îÄ‚Üí domain/Vod/          (–¥–ª—è VOD-–¥–æ—Å—Ç–∞–≤–∫–∏)
                         ‚îÇ
                         ‚îú‚îÄ‚îÄ‚Üí infrastructure/redis/(RedisManager)
                         ‚îî‚îÄ‚îÄ‚Üí resources/data/      (error_codes.php)

crons/*.php (–Ω–∞ LB) ‚îÄ‚îÄ‚Üí bootstrap.php (CONTEXT_CLI)
                         ‚îî‚îÄ‚îÄ‚Üí —Ç–µ –∂–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ + domain/Stream/*
```

### 8.5. –ü—Ä–∞–≤–∏–ª–∞ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ —Å —É—á—ë—Ç–æ–º LB

1. **Proxy-–º–µ—Ç–æ–¥—ã –≤ `CoreUtilities`/`StreamingUtilities`** –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –±–µ–∑–æ–ø–∞—Å–Ω—ã –¥–ª—è LB. –ü–æ–∫–∞ `autoload.php` –∏ `core/`/`domain/` –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ LB-—Å–±–æ—Ä–∫—É, proxy-–≤—ã–∑–æ–≤—ã —Å–ª–æ–º–∞—é—Ç LB.

2. **Makefile –¥–æ–ª–∂–µ–Ω –æ–±–Ω–æ–≤–ª—è—Ç—å—Å—è —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ —Å –º–∏–≥—Ä–∞—Ü–∏–µ–π**, –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –Ω–æ–≤—ã—Ö `LB_FILES` –∫–∞–∂–¥—ã–π —Ä–∞–∑, –∫–æ–≥–¥–∞ –∫–æ–¥ –∏–∑ `includes/` –º–∏–≥—Ä–∏—Ä—É–µ—Ç –≤ –Ω–æ–≤—ã–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏.

3. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ LB-—Å–±–æ—Ä–∫–∏** ‚Äî –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–π —Ñ–∞–∑—ã –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä—è—Ç—å:
   ```bash
   make new && make lb
   # –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –≤—Å–µ –Ω—É–∂–Ω—ã–µ —Ñ–∞–π–ª—ã –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç
   # –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ admin-only —Ñ–∞–π–ª—ã –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç
   ```

4. **domain/ —á–∞—Å—Ç–∏—á–Ω–æ –Ω—É–∂–µ–Ω LB** ‚Äî –Ω–µ–ª—å–∑—è —Ü–µ–ª–∏–∫–æ–º –∏—Å–∫–ª—é—á–∞—Ç—å `domain/`. –ò—Å–∫–ª—é—á–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ admin-specific –ø–æ–¥–¥–æ–º–µ–Ω—ã (`User/`, `Ticket/`, `Device/`).

5. **modules/ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏—Å–∫–ª—é—á–∞–µ—Ç—Å—è –∏–∑ LB** ‚Äî –≤—Å–µ —Ç–µ–∫—É—â–∏–µ –º–æ–¥—É–ª–∏ (ministra, plex, tmdb, watch, fingerprint, theft-detection, magscan) ‚Äî —ç—Ç–æ admin-—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å. –í –±—É–¥—É—â–µ–º, –µ—Å–ª–∏ –ø–æ—è–≤–∏—Ç—Å—è LB-specific –º–æ–¥—É–ª—å, –µ–≥–æ –Ω—É–∂–Ω–æ –±—É–¥–µ—Ç —è–≤–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å.

### 8.6. –ü–µ—Ä–µ—Ö–æ–¥–Ω—ã–π –ø–µ—Ä–∏–æ–¥ (—Å–µ–π—á–∞—Å)

–ü–æ–∫–∞ –º–∏–≥—Ä–∞—Ü–∏—è –∏–¥—ë—Ç –∏—Ç–µ—Ä–∞—Ç–∏–≤–Ω–æ (—Ñ–∞–∑—ã 1-3 –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ), Makefile –Ω—É–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å **–Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ**:

**–ú–∏–Ω–∏–º–∞–ª—å–Ω–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ (`LB_FILES`):**
```makefile
LB_FILES := bin config content core crons domain includes \
    infrastructure resources signals streaming tmp www status update service
```

**–ü–ª—é—Å –¥–≤–∞ root-—Ñ–∞–π–ª–∞** ‚Äî `autoload.php` –∏ `bootstrap.php` ‚Äî –Ω—É–∂–Ω–æ –∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω–æ, —Ç.–∫. `LB_FILES` —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Å –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è–º–∏:
```makefile
lb_copy_files:
    # ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ ...
    @echo "==> [LB] Copying root files"
    @for root_file in autoload.php bootstrap.php; do \
        if [ -f "$(MAIN_DIR)/$$root_file" ]; then \
            cp "$(MAIN_DIR)/$$root_file" "$(TEMP_DIR)/$$root_file"; \
        fi; \
    done
```

---

## 9. –ü–æ—Ä—è–¥–æ–∫ –º–∏–≥—Ä–∞—Ü–∏–∏

### –ü—Ä–∏–Ω—Ü–∏–ø: –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ ‚Üí –¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ ‚Üí –∑–∞–º–µ–Ω–∞

–ö–∞–∂–¥—ã–π —à–∞–≥ –º–∏–≥—Ä–∞—Ü–∏–∏ —Å–ª–µ–¥—É–µ—Ç –æ–¥–Ω–æ–º—É –ø–∞—Ç—Ç–µ—Ä–Ω—É:

```
1. –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –∫–ª–∞—Å—Å –≤ —Ü–µ–ª–µ–≤–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
2. –ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ –≤ –Ω–µ–≥–æ –º–µ—Ç–æ–¥—ã –∏–∑ god-–æ–±—ä–µ–∫—Ç–∞
3. –í —Å—Ç–∞—Ä–æ–º —Ñ–∞–π–ª–µ –æ—Å—Ç–∞–≤–∏—Ç—å proxy-–º–µ—Ç–æ–¥:
     public static function oldMethod(...$args) {
         return NewClass::method(...$args);
     }
4. –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–ª–∞—Å—Å –≤ autoloader
5. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å: —Å–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ —Ä–∞–Ω—å—à–µ
6. (–ø–æ–∑–∂–µ) –û–±–Ω–æ–≤–∏—Ç—å –≤—ã–∑—ã–≤–∞—é—â–∏–π –∫–æ–¥ ‚Üí —É–¥–∞–ª–∏—Ç—å proxy
```

–¢–∞–∫ –∫–∞–∂–¥—ã–π —à–∞–≥ –±–µ–∑–æ–ø–∞—Å–µ–Ω –∏ –æ–±—Ä–∞—Ç–∏–º–æ —Å–æ–≤–º–µ—Å—Ç–∏–º.

---

### –§–∞–∑–∞ 0: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ ‚úÖ

1. ‚úÖ –ê–≤—Ç–æ–∑–∞–≥—Ä—É–∑—á–∏–∫ `src/autoload.php` ‚Äî –∫–∞—Ä—Ç–∞ –∫–ª–∞—Å—Å–æ–≤ + fallback spl_autoload
2. ‚úÖ –°–∫–µ–ª–µ—Ç –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π (98 –∫–∞—Ç–∞–ª–æ–≥–æ–≤)
3. ‚úÖ `bootstrap.php` ‚Äî XC_Bootstrap —Å 4 –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞–º–∏
4. ‚úÖ `core/Container/ServiceContainer.php` ‚Äî DI-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
5. ‚úÖ –†–∞–∑–±–∏–µ–Ω–∏–µ `www/constants.php` ‚Üí 7 core-—Ñ–∞–π–ª–æ–≤ + —Ç–æ–Ω–∫–∏–π —Ñ–∞—Å–∞–¥ (74 —Å—Ç—Ä–æ–∫–∏)
   - ‚úÖ `core/Config/Paths.php`, `AppConfig.php`, `Binaries.php`, `ConfigLoader.php`
   - ‚úÖ `core/Error/ErrorCodes.php`, `ErrorHandler.php`
   - ‚úÖ `core/Http/RequestGuard.php`
   - ‚úÖ `www/stream/init.php` ‚Üí –ø–æ–¥–∫–ª—é—á—ë–Ω autoload.php

---

### –§–∞–∑–∞ 1: –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ core/ (–±–∞–∑–æ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã)

#### 1.1 ‚úÖ Database
- ‚úÖ `core/Database/DatabaseHandler.php` (530 —Å—Ç—Ä.) ‚Üê `includes/Database.php`
- ‚úÖ `core/Database/Database.php` (299 —Å—Ç—Ä.) ‚Äî –ø–µ—Ä–µ–º–µ—â—ë–Ω –∏–∑ `includes/`
- ‚úÖ –í—Å–µ 20 —Ñ–∞–π–ª–æ–≤ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω—ã –Ω–∞ DatabaseHandler

#### 1.2 ‚úÖ Cache
- ‚úÖ `core/Cache/CacheInterface.php` (84 —Å—Ç—Ä.)
- ‚úÖ `core/Cache/FileCache.php` (229 —Å—Ç—Ä.) ‚Üê `CoreUtilities::getCache/setCache`
- ‚úÖ `core/Cache/RedisCache.php` (262 —Å—Ç—Ä.)

#### 1.3 ‚úÖ Http / Request
- ‚úÖ `core/Http/Request.php` (449 —Å—Ç—Ä.) ‚Üê `cleanGlobals()` + `parseIncomingRecursively()`
- ‚úÖ `core/Http/Response.php` (139 —Å—Ç—Ä.)

#### 1.4 ‚úÖ Auth
- ‚úÖ `core/Auth/SessionManager.php` (305 —Å—Ç—Ä.) ‚Üê –∏–∑ –¥–≤—É—Ö `session.php`

#### 1.5 ‚úÖ Process
- ‚úÖ `core/Process/ProcessManager.php` (366 —Å—Ç—Ä.) ‚Üê shell_exec/posix_kill

#### 1.6 ‚úÖ Util
- ‚úÖ `core/Util/GeoIP.php` (159 —Å—Ç—Ä.) ‚Üê `CoreUtilities`
- ‚úÖ `core/Util/Encryption.php` (137 —Å—Ç—Ä.) ‚Üê `CoreUtilities`
- ‚úÖ `core/Util/TimeUtils.php` (114 —Å—Ç—Ä.) ‚Üê `CoreUtilities` + `admin.php::secondsToTime()`
- ‚úÖ `core/Util/NetworkUtils.php` (129 —Å—Ç—Ä.) ‚Üê IP/CIDR/subnet –∏–∑ `CoreUtilities`

---

### –§–∞–∑–∞ 1.7: –û—Å—Ç–∞–≤—à–∏–µ—Å—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è core/

**–ò–∑ `CoreUtilities.php` (4847 —Å—Ç—Ä–æ–∫) ‚Üí –Ω–æ–≤—ã–µ –∫–ª–∞—Å—Å—ã:**

#### –®–∞–≥ 1.7.1 ‚Äî –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ ‚úÖ
- ‚úÖ –ò–∑–≤–ª–µ—á—å `saveLog()` (—Å—Ç—Ä. 489‚Äì504) ‚Üí `FileLogger::log()`
- ‚úÖ –ò–∑–≤–ª–µ—á—å `clientLog()` (StUtil —Å—Ç—Ä. 1169‚Äì1177) ‚Üí `DatabaseLogger::log()`
- ‚úÖ –ù–∞–ø–∏—Å–∞—Ç—å `LoggerInterface` —Å –º–µ—Ç–æ–¥–æ–º `log($type, $message, $extra)`
- ‚úÖ Proxy: `CoreUtilities::saveLog()` ‚Üí `FileLogger::log()`
- ‚úÖ Proxy: `StreamingUtilities::clientLog()` ‚Üí `DatabaseLogger::log()`

#### –®–∞–≥ 1.7.2 ‚Äî –°–∏—Å—Ç–µ–º–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è ‚úÖ
- ‚úÖ –ò–∑–≤–ª–µ—á—å 9 –º–µ—Ç–æ–¥–æ–≤ (—Å—Ç—Ä. 534‚Äì671, 827‚Äì852, 1338‚Äì1344, 4621‚Äì4665) ‚Üí `SystemInfo`
- ‚úÖ Proxy: –∫–∞–∂–¥—ã–π –≤—ã–∑–æ–≤ `CoreUtilities::getStats()` ‚Üí `SystemInfo::getStats()`

#### –®–∞–≥ 1.7.3 ‚Äî –ó–∞—â–∏—Ç–∞ –æ—Ç –±—Ä—É—Ç—Ñ–æ—Ä—Å–∞ (Flood/Bruteforce) ‚úÖ
- ‚úÖ –ò–∑–≤–ª–µ—á—å 4 –º–µ—Ç–æ–¥–∞ –∏–∑ CoreUtilities (—Å—Ç—Ä. 709‚Äì826) ‚Üí `BruteforceGuard`
- ‚úÖ 4 –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –º–µ—Ç–æ–¥–∞ –≤ StreamingUtilities (—Å—Ç—Ä. 215‚Äì394) ‚Üí proxy –Ω–∞ —Ç–æ—Ç –∂–µ `BruteforceGuard`
- ‚úÖ –ü–µ—Ä–≤–∞—è –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è CoreUtilities ‚Üî StreamingUtilities

#### –®–∞–≥ 1.7.4 ‚Äî HTTP-–∫–ª–∏–µ–Ω—Ç (cURL) ‚úÖ
- ‚úÖ –ò–∑–≤–ª–µ—á—å 3 –º–µ—Ç–æ–¥–∞ (—Å—Ç—Ä. 373‚Äì428, 1408‚Äì1442, 3568‚Äì3578) ‚Üí `CurlClient`

#### –®–∞–≥ 1.7.5 ‚Äî –°–æ–±—ã—Ç–∏–π–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ ‚úÖ
- ‚úÖ –ù–∞–ø–∏—Å–∞—Ç—å –ø—Ä–æ—Å—Ç–æ–π EventDispatcher (publish/subscribe)
- ‚úÖ –ü–æ–∫–∞ –±–µ–∑ –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤ ‚Äî –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –º–æ–¥—É–ª—å–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ

#### –®–∞–≥ 1.7.6 ‚Äî RBAC / –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è ‚úÖ
- ‚úÖ –ò–∑–≤–ª–µ—á—å `hasPermissions()` (—Å—Ç—Ä. 582‚Äì619) –∏ `hasResellerPermissions()` (—Å—Ç—Ä. 575‚Äì581)
- ‚úÖ –ú–∞—Å—Å–∏–≤ `$rAdvPermissions` ‚Üí `resources/data/permissions.php`
- ‚úÖ Proxy: –≥–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –≤ `admin.php` ‚Üí `Authorization::check()`

#### –®–∞–≥ 1.7.7 ‚Äî –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è ‚úÖ
- ‚úÖ –ò–∑–≤–ª–µ—á—å `processLogin()` –∏–∑ `admin_api.php` (—Å—Ç—Ä. 1399‚Äì1478) ‚Üí `Authenticator::login()`
- ‚úÖ –ò–∑–≤–ª–µ—á—å `processLogin()` –∏–∑ `reseller_api.php` ‚Üí `Authenticator::resellerLogin()`
- ‚úÖ Proxy: `API::processLogin()` ‚Üí `Authenticator::login()`

#### –®–∞–≥ 1.7.8 ‚Äî –£—Ç–∏–ª–∏—Ç—ã –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π ‚úÖ
- ‚úÖ –ò–∑–≤–ª–µ—á—å –º–µ—Ç–æ–¥—ã —Ä–∞–±–æ—Ç—ã —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏ (resize, thumbnail, URL-–≤–∞–ª–∏–¥–∞—Ü–∏—è)
- ‚úÖ `StreamingUtilities::validateImage()` (—Å—Ç—Ä. 1355) ‚Üí `ImageUtils::validateURL()`
- ‚úÖ `admin.php::getAdminImage()` (—Å—Ç—Ä. 871‚Äì883) ‚Üí `ImageUtils::resize()`

---

### –§–∞–∑–∞ 2: –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è CoreUtilities ‚Üî StreamingUtilities ‚úÖ

–§–æ—Ä–∫ —É—Å—Ç—Ä–∞–Ω—ë–Ω. 53 –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –º–µ—Ç–æ–¥–∞ –¥–µ–¥—É–ø–ª–∏—Ü–∏—Ä–æ–≤–∞–Ω—ã.

#### –®–∞–≥ 2.1 ‚Äî –ò–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—è –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ ‚úÖ

–ò–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∞: **53 –æ–±—â–∏—Ö –º–µ—Ç–æ–¥–∞** –º–µ–∂–¥—É CoreUtilities –∏ StreamingUtilities.
–í—Å–µ –º–µ—Ç–æ–¥—ã —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω—ã –ø–æ —à–∞–≥–∞–º 2.2‚Äì2.5 –∏ —É—Å–ø–µ—à–Ω–æ –¥–µ–¥—É–ø–ª–∏—Ü–∏—Ä–æ–≤–∞–Ω—ã.

#### –®–∞–≥ 2.2 ‚Äî Redis –∏ —Å–∏–≥–Ω–∞–ª—ã ‚úÖ
- ‚úÖ –ò–∑–≤–ª–µ—á—å Redis-–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –≤ `RedisManager` (–µ–¥–∏–Ω—ã–π –¥–ª—è –æ–±–æ–∏—Ö)
- ‚úÖ Proxy: –æ–±–∞ –∫–ª–∞—Å—Å–∞ –≤—ã–∑—ã–≤–∞—é—Ç `RedisManager::connect()`
- ‚úÖ `getDomainName()` ‚Üí `DomainResolver::resolve()` (—á–∏—Å—Ç–∞—è —É—Ç–∏–ª–∏—Ç–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏)

#### –®–∞–≥ 2.3 ‚Äî –¢—Ä–µ–∫–∏–Ω–≥ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π (Redis) ‚úÖ
- ‚úÖ ~17 –º–µ—Ç–æ–¥–æ–≤ –≤—ã–Ω–µ—Å–µ–Ω—ã –≤ `ConnectionTracker` (—Ä–∞–±–æ—Ç–∞ —Å Redis-–∫–ª—é—á–∞–º–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π)
- ‚úÖ Proxy: –æ–±–∞ god-–æ–±—ä–µ–∫—Ç–∞ –¥–µ–ª–µ–≥–∏—Ä—É—é—Ç –≤ `ConnectionTracker`

#### –®–∞–≥ 2.4 ‚Äî –°–ø—Ä–∞–≤–æ—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ ‚úÖ
- ‚úÖ –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—ã–Ω–µ—Å–µ–Ω—ã –≤ `StreamSorter`
- ‚úÖ –î–∞–Ω–Ω—ã–µ-—Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏ –≤—ã–Ω–µ—Å–µ–Ω—ã –≤ `BouquetMapper` / `CategoryRepository` / `BouquetRepository` / `ServerRepository` / `SettingsRepository`

#### –®–∞–≥ 2.5 ‚Äî –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è init() ‚úÖ
- ‚úÖ –û–±–∞ `init()` —Å—Ç–∞–ª–∏ —Ç–æ–Ω–∫–∏–º–∏ –æ–±—ë—Ä—Ç–∫–∞–º–∏
- ‚úÖ –û–±—â–∞—è –ª–æ–≥–∏–∫–∞ –≤—ã–Ω–µ—Å–µ–Ω–∞ –≤ `core/Init/LegacyInitializer.php`
- ‚úÖ –°–æ—Å—Ç–æ—è–Ω–∏–µ init —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç—Å—è —á–µ—Ä–µ–∑ `ServiceContainer`

---

### –§–∞–∑–∞ 3: –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ domain/ ‚Äî –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ ‚úÖ

–í—Å–µ entity/repository/service –∏–∑–≤–ª–µ—á–µ–Ω—ã –∏–∑ god-–æ–±—ä–µ–∫—Ç–æ–≤. Proxy-–º–µ—Ç–æ–¥—ã –æ—Å—Ç–∞–≤–ª–µ–Ω—ã –≤ –∏—Å—Ö–æ–¥–Ω—ã—Ö —Ñ–∞–π–ª–∞—Ö.

#### –®–∞–≥ 3.1 ‚Äî domain/Stream/ ‚úÖ
- `StreamService.php` ‚Äî processStream, massEdit, massDelete, move, replaceDNS ‚Üê admin_api.php
- `ChannelService.php` ‚Äî processChannel, massEdit, setOrder ‚Üê admin_api.php
- `CategoryService.php` ‚Äî processCategory, orderCategories ‚Üê admin_api.php
- `StreamRepository.php` ‚Äî getStream, getStreamStats, getStreamErrors, getStreamPIDs, getStreamOptions, getStreamSys, getNextOrder ‚Üê admin.php
- `CategoryRepository.php` ‚Äî getCategories ‚Üê admin.php
- `M3UParser.php` ‚Äî parseM3U ‚Üê admin.php
- `StreamProcess.php` ‚Äî startMonitor, stopStream, startProxy, startThumbnail, queueChannel, createChannel, updateStream(s), createChannelItem, startMovie, stopMovie, startLoopback, queueMovie(s), refreshMovies, startStream, startLLOD ‚Üê CoreUtilities

#### –®–∞–≥ 3.2 ‚Äî domain/Vod/ ‚úÖ
- `MovieService.php` ‚Äî process, massEdit, massDelete, import ‚Üê admin_api.php
- `SeriesService.php` ‚Äî process, massEdit, massDelete, import ‚Üê admin_api.php
- `EpisodeService.php` ‚Äî process, massEdit, massDelete ‚Üê admin_api.php
- `SeriesRepository.php` ‚Äî getList, updateFromTMDB, queueRefresh, getSimilar, generatePlaylist ‚Üê admin.php
- `MovieRepository.php` ‚Äî getSimilar, deleteFile ‚Üê admin.php

#### –®–∞–≥ 3.3 ‚Äî domain/Line/ ‚úÖ
- `LineService.php` ‚Äî process, massEdit, massDelete, delete, update (–æ–¥–∏–Ω–æ—á–Ω—ã–µ –∏ –º–∞—Å—Å–æ–≤—ã–µ) ‚Üê admin_api.php + CoreUtilities
- `LineRepository.php` ‚Äî deleteMany ‚Üê admin.php

#### –®–∞–≥ 3.4 ‚Äî domain/User/ ‚úÖ
- `UserService.php` ‚Äî process, massEdit, massDelete ‚Üê admin_api.php
- `GroupService.php` ‚Äî process ‚Üê admin_api.php
- `ProfileService.php` ‚Äî editAdminProfile ‚Üê admin_api.php
- `UserRepository.php` ‚Äî getUserInfo, getUser, getRegisteredUser(s), getResellers, getDirectReports, getSubUsers, getParent, getStreamingUserInfo ‚Üê admin.php + StreamingUtilities
- `GroupRepository.php` ‚Äî getAll, getById, deleteById ‚Üê admin.php

#### –®–∞–≥ 3.5 ‚Äî domain/Device/ ‚úÖ
- `MagService.php` ‚Äî process, massEdit, massDelete ‚Üê admin_api.php
- `EnigmaService.php` ‚Äî process, massEdit, massDelete ‚Üê admin_api.php
- `DeviceSync.php` ‚Äî syncLineDevices ‚Üê admin.php

#### –®–∞–≥ 3.6 ‚Äî domain/Server/ ‚úÖ
- `ServerService.php` ‚Äî process, processProxy, install, reorder ‚Üê admin_api.php
- `ServerRepository.php` ‚Äî getAllSimple, getStreamingSimple, getProxySimple, getFreeSpace, getStreamsRamdisk, killPID, getRTMPStats, deleteById, probeSource, getSSLLog, checkSource, freeTemp, freeStreams ‚Üê admin.php

#### –®–∞–≥ 3.7 ‚Äî domain/Bouquet/ ‚úÖ
- `BouquetService.php` ‚Äî process, reorder, sort, scan, scanOne ‚Üê admin_api.php + admin.php
- `BouquetRepository.php` ‚Äî getAllSimple, getOrder, getUserBouquets ‚Üê admin.php

#### –®–∞–≥ 3.8 ‚Äî domain/Epg/ ‚úÖ
- `EpgService.php` ‚Äî process, getChannelEpg ‚Üê admin_api.php + admin.php
- `EpgRepository.php` ‚Äî getById, findByName, getStreamEpg, getStreamsEpg, getProgramme, search ‚Üê admin.php + CoreUtilities

#### –®–∞–≥ 3.9 ‚Äî domain/Settings/ + domain/Ticket/ ‚úÖ
- `SettingsService.php` ‚Äî edit, editBackup, editCacheCron ‚Üê admin_api.php
- `TicketService.php` ‚Äî submit ‚Üê admin_api.php

#### –®–∞–≥ 3.10 ‚Äî domain/Security/ ‚úÖ
- `BlocklistService.php` ‚Äî processISP, processUA, blockIP, processRTMPIP, checkBlockedUAs, checkISP, checkServer ‚Üê admin_api.php + StreamingUtilities
- `BlocklistRepository.php` ‚Äî getBlockedIPsSimple, getRTMPIPsSimple, getBlockedUA, getBlockedIPs, getBlockedISP, getBlockedServers, getProxyIPs ‚Üê admin.php + CoreUtilities

#### –®–∞–≥ 3.11 ‚Äî domain/Auth/ ‚úÖ
- `CodeService.php` ‚Äî process ‚Üê admin_api.php
- `HMACService.php` ‚Äî process ‚Üê admin_api.php
- `PackageService.php` ‚Äî process ‚Üê admin_api.php (–≤ domain/Line/)
- `CodeRepository.php` ‚Äî getActiveCodes, updateCodes, getCurrentCode ‚Üê admin.php
- `HMACRepository.php` ‚Äî getAll, getById ‚Üê admin.php
- `PackageRepository.php` ‚Äî deleteById ‚Üê admin.php (–≤ domain/Line/)
- `HMACValidator.php` ‚Äî validate ‚Üê StreamingUtilities

#### –®–∞–≥ 3.12 ‚Äî Playlist-–≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä ‚úÖ
- `PlaylistGenerator.php` ‚Äî generate ‚Üê CoreUtilities (—Å–∞–º—ã–π –¥–ª–∏–Ω–Ω—ã–π –º–µ—Ç–æ–¥, live/vod/series/radio)
- `CronGenerator.php` ‚Äî generate ‚Üê CoreUtilities

---

### –§–∞–∑–∞ 4: –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ streaming/ (hot path) ‚úÖ

#### –®–∞–≥ 4.1 ‚Äî streaming/Auth/ ‚úÖ
- `StreamAuth.php` ‚Äî checkAccess, validateConnections ‚Üê auth.php + StreamingUtilities
- `TokenAuth.php` ‚Äî –ø–∞—Ä—Å–∏–Ω–≥ —Ç–æ–∫–µ–Ω–æ–≤
- `DeviceLock.php` ‚Äî –ø—Ä–∏–≤—è–∑–∫–∞ –∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤—É
- `ConnectionLimiter.php` ‚Äî closeConnections, closeRTMP ‚Üí Protection/

#### –®–∞–≥ 4.2 ‚Äî streaming/Delivery/ ‚úÖ
- `LiveDelivery.php` ‚Üê www/stream/live.php
- `StreamRedirector.php` ‚Äî redirectStream, showVideoServer
- `OffAirHandler.php` ‚Äî getOffAirVideo
- `HLSGenerator.php` ‚Äî generateHLS
- `SegmentReader.php` ‚Äî getLLODSegments
- `SignalSender.php` ‚Äî sendSignal
- `ProxySelector.php` ‚Üí Balancer/

#### –®–∞–≥ 4.3 ‚Äî streaming/Codec/ ‚úÖ
- `FFprobeRunner.php` ‚Äî probeStream, parseFFProbe
- `FFmpegCommand.php` ‚Äî —Å–±–æ—Ä–∫–∞ FFmpeg-–∫–æ–º–∞–Ω–¥
- `SubtitleExtractor.php` ‚Äî extractSubtitle

#### –®–∞–≥ 4.4 ‚Äî streaming/Protection/ + Health/ ‚úÖ
- `ConnectionLimiter.php` ‚Äî closeConnections
- `HealthChecker.php` ‚Äî isRunning
- `ProcessChecker.php` ‚Äî isPIDRunning, isPIDsRunning, checkPID
- `WatchdogMonitor.php` ‚Äî getWatchdog

#### –®–∞–≥ 4.5 ‚Äî streaming/StreamingBootstrap.php ‚úÖ
- –õ—ë–≥–∫–∏–π bootstrap –∑–∞–º–µ–Ω—è–µ—Ç `www/stream/init.php`
- –ó–∞–≥—Ä—É–∂–∞–µ—Ç: autoload ‚Üí constants ‚Üí Database ‚Üí Redis

---

### –§–∞–∑–∞ 5: –í—ã–Ω–µ—Å–µ–Ω–∏–µ –º–æ–¥—É–ª–µ–π

–ö–∞–∂–¥—ã–π –º–æ–¥—É–ª—å –∏–∑–≤–ª–µ–∫–∞–µ—Ç—Å—è –∞—Ç–æ–º–∞—Ä–Ω–æ ‚Äî —Å–∏—Å—Ç–µ–º–∞ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –±–µ–∑ –Ω–µ–≥–æ.

#### –®–∞–≥ 5.1 ‚Äî modules/plex/ ‚ö° (–≤ –ø—Ä–æ—Ü–µ—Å—Å–µ)

**–ó–∞–≤–µ—Ä—à–µ–Ω–æ:**
- ‚úÖ `PlexAuth.php` ‚Äî –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è (getPlexToken, checkPlexToken, cachePlexToken –∏ –¥—Ä.)
- ‚úÖ `PlexRepository.php` ‚Äî –¥–∞–Ω–Ω—ã–µ (getPlexServers, getPlexSections)
- ‚úÖ `PlexService.php` ‚Äî –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ (editPlexSettings, processPlexSync, forcePlex)
- ‚úÖ `PlexCron.php` ‚Äî –∫—Ä–æ–Ω —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ (Thread, Multithread, PlexCron::run())
- ‚úÖ `PlexItem.php` ‚Äî CLI –æ–±—Ä–∞–±–æ—Ç–∫–∞ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ (PlexItem::run())
- ‚úÖ `crons/plex.php` ‚Äî —Ç–æ–Ω–∫–∞—è –æ–±—ë—Ä—Ç–∫–∞ ‚Üí PlexCron::run()
- ‚úÖ `includes/cli/plex_item.php` ‚Äî —Ç–æ–Ω–∫–∞—è –æ–±—ë—Ä—Ç–∫–∞ ‚Üí PlexItem::run()
- ‚úÖ –í—Å–µ 5 –∫–ª–∞—Å—Å–æ–≤ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã –≤ autoload.php
- ‚úÖ `admin/settings_plex.php` ‚Üí modules/plex/views/ (–∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä + –≤—ã–Ω–µ—Å–µ–Ω–Ω—ã–π view/scripts)
- ‚úÖ `admin/plex_add.php` ‚Üí modules/plex/views/ (–∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä + –æ–±—â–∏–µ view/scripts)
- ‚úÖ `admin/plex.php` ‚Üí modules/plex/views/ (–∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä + —Å–ø–∏—Å–æ–∫ –≤—ã–Ω–µ—Å–µ–Ω –≤ view)
- ‚úÖ `config/plex/` ‚Üí modules/plex/config/

**–û—Å—Ç–∞–ª–æ—Å—å:** ‚Äî

#### –®–∞–≥ 5.2 ‚Äî modules/watch/
- ‚úÖ `API::editWatchSettings()` ‚Üí modules/watch/WatchService.php
- ‚úÖ `API::processWatchFolder()` ‚Üí modules/watch/WatchService.php
- ‚úÖ `API::scheduleRecording()` ‚Üí modules/watch/RecordingService.php
- ‚úÖ `admin.php::getWatchFolders()` ‚Üí modules/watch/WatchController.php
- ‚úÖ `admin.php::getWatchCategories()` ‚Üí modules/watch/WatchController.php
- ‚úÖ `admin.php::forceWatch()` ‚Üí modules/watch/WatchController.php
- ‚úÖ `admin.php::getRecordings()` ‚Üí modules/watch/WatchController.php
- ‚úÖ `admin.php::deleteRecording()` ‚Üí modules/watch/WatchController.php
- ‚úÖ `admin/settings_watch.php` ‚Üí modules/watch/views/ (thin wrapper + view/scripts)
- ‚úÖ `admin/watch.php` ‚Üí modules/watch/views/ (thin wrapper + view/scripts)
- ‚úÖ `admin/watch_add.php` ‚Üí modules/watch/views/ (thin wrapper + view/scripts)
- ‚úÖ `admin/watch_output.php` ‚Üí modules/watch/views/ (thin wrapper + view/scripts)
- ‚úÖ `admin/record.php` ‚Üí modules/watch/views/ (thin wrapper + view/scripts)
- ‚úÖ `crons/watch.php` ‚Üí modules/watch/WatchCron.php (entry point + extracted class)
- ‚úÖ `includes/cli/watch_item.php` ‚Üí modules/watch/WatchItem.php (entry point + extracted class)
- ‚úÖ `WatchModule::registerCrons()` wired to WatchCron

**–û—Å—Ç–∞–ª–æ—Å—å:** ‚Äî

#### –®–∞–≥ 5.3 ‚Äî modules/tmdb/
- ‚úÖ `admin/api.php::tmdb_search` ‚Üí modules/tmdb/TmdbService.php (search)
- ‚úÖ `admin/api.php::tmdb` ‚Üí modules/tmdb/TmdbService.php (getDetails)
- ‚úÖ `crons/tmdb.php` ‚Üí modules/tmdb/TmdbCron.php (entry point + extracted class)
- ‚úÖ `crons/tmdb_popular.php` ‚Üí modules/tmdb/TmdbPopularCron.php (entry point + extracted class)
- ‚úÖ `TmdbModule.php` ‚Äî registerCrons() wired (TmdbCron + TmdbPopularCron)
- ‚úÖ `includes/libs/TMDb/` ‚Üí modules/tmdb/lib.php (proxy loader, lib stays in place)

**–û—Å—Ç–∞–ª–æ—Å—å:** ‚Äî

#### –®–∞–≥ 5.4 ‚Äî modules/ministra/
- ‚úÖ `ministra/portal.php` (2156 —Å—Ç—Ä–æ–∫) ‚Üí PortalHandler.php (15 —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤, ~1345 —Å—Ç—Ä–æ–∫)
- ‚úÖ `ministra/portal.php` helper functions ‚Üí PortalHelpers.php (19 —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö –º–µ—Ç–æ–¥–æ–≤, ~860 —Å—Ç—Ä–æ–∫)
- ‚úÖ `MinistraModule.php` ‚Äî —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –º–æ–¥—É–ª—è (standalone endpoint, –±–µ–∑ cron/routes)
- ‚úÖ `ministra/portal.php` ‚Üí —Ç–æ–Ω–∫–∞—è –æ–±—ë—Ä—Ç–∫–∞: init/auth ‚Üí PortalHandler (269 —Å—Ç—Ä–æ–∫ + —Ö–µ–ª–ø–µ—Ä—ã + –∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ä–∏–≥–∏–Ω–∞–ª)
- üî≤ `ministra/*.js` ‚Üí modules/ministra/assets/ (JS-—Ñ–∞–π–ª—ã –ø–æ—Ä—Ç–∞–ª–∞ ‚Äî –æ—Ç–ª–æ–∂–µ–Ω–æ)

**–û—Å—Ç–∞–ª–æ—Å—å:** JS-–∞—Å—Å–µ—Ç—ã (–æ—Ç–ª–æ–∂–µ–Ω–æ –¥–æ –§–∞–∑—ã 6)

#### –®–∞–≥ 5.5 ‚Äî modules/fingerprint/ + modules/theft-detection/ + modules/magscan/
- ‚úÖ `FingerprintModule.php` ‚Äî –º–æ–¥—É–ª—å Fingerprint Stream (–≤—ã–±–æ—Ä –ø–æ—Ç–æ–∫–∞ + –Ω–∞–ª–æ–∂–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ + —Ç–∞–±–ª–∏—Ü–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏)
- ‚úÖ `TheftDetectionModule.php` ‚Äî –º–æ–¥—É–ª—å –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è –∫—Ä–∞–∂–∏ VOD (—Ç–∞–±–ª–∏—Ü–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤, –¥–∞–Ω–Ω—ã–µ –∏–∑ cache_engine)
- ‚úÖ `MagscanModule.php` ‚Äî –º–æ–¥—É–ª—å –Ω–∞—Å—Ç—Ä–æ–µ–∫ MAGSCAN (–±–µ–ª—ã–µ/—á—ë—Ä–Ω—ã–µ —Å–ø–∏—Å–∫–∏ MAC + IP)
- ‚úÖ `module.json` √ó 3 ‚Äî –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª–µ–π
- ‚úÖ `config/modules.php` ‚Äî –≤—Å–µ 3 –º–æ–¥—É–ª—è —Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω—ã –∏ –≤–∫–ª—é—á–µ–Ω—ã

**–ò—Å—Ç–æ—á–Ω–∏–∫–∏:**
```
admin/fingerprint.php (330 —Å—Ç—Ä.) ‚Äî UI-—Å—Ç—Ä–∞–Ω–∏—Ü–∞, API: fingerprint + line_activity
admin/theft_detection.php (239 —Å—Ç—Ä.) ‚Äî UI-—Å—Ç—Ä–∞–Ω–∏—Ü–∞, –¥–∞–Ω–Ω—ã–µ: CACHE_TMP_PATH/theft_detection
admin/magscan_settings.php (301 —Å—Ç—Ä.) ‚Äî UI-—Å—Ç—Ä–∞–Ω–∏—Ü–∞, POST: submit_magscan
```

#### –®–∞–≥ 5.6 ‚Äî ModuleInterface + –∑–∞–≥—Ä—É–∑—á–∏–∫ –º–æ–¥—É–ª–µ–π
- ‚úÖ `core/Module/ModuleInterface.php` ‚Äî –∫–æ–Ω—Ç—Ä–∞–∫—Ç –º–æ–¥—É–ª—è (111 —Å—Ç—Ä–æ–∫): getName, getVersion, boot, registerRoutes, registerCrons, getEventSubscribers
- ‚úÖ `core/Module/ModuleLoader.php` ‚Äî –∑–∞–≥—Ä—É–∑—á–∏–∫ –º–æ–¥—É–ª–µ–π (243 —Å—Ç—Ä–æ–∫–∏): loadAll, load, checkDependencies, isLoaded, getModule
- ‚úÖ `config/modules.php` ‚Äî –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –º–æ–¥—É–ª–µ–π: plex, watch, fingerprint, theft-detection, magscan (enabled), tmdb, ministra (commented)

---

#### –ê—É–¥–∏—Ç –§–∞–∑—ã 5 ‚úÖ
–ü—Ä–æ–≤–µ–¥–µ–Ω–∞ –ø–æ–ª–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö —Ñ–∞–π–ª–æ–≤ –§–∞–∑—ã 5. –ù–∞–π–¥–µ–Ω–æ –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:
- **–ö–†–ò–¢–ò–ß–ï–°–ö–û–ï**: `Thread`/`Multithread` –¥—É–±–ª–∏—Ä–æ–≤–∞–ª–∏—Å—å –≤ 3 —Ñ–∞–π–ª–∞—Ö (PlexCron, WatchCron, cache_engine) ‚Üí –≤—ã–Ω–µ—Å–µ–Ω—ã –≤ `core/Process/Thread.php` + `core/Process/Multithread.php`, –≤—Å–µ 3 —Ñ–∞–π–ª–∞ –ø–µ—Ä–µ–≤–µ–¥–µ–Ω—ã –Ω–∞ `require_once`
- **autoload.php**: –¥–æ–±–∞–≤–ª–µ–Ω—ã 14 –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏—Ö –∑–∞–ø–∏—Å–µ–π (WatchCron, WatchItem, Tmdb*, Ministra*, Fingerprint*, TheftDetection*, Magscan*, Thread, Multithread)
- **module.json**: —Å–æ–∑–¥–∞–Ω—ã –¥–ª—è `tmdb` –∏ `ministra` (–æ—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞–ª–∏)
- **config/modules.php**: `tmdb` –∏ `ministra` —Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω—ã –∏ –≤–∫–ª—é—á–µ–Ω—ã (–±—ã–ª–∏ `enabled => false`)

---

### –§–∞–∑–∞ 6: –ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã –∏ Views (admin/reseller) ‚ö° (–≤ –ø—Ä–æ—Ü–µ—Å—Å–µ)

–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ü–û–°–õ–ï –∏–∑–≤–ª–µ—á–µ–Ω–∏—è domain/ ‚Äî –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã –≤—ã–∑—ã–≤–∞—é—Ç —Å–µ—Ä–≤–∏—Å—ã.

#### –®–∞–≥ 6.1 ‚Äî –ï–¥–∏–Ω—ã–π layout
```
admin/header.php (675 —Å—Ç—Ä.) + reseller/header.php (284 —Å—Ç—Ä.)
                            ‚Üí interfaces/Http/Views/layouts/admin.php

admin/footer.php (804 —Å—Ç—Ä.) + reseller/footer.php (719 —Å—Ç—Ä.)
                            ‚Üí interfaces/Http/Views/layouts/footer.php
                            + assets/admin/js/*.js (–≤—ã–Ω–µ—Å–µ–Ω–Ω—ã–π inline JS)
```

**–°–¥–µ–ª–∞–Ω–æ (—Å—Ç–∞—Ä—Ç —à–∞–≥–∞ 6.1):**
- ‚úÖ –°–æ–∑–¥–∞–Ω `interfaces/Http/Views/layouts/admin.php` ‚Äî unified header wrapper (`renderUnifiedLayoutHeader`)
- ‚úÖ –°–æ–∑–¥–∞–Ω `interfaces/Http/Views/layouts/footer.php` ‚Äî unified footer wrapper (`renderUnifiedLayoutFooter`)
- ‚úÖ –£–¥–∞–ª—ë–Ω `interfaces/Http/Views/layouts/.gitkeep`
- ‚úÖ –ü–µ—Ä–µ–≤–µ–¥–µ–Ω—ã –Ω–∞ unified wrappers (–ø–∏–ª–æ—Ç):
    - `admin/fingerprint.php`
    - `admin/magscan_settings.php`
    - `admin/theft_detection.php`
- ‚úÖ –ü–µ—Ä–µ–≤–µ–¥–µ–Ω—ã –Ω–∞ unified wrappers (–≥—Ä—É–ø–ø–∞ F ‚Äî –Ω–∞—Å—Ç—Ä–æ–π–∫–∏):
    - `admin/settings.php`
    - `admin/profile.php`
    - `admin/edit_profile.php`
- ‚úÖ –ü–µ—Ä–µ–≤–µ–¥–µ–Ω—ã –Ω–∞ unified wrappers (–≥—Ä—É–ø–ø–∞ E ‚Äî –±—É–∫–µ—Ç—ã):
    - `admin/bouquets.php`
    - `admin/bouquet.php`
    - `admin/bouquet_order.php`
    - `admin/bouquet_sort.php`
- ‚úÖ –ü–µ—Ä–µ–≤–µ–¥–µ–Ω—ã –Ω–∞ unified wrappers (–≥—Ä—É–ø–ø–∞ D ‚Äî —Å–µ—Ä–≤–µ—Ä—ã):
    - `admin/servers.php`
    - `admin/server.php`
    - `admin/server_view.php`
    - `admin/server_install.php`
- ‚úÖ –ü–µ—Ä–µ–≤–µ–¥–µ–Ω—ã –Ω–∞ unified wrappers (–≥—Ä—É–ø–ø–∞ C ‚Äî –ª–∏–Ω–∏–∏/—É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞):
    - `admin/lines.php`
    - `admin/line.php`
    - `admin/mags.php`
    - `admin/mag.php`
    - `admin/enigmas.php`
    - `admin/enigma.php`
- ‚úÖ –ü–µ—Ä–µ–≤–µ–¥–µ–Ω—ã –Ω–∞ unified wrappers (–≥—Ä—É–ø–ø–∞ B ‚Äî VOD):
    - `admin/movies.php`
    - `admin/movie.php`
    - `admin/series.php`
    - `admin/serie.php`
    - `admin/episodes.php`
    - `admin/episode.php`
- ‚úÖ –ü–µ—Ä–µ–≤–µ–¥–µ–Ω—ã –Ω–∞ unified wrappers (–≥—Ä—É–ø–ø–∞ A ‚Äî –ø–æ—Ç–æ–∫–∏):
    - `admin/streams.php`
    - `admin/stream.php`
    - `admin/stream_view.php`
    - `admin/created_channel.php`
    - `admin/created_channels.php`
- ‚úÖ –ü–µ—Ä–µ–≤–µ–¥–µ–Ω—ã –Ω–∞ unified wrappers (–≥—Ä—É–ø–ø–∞ G ‚Äî –æ—Å—Ç–∞–ª—å–Ω–æ–µ, –ø–∞–∫–µ—Ç 1):
    - `admin/archive.php`
    - `admin/dashboard.php`
    - `admin/epg.php`
    - `admin/epgs.php`
    - `admin/group.php`
    - `admin/groups.php`
- ‚úÖ –ü–µ—Ä–µ–≤–µ–¥–µ–Ω—ã –Ω–∞ unified wrappers (–≥—Ä—É–ø–ø–∞ G ‚Äî –æ—Å—Ç–∞–ª—å–Ω–æ–µ, –ø–∞–∫–µ—Ç 2):
    - `admin/providers.php`
    - `admin/provider.php`
    - `admin/packages.php`
    - `admin/package.php`
    - `admin/profiles.php`
    - `admin/proxies.php`

**–î–∞–ª—å—à–µ –≤ 6.1:**
- üîÑ –ü–µ—Ä–µ–Ω–æ—Å –æ–±—â–∏—Ö CSS/JS-–±–ª–æ–∫–æ–≤ –∏–∑ `admin|reseller` –≤ –µ–¥–∏–Ω—ã–µ partials
- üîÑ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ `partials/header.php` + `partials/footer.php` –∫ layout system (—Å–µ–π—á–∞—Å –Ω–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è)
- ‚úÖ ~~–ü–æ—Å—Ç—Ä–∞–Ω–∏—á–Ω–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ include `header.php/footer.php` ‚Üí unified layout wrappers~~ ‚Äî –∑–∞–≤–µ—Ä—à–µ–Ω–æ

**Reseller –º–∏–≥—Ä–∞—Ü–∏—è –Ω–∞ unified wrappers:**
- ‚úÖ –ü–µ—Ä–µ–≤–µ–¥–µ–Ω—ã (—Ä–∞–Ω–µ–µ): `dashboard.php`, `streams.php`, `live_connections.php`, `user.php`, `users.php`, `user_logs.php`
- ‚úÖ –ü–µ—Ä–µ–≤–µ–¥–µ–Ω—ã (batch 2): `movies.php`, `enigma.php` (footer fix), `epg_view.php`, `enigmas.php`, `tickets.php`, `ticket_view.php`, `ticket.php`, `radios.php`, `mags.php`, `mag.php`, `line_activity.php`, `lines.php`, `line.php`, `episodes.php`, `created_channels.php`, `edit_profile.php`
- ‚ÑπÔ∏è –ù–µ —Ç—Ä–µ–±—É—é—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ (utility/support): `header.php`, `footer.php`, `functions.php`, `session.php`, `api.php`, `table.php`, `post.php`, `topbar.php`, `modals.php`, `resize.php`, `index.php`, `logout.php`
- ‚ÑπÔ∏è –û—Ç–¥–µ–ª—å–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ (—Å–≤–æ–π HTML): `login.php`
- **Admin: 112/112 page-—Ñ–∞–π–ª–æ–≤ ‚Äî 100% –º–∏–≥—Ä–∏—Ä–æ–≤–∞–Ω—ã**
- **Reseller: 22/22 page-—Ñ–∞–π–ª–æ–≤ ‚Äî 100% –º–∏–≥—Ä–∏—Ä–æ–≤–∞–Ω—ã**

#### –®–∞–≥ 6.2 ‚Äî Router + Front Controller
```
–ù–æ–≤—ã–π ‚Üí core/Http/Router.php
–ù–æ–≤—ã–π ‚Üí interfaces/Http/public/index.php (front controller)
–ù–æ–≤—ã–π ‚Üí interfaces/Http/routes/admin.php  (admin route definitions)
–ù–æ–≤—ã–π ‚Üí interfaces/Http/routes/api.php    (API route definitions)
```

**–°—Ç–∞—Ç—É—Å 6.2:** ‚úÖ –ó–∞–≤–µ—Ä—à—ë–Ω
- ‚úÖ `core/Http/Router.php` ‚Äî –ø–æ–ª–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è (450 —Å—Ç—Ä.): GET/POST/API routes, group(), middleware, permissions, dispatch(), dispatchApi(), singleton
  - **Fix: normalizePage()** ‚Äî `buildRoute()` —Ç–µ–ø–µ—Ä—å –≤—ã–∑—ã–≤–∞–µ—Ç `normalizePage()` –Ω–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ, —á—Ç–æ–±—ã –∫–ª—é—á–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ —Å–æ–≤–ø–∞–¥–∞–ª–∏ —Å –∫–ª—é—á–∞–º–∏ dispatch (rtmp_ips ‚Üí rtmp/ips)
  - **Fix: ServiceContainer DI** ‚Äî `callHandler()` —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `ServiceContainer::getInstance()->get($class)` —Å fallback –Ω–∞ `new $class()` –ø—Ä–∏ –æ—à–∏–±–∫–µ
- ‚úÖ `core/Http/Request.php` ‚Äî HTTP request wrapper (450 —Å—Ç—Ä.): capture(), input access, sanitization, backward compat
- ‚úÖ `core/Http/Response.php` ‚Äî HTTP response helper: json(), redirect(), notFound(), cors(), noCache()
- ‚úÖ `core/Http/RequestGuard.php` ‚Äî flood protection, host verification, Logger init
- ‚úÖ `interfaces/Http/public/index.php` ‚Äî Front Controller:
    - –¢—Ä—ë—Ö—Ä–µ–∂–∏–º–Ω—ã–π –ø–∞—Ä—Å–∏–Ω–≥ URL ‚Üí scope + pageName + accessCode:
      - **–†–µ–∂–∏–º A** (Access Code + XC_SCOPE): nginx –ø–µ—Ä–µ–¥–∞—ë—Ç scope —á–µ—Ä–µ–∑ `fastcgi_param XC_SCOPE`
      - **–†–µ–∂–∏–º B** (Direct URL): URL —Å–æ–¥–µ—Ä–∂–∏—Ç `/admin/...` –∏–ª–∏ `/reseller/...`
      - **–†–µ–∂–∏–º C** (Access Code –±–µ–∑ XC_SCOPE): fallback —á–µ—Ä–µ–∑ `PHP_SELF` (–∫–∞–∫ `CodeRepository::getCurrentCode`)
    - –ú–∞–ø–ø–∏–Ω–≥ `#TYPE#` ‚Üí scope: admin, reseller, ministra, includes/api/admin ‚Üí admin, –∏ —Ç.–¥.
    - Bootstrap —á–µ—Ä–µ–∑ legacy chain (session.php ‚Üí functions.php)
    - –ó–∞–≥—Ä—É–∑–∫–∞ –º–∞—Ä—à—Ä—É—Ç–æ–≤ –∏–∑ routes/{scope}.php + routes/api.php
    - Dispatch —á–µ—Ä–µ–∑ Router ‚Üí fallback –≤ legacy include
    - –ü–æ–¥–¥–µ—Ä–∂–∫–∞ API action dispatch (/admin/api?action=xxx)
- ‚úÖ `interfaces/Http/routes/admin.php` ‚Äî —à–∞–±–ª–æ–Ω –º–∞—Ä—à—Ä—É—Ç–æ–≤ admin (–∑–∞–≥–ª—É—à–∫–∏ –¥–ª—è Step 6.3)
- ‚úÖ `interfaces/Http/routes/api.php` ‚Äî —à–∞–±–ª–æ–Ω API –º–∞—Ä—à—Ä—É—Ç–æ–≤ (–∑–∞–≥–ª—É—à–∫–∏ –¥–ª—è Step 6.3)

**Access Codes (`bin/nginx/conf/codes/`):**

–ü–∞–Ω–µ–ª—å –¥–æ—Å—Ç—É–ø–Ω–∞ –Ω–µ –ø–æ `/admin/`, –∞ –ø–æ `/RANDOMCODE/`. –ö–æ–¥—ã –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è –∏–∑ —à–∞–±–ª–æ–Ω–∞:
- –®–∞–±–ª–æ–Ω: `bin/nginx/conf/codes/template`
- –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä: `domain/Auth/CodeRepository.php` ‚Üí `updateCodes()`
- URL: `http://host/MYCODE/dashboard` ‚Üí nginx alias ‚Üí `/home/xc_vm/admin/dashboard.php`
- –¢–∏–ø—ã –∫–æ–¥–æ–≤ (field `type` –≤ —Ç–∞–±–ª–∏—Ü–µ):

| type | #TYPE# (alias path)      | scope (Router) |
|------|--------------------------|----------------|
| 0    | admin                    | admin          |
| 1    | reseller                 | reseller       |
| 2    | ministra                 | ministra       |
| 3    | includes/api/admin       | admin          |
| 4    | includes/api/reseller    | reseller       |
| 5    | ministra/new             | ministra       |
| 6    | player                   | player         |

**–ê–∫—Ç–∏–≤–∞—Ü–∏—è ‚Äî –¥–≤–∞ –≤–∞—Ä–∏–∞–Ω—Ç–∞:**

1) **–ü—Ä—è–º–æ–π –¥–æ—Å—Ç—É–ø** (dev/test, –±–µ–∑ access codes):
```nginx
location ~ ^/(admin|reseller)(/.*)?$ {
    try_files $uri /interfaces/Http/public/index.php?$args;
}
```

2) **Access codes** (production) ‚Äî –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π —à–∞–±–ª–æ–Ω `bin/nginx/conf/codes/template`:
```nginx
location ^~ /#CODE# {
    alias /home/xc_vm/#TYPE#;
    index index.php;
    # –°—Ç–∞—Ç–∏–∫–∞ –∏ legacy PHP –æ—Ç–¥–∞—é—Ç—Å—è –Ω–∞–ø—Ä—è–º—É—é
    try_files $uri $uri.html $uri/ @fc_#CODE#;

    location ~ \.php$ {
        fastcgi_split_path_info ^(.+\.php)(/.+)$;
        fastcgi_pass php;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $request_filename;
    }
}

# Front Controller fallback –¥–ª—è access code #CODE#
location @fc_#CODE# {
    fastcgi_param XC_SCOPE #TYPE#;
    fastcgi_param XC_CODE  #CODE#;
    fastcgi_param SCRIPT_FILENAME /home/xc_vm/interfaces/Http/public/index.php;
    fastcgi_pass php;
    include fastcgi_params;
}
```

–ü–æ–∫–∞ nginx —à–∞–±–ª–æ–Ω –Ω–µ –æ–±–Ω–æ–≤–ª—ë–Ω ‚Äî legacy URL —á–µ—Ä–µ–∑ access codes (`/MYCODE/dashboard` ‚Üí `admin/dashboard.php`) —Ä–∞–±–æ—Ç–∞—é—Ç –∫–∞–∫ —Ä–∞–Ω—å—à–µ. Front Controller –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è template.

#### –®–∞–≥ 6.3 ‚Äî –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è admin-—Å—Ç—Ä–∞–Ω–∏—Ü (Controller/View)

**–ü–∞—Ç—Ç–µ—Ä–Ω: Thin Controller + View —Ñ–∞–π–ª**

–ö–∞–∂–¥–∞—è legacy admin-—Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Ä–∞–∑–¥–µ–ª—è–µ—Ç—Å—è –Ω–∞:
- **Controller** (`interfaces/Http/Controllers/Admin/XxxController.php`) ‚Äî –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö, —Ä–µ–¥–∏—Ä–µ–∫—Ç—ã, –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤
- **View** (`interfaces/Http/Views/admin/xxx.php`) ‚Äî —Ç–æ–ª—å–∫–æ HTML-–∫–æ–Ω—Ç–µ–Ω—Ç (–º–µ–∂–¥—É header –∏ footer)
- **Scripts** (`interfaces/Http/Views/admin/xxx.scripts.php`) ‚Äî page-specific JS (DataTables, api(), etc.)

**‚úÖ `interfaces/Http/Controllers/Admin/BaseAdminController.php` ‚Äî render(), redirect(), json(), setTitle(), requirePermission(), requireAdvPermission(), input(), getStatus()
- ‚úÖ `interfaces/Http/Views/admin/_scripts_init.php` ‚Äî –æ–±—â–∏–π JS-–±–æ–π–ª–µ—Ä–ø–ª–µ–π—Ç (ResizeObserver, Switchery, DataTable errMode, bindHref, inputFilter, js_navigate –∏ —Ç.–¥.)
- ‚úÖ `interfaces/Http/Views/layout.php` ‚Äî –º—ë—Ä—Ç–≤—ã–π –∫–æ–¥, –ø–æ–º–µ—á–µ–Ω `@deprecated` (–∞–∫—Ç—É–∞–ª—å–Ω—ã–π layout: `Views/layouts/admin.php` + `footer.php`)
- ‚úÖ `interfaces/Http/Views/partials/header.php` + `footer.php` ‚Äî –º—ë—Ä—Ç–≤—ã–π –∫–æ–¥, –ø–æ–º–µ—á–µ–Ω—ã `@deprecated`

**Render flow:** `renderUnifiedLayoutHeader('admin')` ‚Üí `view.php` ‚Üí `renderUnifiedLayoutFooter('admin')` ‚Üí `scripts.php` (–≤–∫–ª—é—á–∞–µ—Ç `_scripts_init.php`) ‚Üí `</body></html>`

**–ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–µ—Ä–µ–¥ Phase 6.3:**
- ‚úÖ Router `buildRoute()` ‚Äî –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –∫–ª—é—á–µ–π –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ (rtmp_ips ‚Üí rtmp/ips)
- ‚úÖ Router `callHandler()` ‚Äî DI —á–µ—Ä–µ–∑ ServiceContainer —Å fallback
- ‚úÖ Autoloader ‚Äî —Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω—ã `domain/`, `streaming/`, `modules/`, –¥–æ–±–∞–≤–ª–µ–Ω `interfaces/`
- ‚úÖ Autoloader ‚Äî `MAIN_HOME` fallback: `__DIR__ . '/'` –≤–º–µ—Å—Ç–æ `/home/xc_vm/`
- ‚úÖ –ú—ë—Ä—Ç–≤—ã–π Layout –∫–æ–¥ (layout.php + partials/header.php + partials/footer.php) –ø–æ–º–µ—á–µ–Ω `@deprecated`

**–ü–∏–ª–æ—Ç–Ω–∞—è –≥—Ä—É–ø–ø–∞ (–ø—Ä–æ—Å—Ç—ã–µ –ª–∏—Å—Ç–∏–Ω–≥–∏, no POST, inline DataTables):**
- ‚úÖ `IpController.php` + `Views/admin/ips.php` + `ips.scripts.php` ‚Äî Blocked IPs, flush action, getBlockedIPs()
- ‚úÖ `IspController.php` + `Views/admin/isps.php` + `isps.scripts.php` ‚Äî Blocked ISPs, getISPs()
- ‚úÖ `HmacController.php` + `Views/admin/hmacs.php` + `hmacs.scripts.php` ‚Äî HMAC Keys, getHMACTokens()
- ‚úÖ `GroupController.php` + `Views/admin/groups.php` + `groups.scripts.php` ‚Äî Member Groups, getMemberGroups(), adv:edit_group
- ‚úÖ `CodeController.php` + `Views/admin/codes.php` + `codes.scripts.php` ‚Äî Access Codes, getcodes(), type mapping
- ‚úÖ `PackageController.php` + `Views/admin/packages.php` + `packages.scripts.php` ‚Äî Packages (filtered !is_addon), getPackages()
- ‚úÖ `RtmpIpController.php` + `Views/admin/rtmp_ips.php` + `rtmp_ips.scripts.php` ‚Äî RTMP IPs, getRTMPIPs(), push/pull icons
- ‚úÖ `ProfileController.php` + `Views/admin/profiles.php` + `profiles.scripts.php` ‚Äî Transcode Profiles, getTranscodeProfiles(), JSON profile_options
- ‚úÖ `ProviderController.php` + `Views/admin/providers.php` + `providers.scripts.php` ‚Äî Stream Providers, getStreamProviders(), reload action, JSON data
- ‚úÖ `TheftDetectionController.php` + `Views/admin/theft_detection.php` + `theft_detection.scripts.php` ‚Äî VOD Theft Detection, igbinary cache, range filter, custom search
- ‚úÖ –ú–∞—Ä—à—Ä—É—Ç—ã –≤ `interfaces/Http/routes/admin.php` ‚Äî 10 GET-–º–∞—Ä—à—Ä—É—Ç–æ–≤ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã

**–°—Ç–∞—Ç—É—Å 6.3:** ‚úÖ –ó–∞–≤–µ—Ä—à—ë–Ω ‚Äî **111/111 admin-—Å—Ç—Ä–∞–Ω–∏—Ü –º–∏–≥—Ä–∏—Ä–æ–≤–∞–Ω–æ**

| –ê—Ä—Ç–µ—Ñ–∞–∫—Ç | –ö–æ–ª-–≤–æ | –°—Ç–∞—Ç—É—Å |
|---|---|---|
| –ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã (`Controllers/Admin/`) | 111 + BaseAdminController | ‚úÖ |
| View-–ø—Ä–æ–∫—Å–∏ (`Views/admin/`) | 111 | ‚úÖ |
| –ú–∞—Ä—à—Ä—É—Ç—ã (`routes/admin.php`) | 111 | ‚úÖ |
| Legacy-–æ–±—ë—Ä—Ç–∫–∏ (`$__viewMode`) | 111 (108 std + 1 settings variant + 2 module bypass) | ‚úÖ |

**–ì—Ä—É–ø–ø—ã –º–∏–≥—Ä–∞—Ü–∏–∏ (–≤—Å–µ –∑–∞–≤–µ—Ä—à–µ–Ω—ã):**
- ‚úÖ **Pilot** (10): ips, isps, hmacs, groups, codes, packages, rtmp_ips, profiles, providers, theft_detection
- ‚úÖ **A** (19): streams, stream, stream_view, stream_mass, stream_categories, stream_category, stream_errors, stream_rank, stream_review, stream_tools, channel_order, created_channel, created_channels, created_channel_mass, live_connections, rtmp_monitor, radio, radios, radio_mass
- ‚úÖ **B** (10): movies, movie, movie_mass, series, serie, series_mass, episodes, episode, episodes_mass, ondemand
- ‚úÖ **C** (6): lines, line, line_mass, line_activity, line_ips, mass_delete
- ‚úÖ **D** (4): server_order, server_install, server, server_view
- ‚úÖ **E** (4): bouquets, bouquet, bouquet_order, bouquet_sort
- ‚úÖ **F** (4): settings, settings_plex, settings_watch, quick_tools
- ‚úÖ **G** (6): login_logs, mysql_syslog, mag_events, restream_logs, panel_logs, epgs
- ‚úÖ **H** (9): dashboard, cache, queue, process_monitor, backups, client_logs, user_logs, useragent, useragents
- ‚úÖ **I** (6): mags, mag, mag_mass, enigmas, enigma, enigma_mass
- ‚úÖ **J** (6): epg, epg_view, code, hmac, ip, isp
- ‚úÖ **K** (5): group, package, profile, provider, rtmp_ip
- ‚úÖ **L** (5): users, user, user_mass, plex, plex_add
- ‚úÖ **M** (8): tickets, ticket, ticket_view, serie, watch, watch_add, watch_output, magscan_settings
- ‚úÖ **N** (9): credit_logs, edit_profile, fingerprint, proxies, proxy, record, review, archive, asns

**16 non-page —Ñ–∞–π–ª–æ–≤** (–º–∏–≥—Ä–∞—Ü–∏—è –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è): header.php, footer.php, topbar.php, modals.php, functions.php, session.php, post.php, login.php, logout.php, setup.php, database.php, index.php, resize.php, player.php, api.php, table.php

#### –®–∞–≥ 6.4 ‚Äî –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ admin/reseller ‚úÖ

**–°—Ç–∞—Ç—É—Å:** –ó–∞–≤–µ—Ä—à—ë–Ω ‚Äî 22 reseller-—Å—Ç—Ä–∞–Ω–∏—Ü—ã –º–∏–≥—Ä–∏—Ä–æ–≤–∞–Ω—ã.

**–ê—Ä—Ç–µ—Ñ–∞–∫—Ç—ã:**
- ‚úÖ `BaseResellerController` ‚Äî —Ä–∞—Å—à–∏—Ä—è–µ—Ç BaseAdminController, `$scope = 'reseller'`, –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç `requirePermission()` ‚Üí `checkResellerPermissions()`
- ‚úÖ 22 –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞ (`Reseller*Controller`) –≤ `interfaces/Http/Controllers/Reseller/`
- ‚úÖ 22 view proxy –≤ `interfaces/Http/Views/reseller/`
- ‚úÖ 22 legacy —Ñ–∞–π–ª–∞ –æ–±—ë—Ä–Ω—É—Ç—ã `$__viewMode` –≥–∞—Ä–¥–∞–º–∏
- ‚úÖ `interfaces/Http/routes/reseller.php` ‚Äî 22 –º–∞—Ä—à—Ä—É—Ç–∞

**Reseller-—Å—Ç—Ä–∞–Ω–∏—Ü—ã (22):**
Dashboard & Profile: dashboard, edit_profile
Lines: lines, line, line_activity, live_connections
Devices: mags, mag, enigmas, enigma
Content: streams, movies, radios, episodes, created_channels, epg_view
Tickets: tickets, ticket, ticket_view
Users: users, user, user_logs

**–ö–ª—é—á–µ–≤—ã–µ –æ—Ç–ª–∏—á–∏—è –æ—Ç admin:**
- –ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã —Å –ø—Ä–µ—Ñ–∏–∫—Å–æ–º `Reseller` (ResellerDashboardController –∏ —Ç.–¥.) –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ —Å admin-–∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞–º–∏ –≤ –±–µ–∑–Ω–µ–π–º—Å–ø–µ–π—Å–Ω–æ–º –∞–≤—Ç–æ–∑–∞–≥—Ä—É–∑—á–∏–∫–µ
- `checkResellerPermissions()` –≤–º–µ—Å—Ç–æ `checkPermissions()`
- `$_SESSION['reseller']` –≤–º–µ—Å—Ç–æ `$_SESSION['hash']`

```
reseller/table.php (1836 —Å—Ç—Ä.) ‚Üí –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ—Ç admin-–∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã —Å RBAC-—Ñ–∏–ª—å—Ç—Ä–æ–º
reseller/api.php (997 —Å—Ç—Ä.)    ‚Üí ResellerApiController (–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–π AdminApiController)
```

#### –®–∞–≥ 6.5 ‚Äî –°—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏—è Controller/View –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞ ‚úÖ

**–°—Ç–∞—Ç—É—Å:** –ó–∞–≤–µ—Ä—à—ë–Ω (–ø–µ—Ä–≤—ã–π —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏–æ–Ω–Ω—ã–π –ø—Ä–æ—Ö–æ–¥ –ø–æ—Å–ª–µ 6.3/6.4).

**–°–¥–µ–ª–∞–Ω–æ:**
- ‚úÖ –†–∞—Å—à–∏—Ä–µ–Ω –±–∞–∑–æ–≤—ã–π –∫–æ–Ω—Ç—Ä–∞–∫—Ç `BaseAdminController::$viewGlobals`:
    - –¥–æ–±–∞–≤–ª–µ–Ω—ã `rTMDBLanguages`, `rGeoCountries`, `rMAGs`, `rTimezones`
    - —Ä–∞–Ω–µ–µ –¥–æ–±–∞–≤–ª–µ–Ω `allowedLangs`
- ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω —Ä–µ–Ω–¥–µ—Ä update-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è/changelog –≤ `admin/settings.php`:
    - –∑–∞—â–∏—Ç–∞ `foreach` –ø–æ `changelog` —á–µ—Ä–µ–∑ `is_array`
    - –∑–∞—â–∏—Ç–∞ –≤–ª–æ–∂–µ–Ω–Ω–æ–≥–æ `changes` —á–µ—Ä–µ–∑ –±–µ–∑–æ–ø–∞—Å–Ω—ã–π fallback –Ω–∞ `[]`
- ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω `modules/watch/views/watch_add.php`:
    - –∑–∞—â–∏—Ç–∞ `foreach` –ø–æ `$rTMDBLanguages` –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏/–Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–º —Ç–∏–ø–µ
- ‚úÖ –í—Ç–æ—Ä–æ–π —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏–æ–Ω–Ω—ã–π –ø—Ä–æ—Ö–æ–¥ (—Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π, 14 —Ñ–∞–π–ª–æ–≤):
    - –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã `watch/plex/settings_*` —Ç–µ–ø–µ—Ä—å –Ω–æ—Ä–º–∞–ª–∏–∑—É—é—Ç –º–∞—Å—Å–∏–≤—ã (`[]` fallback)
    - –≤ `watch/plex/profile` view –¥–æ–±–∞–≤–ª–µ–Ω—ã –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ `foreach` –∏ `in_array/count` —Å `(array)`/`is_array` guard
    - –∑–∞–∫—Ä—ã—Ç—ã —Ä–∏—Å–∫–∏ `foreach(null)` –∏ `Undefined variable` –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü `watch_output`, `watch_add`, `settings_watch`, `record`, `plex/index`, `plex/settings`, `plex/library_edit`, `admin/edit_profile`

**–¶–µ–ª—å —à–∞–≥–∞:**
- —É–±—Ä–∞—Ç—å class-runtime —Ä–µ–≥—Ä–µ—Å—Å–∏–π ¬´Undefined variable / foreach() argument must be array|object¬ª
- –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å –µ–¥–∏–Ω—ã–π –∫–æ–Ω—Ç—Ä–∞–∫—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è legacy view –≤ controller-—Ä–µ–∂–∏–º–µ

**–î–∞–ª—å—à–µ (—Å–ª–µ–¥—É—é—â–∏–π –ø—Ä–æ—Ö–æ–¥ 6.5):**
- üîÑ —Ç–æ—á–µ—á–Ω—ã–π –∞—É–¥–∏—Ç `Reseller`-view (–æ—Å–æ–±–µ–Ω–Ω–æ echo-—Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã) –Ω–∞ `foreach/in_array` —Å nullable-–¥–∞–Ω–Ω—ã–º–∏
- üîÑ –≤—ã–±–æ—Ä–æ—á–Ω–æ –ø–µ—Ä–µ–Ω–µ—Å—Ç–∏ –æ—Å—Ç–∞–≤—à–∏–µ—Å—è high-risk —Å–ª—É—á–∞–∏ –≤ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–Ω—ã–π data-contract –≤–º–µ—Å—Ç–æ –ª–æ–∫–∞–ª—å–Ω—ã—Ö view-guard

---

### –§–∞–∑–∞ 7: –ú–∏–≥—Ä–∞—Ü–∏—è admin.php bootstrap

`admin.php` (4448 —Å—Ç—Ä.) ‚Äî –ø–æ—Å–ª–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –≤—Å–µ—Ö —Ñ—É–Ω–∫—Ü–∏–π –≤ domain/.

#### –®–∞–≥ 7.1 ‚Äî –í—ã–Ω–æ—Å inline-–¥–∞–Ω–Ω—ã—Ö
```
$rCountryCodes, $rCountries  ‚Üí resources/data/countries.php
$rTimezones                  ‚Üí resources/data/timezones.php
$rMacTypes                   ‚Üí resources/data/mac_types.php
```

#### –®–∞–≥ 7.2 ‚Äî –ó–∞–º–µ–Ω–∞ –ø—Ä–æ—Ü–µ–¥—É—Ä–Ω–æ–≥–æ bootstrap
```
admin.php::initDatabase()        ‚Üí ServiceContainer::get('db')
admin.php::CoreUtilities::init() ‚Üí bootstrap.php
admin.php::session_start()       ‚Üí SessionManager::start()
admin.php::$rPermissions         ‚Üí Authorization::getPermissions()
admin.php::Translator init       ‚Üí ServiceContainer::get('translator')
```

#### –®–∞–≥ 7.3 ‚Äî –£–¥–∞–ª–µ–Ω–∏–µ admin.php
- –í—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ —É–∂–µ –≤ domain/ (proxy-–≤—ã–∑–æ–≤—ã)
- –í—Å–µ –¥–∞–Ω–Ω—ã–µ –≤ resources/data/
- Bootstrap —á–µ—Ä–µ–∑ `bootstrap.php`
- `admin.php` ‚Üí —Ç–æ–Ω–∫–∏–π require-—Ñ–∞–π–ª (< 50 —Å—Ç—Ä–æ–∫) –∏–ª–∏ —É–¥–∞–ª—è–µ—Ç—Å—è

---

### –§–∞–∑–∞ 8: –û—á–∏—Å—Ç–∫–∞ –∏ —Ñ–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è

#### –®–∞–≥ 8.1 ‚Äî –£–¥–∞–ª–µ–Ω–∏–µ proxy-–º–µ—Ç–æ–¥–æ–≤
- –û–±–Ω–æ–≤–∏—Ç—å –≤—Å–µ –≤—ã–∑—ã–≤–∞—é—â–∏–µ –º–µ—Å—Ç–∞ –Ω–∞ –ø—Ä—è–º—ã–µ –≤—ã–∑–æ–≤—ã –Ω–æ–≤—ã—Ö –∫–ª–∞—Å—Å–æ–≤
- –£–¥–∞–ª–∏—Ç—å proxy-–º–µ—Ç–æ–¥—ã –∏–∑ CoreUtilities, StreamingUtilities, admin_api.php

#### –®–∞–≥ 8.2 ‚Äî –£–¥–∞–ª–µ–Ω–∏–µ god-–æ–±—ä–µ–∫—Ç–æ–≤
- `CoreUtilities.php` ‚Üí —É–¥–∞–ª–∏—Ç—å (–≤—Å–µ –º–µ—Ç–æ–¥—ã —Ä–∞–∑–Ω–µ—Å–µ–Ω—ã)
- `StreamingUtilities.php` ‚Üí —É–¥–∞–ª–∏—Ç—å (–≤—Å–µ –º–µ—Ç–æ–¥—ã —Ä–∞–∑–Ω–µ—Å–µ–Ω—ã)
- –ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –æ—Å—Ç–∞–ª–æ—Å—å ‚Äî –≤—ã–Ω–µ—Å—Ç–∏ –≤ —É—Ç–∏–ª–∏—Ç–Ω—ã–π –∫–ª–∞—Å—Å

#### –®–∞–≥ 8.3 ‚Äî –†–µ–≤–∏–∑–∏—è core/
- –£–±–µ–¥–∏—Ç—å—Å—è: `core/` –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏
- –£–±–µ–¥–∏—Ç—å—Å—è: `domain/` –Ω–µ –∑–Ω–∞–µ—Ç –æ–± `interfaces/`
- –£–±–µ–¥–∏—Ç—å—Å—è: —É–¥–∞–ª–µ–Ω–∏–µ –ª—é–±–æ–≥–æ –º–æ–¥—É–ª—è –Ω–µ –ª–æ–º–∞–µ—Ç —Å–∏—Å—Ç–µ–º—É

#### –®–∞–≥ 8.4 ‚Äî –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ cli/monitor.php
- –£–¥–∞–ª–∏—Ç—å goto-–ª–µ–π–±–ª—ã (`label235`, `label592`)
- –ü–µ—Ä–µ–ø–∏—Å–∞—Ç—å —Å –Ω–æ—Ä–º–∞–ª—å–Ω—ã–º control flow
- –í—ã–Ω–µ—Å—Ç–∏ –≤ `interfaces/Cli/Commands/MonitorCommand.php`

---

### –°–≤–æ–¥–∫–∞: –æ–±—ä—ë–º —Ä–∞–±–æ—Ç—ã –ø–æ —Ñ–∞–π–ª–∞–º

| –ò—Å—Ö–æ–¥–Ω—ã–π —Ñ–∞–π–ª | –°—Ç—Ä–æ–∫ | –°–∫–æ–ª—å–∫–æ —Ü–µ–ª–µ–≤—ã—Ö –∫–ª–∞—Å—Å–æ–≤ | –§–∞–∑—ã |
|----------------|-------|------------------------|------|
| `CoreUtilities.php` | 4847 | ~20 –∫–ª–∞—Å—Å–æ–≤ | 1.7, 2, 3, 4, 5 |
| `admin_api.php` | 6981 | ~25 –∫–ª–∞—Å—Å–æ–≤ (Service) | 3.1‚Äì3.12, 5 |
| `admin.php` | 4448 | ~15 –∫–ª–∞—Å—Å–æ–≤ (Repository + –¥–∞–Ω–Ω—ã–µ) | 3, 5, 7 |
| `StreamingUtilities.php` | 1992 | ~10 –∫–ª–∞—Å—Å–æ–≤ | 2, 4 |
| `admin/post.php` | 1946 | —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –ø–æ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞–º | 6 |
| `admin/table.php` | 6003 | —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –ø–æ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞–º | 6 |
| `includes/api/admin/table.php` | 6868 | —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –ø–æ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞–º | 6 |
| `www/stream/auth.php` | 799 | 3 –∫–ª–∞—Å—Å–∞ (Auth) | 4 |
| `www/stream/live.php` | 707 | 3 –∫–ª–∞—Å—Å–∞ (Delivery) | 4 |
| –ü—Ä–æ—á–∏–µ admin/*.php | ~100 —Ñ–∞–π–ª–æ–≤ | Controller + View | 6 |

### –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π –ø–æ—Ä—è–¥–æ–∫ —Ä–∞–±–æ—Ç—ã

```
–§–∞–∑–∞ 1.7  ‚Üí  –§–∞–∑–∞ 2  ‚Üí  –§–∞–∑–∞ 3.1‚Äì3.4  ‚Üí  –§–∞–∑–∞ 4.1‚Äì4.3  ‚Üí  –§–∞–∑–∞ 3.5‚Äì3.12
                                                              ‚Üì
–§–∞–∑–∞ 5.1‚Äì5.5  ‚Üí  –§–∞–∑–∞ 5.6  ‚Üí  –§–∞–∑–∞ 6.1‚Äì6.4  ‚Üí  –§–∞–∑–∞ 7  ‚Üí  –§–∞–∑–∞ 8
```

–ö–∞–∂–¥—ã–π —à–∞–≥ (1.7.1, 1.7.2 ...) ‚Äî —ç—Ç–æ –æ–¥–Ω–∞ —Ä–∞–±–æ—á–∞—è —Å–µ—Å—Å–∏—è (1‚Äì3 —á–∞—Å–∞).
–ö–∞–∂–¥–∞—è —Ñ–∞–∑–∞ (1.7, 2, 3...) ‚Äî —ç—Ç–æ –Ω–µ–¥–µ–ª—è‚Äì–¥–≤–µ –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ–π —Ä–∞–±–æ—Ç—ã.
–ü–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ —à–∞–≥–∞ —Å–∏—Å—Ç–µ–º–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–∞.

---

## 10. –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### 10.1. –ö—Ç–æ —É–ø—Ä–∞–≤–ª—è–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏

**–ü—Ä–∞–≤–∏–ª–æ:** –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–µ–π —É–ø—Ä–∞–≤–ª—è–µ—Ç **Service**. –ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –∏ Repository –Ω–µ –æ—Ç–∫—Ä—ã–≤–∞—é—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏.

```
Controller ‚îÄ‚îÄ‚Üí Service ‚îÄ‚îÄ‚Üí Repository + Infrastructure
                  ‚îÇ
                  ‚îú‚îÄ‚îÄ beginTransaction()
                  ‚îú‚îÄ‚îÄ ... –±–∏–∑–Ω–µ—Å-–æ–ø–µ—Ä–∞—Ü–∏–∏ ...
                  ‚îú‚îÄ‚îÄ commit()
                  ‚îî‚îÄ‚îÄ (rollback –ø—Ä–∏ –∏—Å–∫–ª—é—á–µ–Ω–∏–∏)
```

### 10.2. –ü–∞—Ç—Ç–µ—Ä–Ω —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏

```php
class StreamService {
    public function massEdit(array $streamIds, array $changes): int {
        $this->db->beginTransaction();
        try {
            $affected = 0;
            foreach ($streamIds as $id) {
                $this->repository->update($id, $changes);
                $affected++;
            }
            $this->db->commit();
            return $affected;
        } catch (\Throwable $e) {
            $this->db->rollBack();
            $this->logger->log('error', "Mass edit failed: " . $e->getMessage());
            throw $e;
        }
    }
}
```

### 10.3. –ì—Ä–∞–Ω–∏—Ü—ã –ø–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç—É

| –ö–æ–Ω—Ç–µ–∫—Å—Ç | –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è | –ö—Ç–æ —É–ø—Ä–∞–≤–ª—è–µ—Ç | –ü—Ä–∏–º–µ—Ä |
|----------|-----------|---------------|--------|
| **Admin CRUD** | –û–¥–Ω–∞ –æ–ø–µ—Ä–∞—Ü–∏—è = –æ–¥–Ω–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è | Service | `StreamService::create()` |
| **Mass edit** | –í–µ—Å—å batch = –æ–¥–Ω–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è | Service | `StreamService::massEdit()` |
| **Import** | Chunk –ø–æ 100 –∑–∞–ø–∏—Å–µ–π | Service | `StreamService::importM3U()` |
| **Cron** | –ö–∞–∂–¥–∞—è –∏—Ç–µ—Ä–∞—Ü–∏—è = –æ—Ç–¥–µ–ª—å–Ω–∞—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è | CronJob | `ServersCron::processServer()` |
| **Streaming** | ‚ùå –ù–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π | ‚Äî | Hot path –Ω–µ –º—É—Ç–∏—Ä—É–µ—Ç —á–µ—Ä–µ–∑ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ |

### 10.4. –í–Ω–µ—à–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å—ã

–û–ø–µ—Ä–∞—Ü–∏—è ¬´—Å–æ–∑–¥–∞—Ç—å –ø–æ—Ç–æ–∫ + –∑–∞–ø—É—Å—Ç–∏—Ç—å ffmpeg + –æ–±–Ω–æ–≤–∏—Ç—å nginx¬ª ‚Äî –Ω–µ –∞—Ç–æ–º–∞—Ä–Ω–∞. FFmpeg/nginx ‚Äî –≤–Ω–µ—à–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å—ã, –æ—Ç–∫–∞—Ç–∏—Ç—å –Ω–µ–ª—å–∑—è.

**–ü–∞—Ç—Ç–µ—Ä–Ω:**
1. DB-–æ–ø–µ—Ä–∞—Ü–∏–∏ ‚Äî –≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
2. –í–Ω–µ—à–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å—ã ‚Äî –ø–æ—Å–ª–µ commit, —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫
3. –ü—Ä–∏ —Å–±–æ–µ –≤–Ω–µ—à–Ω–µ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞ ‚Äî –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –≤ –ë–î (`status = 'error'`)

```php
class StreamService {
    public function start(int $streamId): void {
        // 1. DB: –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å
        $this->repository->updateStatus($streamId, 'starting');
        
        // 2. –í–Ω–µ—à–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å—ã (–≤–Ω–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏)
        try {
            $pid = $this->processManager->startFFmpeg($streamId);
            $this->repository->updatePid($streamId, $pid);
            $this->repository->updateStatus($streamId, 'running');
        } catch (\Throwable $e) {
            $this->repository->updateStatus($streamId, 'error');
            $this->logger->log('error', "Start failed: {$e->getMessage()}");
            throw $e;
        }
    }
}
```

### 10.5. –î–≤–∞ —Ä–µ–∂–∏–º–∞ —Ä–∞–±–æ—Ç—ã —Å–∏—Å—Ç–µ–º—ã

| –†–µ–∂–∏–º | –ü—É—Ç—å | –ß–∞—Å—Ç–æ—Ç–∞ | –î–æ–ø—É—Å—Ç–∏–º–∞—è latency | –ó–∞–≥—Ä—É–∑–∫–∞ |
|-------|------|---------|-------------------|----------|
| **Hot path** (streaming) | `www/stream/*.php` | ~10K‚Äì100K req/min | < 50ms p99 | –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π bootstrap, –Ω–∏–∫–∞–∫–∏—Ö –º–æ–¥—É–ª–µ–π |
| **Cold path** (admin) | `admin/*.php`, API | ~1‚Äì100 req/min | < 500ms p99 | –ü–æ–ª–Ω—ã–π bootstrap, –≤—Å–µ –º–æ–¥—É–ª–∏ |

### 10.6. –ë—é–¥–∂–µ—Ç hot path

Streaming-–∑–∞–ø—Ä–æ—Å (`auth.php` ‚Üí `live.php`) –¥–æ–ª–∂–µ–Ω —É–ª–æ–∂–∏—Ç—å—Å—è –≤:

```
Bootstrap:     < 5ms  (autoload + constants + DB)
Auth:          < 10ms (token + Redis + bruteforce)
Stream lookup: < 5ms  (Redis cache) | < 15ms (DB fallback)
Delivery:      < 10ms (redirect + headers)
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Total:         < 30ms (target) | < 50ms (max)
```

**–ù–ï–õ–¨–ó–Ø –∑–∞–≥—Ä—É–∂–∞—Ç—å –≤ hot path:** Router, EventDispatcher —Å –ø–æ–¥–ø–∏—Å—á–∏–∫–∞–º–∏, ServiceContainer –ø–æ–ª–Ω—ã–π boot.
**–ú–û–ñ–ù–û:** Database (persistent), Redis (single connection), GeoIP (mmap), streaming/*.

### 10.7. Async / Queue (–±—É–¥—É—â–µ–µ)

–î–ª–∏–Ω–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ (ffprobe, tmdb, mass import) ‚Äî –∫–∞–Ω–¥–∏–¥–∞—Ç—ã –Ω–∞ async:

```
HTTP ‚Üí Service ‚Üí Queue Job (Redis LPUSH) ‚Üí Worker (cron) ‚Üí Result
```

–ë–µ–∑ RabbitMQ/Kafka ‚Äî –ø—Ä–æ—Å—Ç–∞—è Redis-–æ—á–µ—Ä–µ–¥—å —á–µ—Ä–µ–∑ `LPUSH`/`BRPOP`.

---

## 11. –°—Ç—Ä–∞—Ç–µ–≥–∏—è –º–∏–≥—Ä–∞—Ü–∏–∏ –ø–æ —Ä–∏—Å–∫–∞–º

### 11.1. –ü—Ä–∏–Ω—Ü–∏–ø: –∫–∞–∂–¥—ã–π —à–∞–≥ –æ–±—Ä–∞—Ç–∏–º

–ö–∞–∂–¥–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Å–ª–µ–¥—É–µ—Ç –ø–∞—Ç—Ç–µ—Ä–Ω—É **extract ‚Üí delegate ‚Üí verify ‚Üí replace**:

```
1. Extract: —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –∫–ª–∞—Å—Å
2. Delegate: —Å—Ç–∞—Ä—ã–π –∫–æ–¥ –≤—ã–∑—ã–≤–∞–µ—Ç –Ω–æ–≤—ã–π —á–µ—Ä–µ–∑ proxy
3. Verify: —Å–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ —Ä–∞–Ω—å—à–µ + –Ω–æ–≤—ã–π –∫–æ–¥ —Ä–∞–±–æ—Ç–∞–µ—Ç
4. Replace: –æ–±–Ω–æ–≤–∏—Ç—å –≤—ã–∑—ã–≤–∞—é—â–∏–π –∫–æ–¥ –Ω–∞ –ø—Ä—è–º—ã–µ –≤—ã–∑–æ–≤—ã (–æ—Ç–¥–µ–ª—å–Ω—ã–π —à–∞–≥)
```

–ï—Å–ª–∏ —à–∞–≥ 3 –ø—Ä–æ–≤–∞–ª–∏–ª—Å—è ‚Äî –æ—Ç–∫–∞—Ç = —É–¥–∞–ª–∏—Ç—å –Ω–æ–≤—ã–π –∫–ª–∞—Å—Å + —É–±—Ä–∞—Ç—å proxy. –°–∏—Å—Ç–µ–º–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –≤ –ø—Ä–µ–¥—ã–¥—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ.

### 11.2. –†–µ–≥—Ä–µ—Å—Å–∏–æ–Ω–Ω–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è

| –£—Ä–æ–≤–µ–Ω—å | –ß—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è | –ö–∞–∫ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è | –ö–æ–≥–¥–∞ |
|---------|----------------|-----------------|-------|
| **Syntax** | PHP-—Ñ–∞–π–ª—ã –∫–æ–º–ø–∏–ª–∏—Ä—É—é—Ç—Å—è | `php -l` –Ω–∞ –∫–∞–∂–¥—ã–π –∏–∑–º–µ–Ω—ë–Ω–Ω—ã–π —Ñ–∞–π–ª | –ü–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –∫–æ–º–º–∏—Ç–∞ |
| **Smoke** | –°–∏—Å—Ç–µ–º–∞ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è | `make new && make lb` + –ø—Ä–æ–≤–µ—Ä–∫–∞ HTTP 200 | –ü–æ—Å–ª–µ –∫–∞–∂–¥–æ–π —Ñ–∞–∑—ã |
| **Functional** | –û—Å–Ω–æ–≤–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ —Ä–∞–±–æ—Ç–∞—é—Ç | –†—É—á–Ω–æ–π checklist (—Å–æ–∑–¥–∞—Ç—å –ø–æ—Ç–æ–∫, –∑–∞–ø—É—Å—Ç–∏—Ç—å, –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å) | –ü–æ—Å–ª–µ –∫–∞–∂–¥–æ–π —Ñ–∞–∑—ã |
| **Integration** | LB-—Å–±–æ—Ä–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç | –î–µ–ø–ª–æ–π –Ω–∞ —Ç–µ—Å—Ç–æ–≤—ã–π LB-—Å–µ—Ä–≤–µ—Ä + —Å—Ç—Ä–∏–º–∏–Ω–≥-—Ç–µ—Å—Ç | –ü–æ—Å–ª–µ —Ñ–∞–∑ 1‚Äì4 |
| **Backward compat** | API –Ω–µ —Å–ª–æ–º–∞–Ω | –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç–≤–µ—Ç–æ–≤ API (—Ñ–æ—Ä–º–∞—Ç JSON, –∫–æ–¥—ã –æ—à–∏–±–æ–∫) | –ü–æ—Å–ª–µ —Ñ–∞–∑—ã 6 |

### 11.3. Dual bootstrap –Ω–∞ –ø–µ—Ä–µ—Ö–æ–¥–Ω–æ–º —ç—Ç–∞–ø–µ

**–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ (—Ñ–∞–∑—ã 1‚Äì6):** Dual bootstrap —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ.

```
bootstrap.php (–Ω–æ–≤—ã–π)          includes/admin.php (—Å—Ç–∞—Ä—ã–π legacy)
      ‚îÇ                                ‚îÇ
      ‚îú‚îÄ‚îÄ autoload.php                 ‚îú‚îÄ‚îÄ require Database.php
      ‚îú‚îÄ‚îÄ ServiceContainer             ‚îú‚îÄ‚îÄ CoreUtilities::init()
      ‚îú‚îÄ‚îÄ ConfigLoader                 ‚îú‚îÄ‚îÄ API/ResellerAPI init
      ‚îî‚îÄ‚îÄ –Ω–æ–≤—ã–µ core/ –∫–ª–∞—Å—Å—ã           ‚îî‚îÄ‚îÄ 50 define() + global $db
```

**–ü—Ä–∞–≤–∏–ª–∞ dual bootstrap:**
1. `bootstrap.php` –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –ü–ï–†–í–´–ú –≤ –∫–∞–∂–¥–æ–π —Ç–æ—á–∫–µ –≤—Ö–æ–¥–∞
2. `includes/admin.php` –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –ü–û–°–õ–ï ‚Äî –¥–ª—è legacy-–∫–æ–¥–∞, –∫–æ—Ç–æ—Ä—ã–π –µ—â—ë –Ω–µ –º–∏–≥—Ä–∏—Ä–æ–≤–∞–Ω
3. –ù–æ–≤—ã–µ –∫–ª–∞—Å—Å—ã (`core/`, `domain/`) –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é—Ç—Å—è —á–µ—Ä–µ–∑ `ServiceContainer`
4. Legacy-–∫–æ–¥ (`CoreUtilities`, `admin_api.php`) –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å —á–µ—Ä–µ–∑ proxy-–º–µ—Ç–æ–¥—ã
5. –ü–æ—Å–ª–µ –ø–æ–ª–Ω–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏ (–§–∞–∑–∞ 8) ‚Äî `includes/admin.php` —É–¥–∞–ª—è–µ—Ç—Å—è

### 11.4. API backward compatibility

**–ü—Ä–∞–≤–∏–ª–æ:** –í–Ω–µ—à–Ω–∏–π API (`player.api`, `xmltv.php`, –º–µ–∂—Å–µ—Ä–≤–µ—Ä–Ω—ã–π API) –Ω–µ –º–µ–Ω—è–µ—Ç —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–æ–≤ –¥–æ –§–∞–∑—ã 8.

```
–§–∞–∑—ã 1‚Äì7: –í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–∑–∞—Ü–∏—è, –≤–Ω–µ—à–Ω–∏–π API –Ω–µ–∏–∑–º–µ–Ω–µ–Ω
–§–∞–∑–∞ 8:   API v2 (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) —Å –Ω–æ–≤–æ–π –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–µ–π
           API v1 –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å —á–µ—Ä–µ–∑ compatibility layer
```

### 11.5. –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ —Ä–µ–ª–∏–∑–æ–≤

| –†–µ–ª–∏–∑ | –°–æ–¥–µ—Ä–∂–∏—Ç | –†–∏—Å–∫ |
|-------|----------|------|
| **v1.8** | –§–∞–∑—ã 0‚Äì2 (core/ extraction, dedup) | üü¢ –ù–∏–∑–∫–∏–π ‚Äî proxy-–º–µ—Ç–æ–¥—ã, –æ–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å |
| **v1.9** | –§–∞–∑—ã 3‚Äì4 (domain/ + streaming/ extraction) | üü° –°—Ä–µ–¥–Ω–∏–π ‚Äî –±–æ–ª—å—à–µ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–π, proxy –ø–æ–∫—Ä—ã–≤–∞–µ—Ç |
| **v2.0** | –§–∞–∑—ã 5‚Äì6 (modules + controllers) | üü° –°—Ä–µ–¥–Ω–∏–π ‚Äî –Ω–æ–≤–∞—è –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è, dual bootstrap |
| **v2.1** | –§–∞–∑—ã 7‚Äì8 (cleanup, —É–¥–∞–ª–µ–Ω–∏–µ legacy) | üî¥ –í—ã—Å–æ–∫–∏–π ‚Äî —É–¥–∞–ª–µ–Ω–∏–µ god-–æ–±—ä–µ–∫—Ç–æ–≤, –Ω–µ—Ç fallback |

### 11.6. Rollback plan

```
–ï—Å–ª–∏ v2.0 –ª–æ–º–∞–µ—Ç production:
1. git revert –ø–æ—Å–ª–µ–¥–Ω–∏–π merge –≤ main
2. –ü–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å: make new && make lb
3. –ó–∞–¥–µ–ø–ª–æ–∏—Ç—å –ø—Ä–µ–¥—ã–¥—É—â—É—é —Å–±–æ—Ä–∫—É
4. Post-mortem: —á—Ç–æ —Å–ª–æ–º–∞–ª–æ—Å—å, –ø–æ—á–µ–º—É –Ω–µ –ø–æ–π–º–∞–ª–∏ –Ω–∞ smoke test
```

–î–ª—è v2.1 (—É–¥–∞–ª–µ–Ω–∏–µ legacy) ‚Äî **feature flag:**
```php
// config.ini
[migration]
use_legacy_bootstrap = false    ; true = –æ—Ç–∫–∞—Ç –Ω–∞ admin.php
use_legacy_api = false          ; true = –æ—Ç–∫–∞—Ç –Ω–∞ admin_api.php switch
```

---

## 12. –ü—Ä–∞–≤–∏–ª–∞ –¥–ª—è –∫–æ–Ω—Ç—Ä–∏–±—å—é—Ç–æ—Ä–æ–≤

> –≠—Ç–æ—Ç —Ä–∞–∑–¥–µ–ª ‚Äî –∫—Ä–∞—Ç–∫–∞—è –≤—ã–∂–∏–º–∫–∞ –¥–ª—è —Ç–µ—Ö, –∫—Ç–æ –Ω–µ —á–∏—Ç–∞–ª –≤–µ—Å—å –¥–æ–∫—É–º–µ–Ω—Ç. –ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ ‚Äî –≤ CONTRIBUTING.md.

### 12.1. –ö–∞–∫ –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π —ç–Ω–¥–ø–æ–∏–Ω—Ç (admin)

1. –ù–∞–π—Ç–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç –≤ `domain/` (–Ω–∞–ø—Ä–∏–º–µ—Ä `domain/Stream/`)
2. –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥ –≤ `StreamService.php` (–±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞)
3. –î–æ–±–∞–≤–∏—Ç—å SQL-–º–µ—Ç–æ–¥ –≤ `StreamRepository.php` (–µ—Å–ª–∏ –Ω—É–∂–µ–Ω –Ω–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å)
4. –î–æ–±–∞–≤–∏—Ç—å action –≤ Controller –∏–ª–∏ `admin_api.php` ‚Üí –≤—ã–∑–æ–≤ Service
5. `php -l` –Ω–∞ –∏–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

### 12.2. –ö–∞–∫ –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é —Ç–∞–±–ª–∏—Ü—É

1. –î–æ–±–∞–≤–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –≤ `infrastructure/install/`
2. –°–æ–∑–¥–∞—Ç—å Repository –≤ `domain/{Context}/` —Å CRUD-–º–µ—Ç–æ–¥–∞–º–∏
3. –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –≤ `autoload.php`

### 12.3. –ö–∞–∫ –ù–ï —Å–ª–æ–º–∞—Ç—å streaming

- **–ù–∏–∫–æ–≥–¥–∞** –Ω–µ –º–µ–Ω—è—Ç—å `www/stream/*.php` –±–µ–∑ —è–≤–Ω–æ–≥–æ —Ä–µ–≤—å—é
- **–ù–∏–∫–æ–≥–¥–∞** –Ω–µ –¥–æ–±–∞–≤–ª—è—Ç—å `require` —Ç—è–∂—ë–ª—ã—Ö –∫–ª–∞—Å—Å–æ–≤ –≤ streaming bootstrap
- –ù–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å EventDispatcher / Router / ServiceContainer –≤ hot path
- –ü—Ä–æ–≤–µ—Ä—è—Ç—å latency: `< 50ms p99`

### 12.4. –ü—Ä–∞–≤–∏–ª–∞ PR

1. –û–¥–∏–Ω PR = –æ–¥–Ω–∞ —Ñ–∏—á–∞/–±–∞–≥—Ñ–∏–∫—Å. –ù–µ —Å–º–µ—à–∏–≤–∞—Ç—å —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ —Å —Ñ–∏—á–∞–º–∏.
2. `php -l` –Ω–∞ –≤—Å–µ –∏–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –ø–µ—Ä–µ–¥ –ø—É—à–µ–º.
3. –ï—Å–ª–∏ —Ç—Ä–æ–≥–∞–µ—Ç–µ `core/` –∏–ª–∏ `streaming/` ‚Äî –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π —Ä–µ–≤—å—é.
4. proxy-–º–µ—Ç–æ–¥—ã –ø–æ–º–µ—á–∞—Ç—å `// @legacy-proxy ‚Äî —É–±—Ä–∞—Ç—å –≤ –§–∞–∑–µ 8`.
5. –ù–æ–≤—ã–µ –∫–ª–∞—Å—Å—ã —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –≤ `autoload.php`.

### 12.5. –ü—Ä–æ—Å—Ç—ã–µ –ø—Ä–∞–≤–∏–ª–∞ (cheat sheet)

```
‚úó  –ù–µ –ø–∏—à–∏ SQL –≤ Controller          ‚Üí  –ü–∏—à–∏ –≤ Repository
‚úó  –ù–µ –ø–∏—à–∏ –ª–æ–≥–∏–∫—É –≤ Controller       ‚Üí  –ü–∏—à–∏ –≤ Service
‚úó  –ù–µ –¥–æ–±–∞–≤–ª—è–π global               ‚Üí  –ò—Å–ø–æ–ª—å–∑—É–π constructor injection
‚úó  –ù–µ —Ç—Ä–æ–≥–∞–π streaming –±–µ–∑ —Ä–µ–≤—å—é   ‚Üí  hot path = —Å–≤—è—â–µ–Ω–Ω–∞—è —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏—è
‚úó  –ù–µ –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä—É–π core/ –∏–∑ –º–æ–¥—É–ª–µ–π  ‚Üí  –ú–æ–¥—É–ª—å –≤—ã–∑—ã–≤–∞–µ—Ç, –Ω–µ –º–µ–Ω—è–µ—Ç
```

---

## –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ: –û–¥–∏–Ω bootstrap –≤–º–µ—Å—Ç–æ —Ç—Ä—ë—Ö

`bootstrap.php` –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –∫–ª–∞—Å—Å `XC_Bootstrap` —Å —á–µ—Ç—ã—Ä—å–º—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞–º–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:

| –ö–æ–Ω—Ç–µ–∫—Å—Ç | –ß—Ç–æ –∑–∞–≥—Ä—É–∂–∞–µ—Ç | –î–ª—è —á–µ–≥–æ |
|----------|--------------|----------|
| `CONTEXT_MINIMAL` | autoload + constants + Logger | –°–∫—Ä–∏–ø—Ç—ã, –∫–æ—Ç–æ—Ä—ã–º –Ω—É–∂–Ω—ã —Ç–æ–ª—å–∫–æ –ø—É—Ç–∏ |
| `CONTEXT_CLI` | + Database + CoreUtilities | Cron-–∑–∞–¥–∞—á–∏, CLI-—Å–∫—Ä–∏–ø—Ç—ã |
| `CONTEXT_STREAM` | + Database + StreamingUtilities (–∫—ç—à) | –°—Ç—Ä–∏–º–∏–Ω–≥-—ç–Ω–¥–ø–æ–∏–Ω—Ç—ã (hot path) |
| `CONTEXT_ADMIN` | + Database + CoreUtilities + API + ResellerAPI + Translator + session + Redis | –ê–¥–º–∏–Ω/—Ä–µsel–ª–µ—Ä-–ø–∞–Ω–µ–ª—å |

```php
// interfaces/Http/public/index.php ‚Äî admin/reseller entry point
require_once '/home/xc_vm/bootstrap.php';
XC_Bootstrap::defineStatusConstants();
XC_Bootstrap::boot(XC_Bootstrap::CONTEXT_ADMIN);
// $db, CoreUtilities, API, ResellerAPI, Translator ‚Äî –≤—Å—ë –≥–æ—Ç–æ–≤–æ
```

```php
// interfaces/Http/public/stream.php ‚Äî streaming entry point (lightweight)
require_once '/home/xc_vm/bootstrap.php';
XC_Bootstrap::boot(XC_Bootstrap::CONTEXT_STREAM);
// –¢–æ–ª—å–∫–æ Database + StreamingUtilities, –±–µ–∑ admin_api, –±–µ–∑ Translator
```

```php
// interfaces/Cli/CronJobs/StreamsCron.php ‚Äî cron
require_once '/home/xc_vm/bootstrap.php';
XC_Bootstrap::boot(XC_Bootstrap::CONTEXT_CLI, [
    'cached'  => true,
    'redis'   => true,
    'process' => 'XC_VM[Streams]'
]);
// Database + CoreUtilities + Redis, –±–µ–∑ session –∏ admin API
```

–û–¥–∏–Ω –∞–≤—Ç–æ–∑–∞–≥—Ä—É–∑—á–∏–∫. –û–¥–∏–Ω –Ω–∞–±–æ—Ä –∫–æ–Ω—Å—Ç–∞–Ω—Ç. –ö–∞–∂–¥–∞—è —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –≤—ã–∑—ã–≤–∞–µ—Ç `boot()` —Å –Ω—É–∂–Ω—ã–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º.
–ù–æ–≤—ã–µ –∫–ª–∞—Å—Å—ã –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–∞—Ö–æ–¥—è—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ `XC_Autoloader` ‚Äî –±–µ–∑ —Ä—É—á–Ω–æ–≥–æ `require_once`.
